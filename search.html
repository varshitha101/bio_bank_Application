<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bio Bank</title>
  <!-- Google Fonts and Icons -->
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone"
    rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />

  <style>
    .radio-btn {
      text-decoration: none;
      padding: 10px 20px;
      border: 2px solid #ccc;
      border-radius: 5px;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .radio-btn.active {
      background-color: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .radio-btn:hover {
      background-color: #0056b3;
      color: #fff;
    }
  </style>

  <script src="index.js"></script>
</head>

<body>
  <nav class="navbar sticky-top navbar-expand-lg navbar-light" style="background-color: #1991c994">
    <div class="container-fluid">
      <div class="mx-auto">
        <ul class="nav nav-pills nav-fill">
          <li class="nav-item">
            <a class="nav-link" href="statistics.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="home.html">Sample</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">Search</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="todo.html">To-Do list</a>
          </li>
        </ul>
      </div>
      <div id="loading" class="spinmodal" style="display: none;">
        <!-- Initially hidden -->
        <div class="spinmodal-content">
          <div class="row">
            <div class="col-4">
              <div class="spinner"></div> <!-- Spinner circle -->
            </div>
            <div class="col-8">
              <h3 style="align-content: center; padding-top: 20px;">Loading...</h3>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex ms-auto">
        <button onclick="logout()" type="submit" class="btn btn-outline-light">
          Logout
        </button>
      </div>
    </div>
  </nav>
  <div class="wrapper">
    <div class="container" style="margin-top: 20px">
      <div class="row" style="justify-content: space-around; margin-bottom: 10px">
        <div>
          <a href="#collapseExample" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false"
            aria-controls="collapseExample" id="individualSearchBtn">
            Individual Search
          </a>
        </div>
        <div>
          <a href="#collapseExample1" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false"
            aria-controls="collapseExample1" id="sampleSearchBtn">
            Sample Search
          </a>
        </div>
      </div>
      <div class="collapse" id="collapseExample">
        <div class="card card-body">
          <form id="individualSearchForm" onsubmit="return searchPatient(event);">
            <div class="row" style="justify-content: center">
              <div class="form-group col-md-2">
                <label for="bioInput">Patient Biobank ID</label>
                <input type="text" class="form-control" id="bioInput" placeholder="Enter Biobank ID" />
              </div>
              <div class="form-group col-md-1">
                <label for="searchBtn">Search</label>
                <button type="submit" class="btn btn-primary">Submit</button>
              </div>
            </div>
          </form>
        </div>
        <div class="container mt-2">
          <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              ">
            <p style="margin: 0; font-weight: bold">
              Show<span>
                <select id="entriesInput1" class="btn"
                  style="margin-left: 5px;width: 50px;border: rgb(177, 211, 243) solid 0.18rem;padding: 2px;">
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </span>
              entries
            </p>
            <div>
              <div class="row" style="justify-content: center">
                <button type="button" id="download1" class="btn btn-success mr-2" style="display: none">
                  Download
                </button>
                <!-- <button type="submit" class="btn btn-primary" onclick="sharedFunc()">Share</button> -->
              </div>
            </div>
          </div>
        </div>

        <div class="container my-1">
          <div id="patientList" class="row">
            <table id="patientTable" class="table table-striped table-bordered">
              <thead style="position: sticky">
                <tr>
                  <!-- <th scope="col"><input type='checkbox' id="selectAll" class="btn btn-primary btn-sm"></th> -->
                  <th class="head-text" scope="col">S.No</th>
                  <th class="head-text" scope="col">Bio Bank ID</th>
                  <th class="head-text" scope="col">Age</th>
                  <th class="head-text" scope="col">Gender</th>
                  <th class="head-text" scope="col">Cancer Type</th>
                  <!-- <th scope="col">Stage of Cancer</th>-->
                  <th class="head-text" scope="col">Grade </th>
                  <th class="head-text" scope="col">Action</th>
                </tr>
              </thead>
              <tbody class="patientTableBody" style="scroll-behavior: smooth">
                <tr class="patientRow">
                  <td></td>
                  <th scope="row" class="sno"></th>
                  <td class="patientName"></td>
                  <td class="age"></td>
                  <td class="gender"></td>
                  <td class="cancerType"></td>
                  <!--<td class="stage"></td>-->
                  <td class="grade"></td>
                  <td class="action"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <nav aria-label="Page navigation example">
          <ul class="pagination indPagination justify-content-center">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
              <a class="page-link" href="#">Next</a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="collapse" id="collapseExample1">
        <div class="card card-body">
          <form id="sampleSearchForm" onsubmit="return searchSample(event);">
            <div class="row" style="justify-content: space-evenly">
              <div class="form-group col-xs-1 mr-2">
                <label for="ageCriterion">Age Criterion</label>
                <select id="ageCriterion" class="form-control">

                  <option selected>Greater than</option>
                  <option>Less than</option>
                  <option>Equal to</option>
                </select>
              </div>

              <div class="form-group col-sm-1">
                <label for="ageInput">Age</label>
                <input type="text" id="ageInput" class="form-control" placeholder="yrs" value="15" />
              </div>

              <div class="form-group col-xs-2 mr-2">
                <label for="cancerTypeInput">Cancer Type</label>
                <select id="cancerTypeInput" class="form-control">

                  <option selected>All</option>
                  <option value="brst">Breast Cancer</option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="sampleType">Sample</label>
                <select id="sampleType" class="form-control">

                  <option selected>All</option>
                  <!-- <option value="Blood">Blood</option> -->
                  <option value="Plasma">Plasma</option>
                  <!-- <option value="MPlasma">MPlasma</option> -->
                  <option value="Serum">Serum</option>
                  <!-- <option value="MSerum">MSerum</option> -->
                  <option value="Buffy Coat">Buffy Coat</option>
                  <!-- <option value="MBuffy Coat">MBuffy Coat</option> -->
                  <!-- <option value="Specimen">Specimen</option> -->
                  <option value="FN">FN</option>
                  <!-- <option value="MFN">MFN</option> -->
                  <option value="FT">FT</option>
                  <!-- <option value="MFT">MFT</option> -->
                  <option value="Other">Other</option>
                  <!-- <option value="MOther">MOther</option> -->
                  <option value="RLT">RLT</option>
                  <option value="PC">Primary Culture</option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="metaInput">Metastasis</label>
                <select id="metaInput" class="form-control">

                  <option selected>All</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="nactInput">NACT</label>
                <select id="nactInput" class="form-control">

                  <option selected>All</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="sampleavailable">Status</label>
                <select id="sampleavailable" class="form-control">

                  <option selected>All</option>
                  <option value="Shared">Shared</option>
                  <option value="Available">Available</option>
                </select>
              </div>
              
              
             
              
              <div class="form-group col-xs-2 mr-2">
                <label for="pathSubtype">Pathologic Subtype</label>
                <select id="pathSubtype" class="form-control">

                  <option selected>All</option>
                  <option value="option1">
                    No residual invasive carcinoma
                  </option>
                  <option value="option2">
                    Invasive carcinoma of no special type (ductal)
                  </option>
                  <option value="option3">Micro-invasive carcinoma</option>
                  <option value="option4">Invasive lobular carcinoma</option>
                  <option value="option5">
                    Invasive carcinoma with mixed ductal and lobular features
                  </option>
                  <option value="option6">
                    Invasive carcinoma with features of (specify)
                  </option>
                  <option value="option7">Tubular carcinoma</option>
                  <option value="option8">
                    Invasive cribriform carcinoma
                  </option>
                  <option value="option9">Mucinous carcinoma</option>
                  <option value="option10">
                    Invasive micropapillary carcinoma
                  </option>
                  <option value="option11">Apocrine adenocarcinoma</option>
                  <option value="option12">Metaplastic carcinoma</option>
                  <option value="option13">
                    Encapsulated papillary carcinoma with invasion
                  </option>
                  <option value="option14">
                    Solid papillary carcinoma with invasion
                  </option>
                  <option value="option15">
                    Intraductal papillary adenocarcinoma with invasion
                  </option>
                  <option value="option11">Adenoid cystic carcinoma</option>
                  <option value="option12">Neuroendocrine tumor</option>
                  <option value="option13">Neuroendocrine carcinoma</option>
                  <option value="option12">
                    Invasive carcinoma, type cannot be determined:
                  </option>
                  <option value="other">
                    Other histologic type not listed (specify)
                  </option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="gradeInput">Grade</label>
                <select id="gradeInput" class="form-control">

                  <option selected>All</option>
                  <option value="grade1">Grade 1</option>
                  <option value="grade2">Grade 2</option>
                  <option value="grade3">Grade 3</option>
                  <option value="Only microinvasion present">Only microinvasion present</option>

                </select>
              </div>
              
              
              <div class="form-group col-xs-2 mr-2">
                <label for="AJCCInput">AJCC Staging</label>
                <select id="AJCCInput" class="form-control">
                  <option selected>All</option>
                  <option value="I">I</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                </select>
              </div>
              <div class="form-group col-xs-2 mr-2">
                <label for="cSubInput">Clinical Subtype</label>
                <select id="cSubInput" class="form-control">
                  <option selected>All</option>
                  <option value="HR positive">HR positive</option>
                  <option value="Her2 enriched">Her2 enriched</option>
                  <option value="Triple positive">Triple positive</option>
                  <option value="TNBC">TNBC</option>
                  
                </select>
              </div>
              
            </div>
            <div class="row mb-1" style="justify-content: space-around">
              <button type="submit" class="btn btn-primary" id="sampleSubmit">
                Submit
              </button>
            </div>
          </form>
        </div>
        <div class="container mt-2">
          <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              ">
            <p style="margin: 0; font-weight: bold">
              Show<span>
                <select id="entriesInput2" class="btn" style="
                      margin-left: 5px;
                      width: 50px;
                      border: rgb(177, 211, 243) solid 0.18rem;
                      padding: 2px;
                    ">
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </span>
              entries
            </p>
            <div>
              <div class="row" id="naviButtons" style="justify-content: center; display: none; ">
                <!-- <button type="button" id="download2" class="btn btn-success mr-2">
                  Download
                </button> -->
                <!-- <img src="assets/images/download.svg" id="download3" alt="Edit" width="45" height="45" style="vertical-align: middle; margin-right: 5px; cursor: pointer;" title="Download All"> -->

                <img src="assets/images/download.svg" id="download2" alt="Edit" width="45" height="45"
                  style="vertical-align: middle; cursor: pointer;" title="Download">
                <div class="position-relative" style="display: inline-block;">
                  <img src="assets/images/download-all.svg" id="download3" alt="Edit" width="45" height="45"
                    style="vertical-align: middle;  margin-right:10px; cursor: pointer;" title="Download All">
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="allDownload"
                    style="font-size: 0.75rem;  margin-left: -30px;">
                  </span>
                </div>
                <!-- <button type="submit" class="btn btn-primary" onclick="sharedFunc()">
                  Share
                </button> -->
                <img src="assets/images/share2.svg" alt="Share" width="38" height="38"
                style="vertical-align: middle; cursor: pointer;" onclick="sharedFunc()" title="Share">

              </div>
            </div>
          </div>
        </div>

        <div class="container my-1">
          <div id="patientList" class="row">
            <table id="patientTable" class="table table-striped table-bordered">
              <thead style="position: sticky">
                <tr>
                  <th scope="col">
                    <input type="checkbox" id="selectAll" class="btn btn-primary btn-sm" />
                  </th>
                  <th class="head-text" scope="col">S.No</th>
                  <th class="head-text" scope="col">Bio Bank ID</th>
                  <th class="head-text" scope="col">Age</th>
                  <th class="head-text" scope="col">Gender</th>
                  <th class="head-text" scope="col">Time</th>
                  <th class="head-text" scope="col">Box</th>
                  <th class="head-text" scope="col">Grid</th>
                  <th class="head-text" scope="col">Sample Type</th>
                  <th class="head-text" scope="col">Cancer Type</th>
                  <!--  <th scope="col">Stage of Cancer</th> -->
                  <th class="head-text" scope="col">Grade</th>
                  <th class="head-text" scope="col">Action</th>
                </tr>
              </thead>
              <tbody class="patientTableBody1" style="scroll-behavior: smooth">
                <tr class="patientRow">
                  <td></td>
                  <th scope="row" class="sno"></th>
                  <td class="patientName"></td>
                  <td class="age"></td>
                  <td class="gender"></td>
                  <td class="latestTimestamp"></td>
                  <td class="box"></td>
                  <td class="grid"></td>
                  <td class="sampleTypes"></td>
                  <td class="cancerType"></td>
                  <!-- <td class="stage"></td> -->
                  <td class="grade"></td>
                  <td class="action"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <nav aria-label="Page navigation example">
          <ul class="pagination samPagination justify-content-center">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
              <a class="page-link" href="#">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- Change the Show Entries Section -->
  </div>
  <div id="mainContent">
    <div class="modal fade bd-example-modal-lg" id="exampleModalCenter" tabindex="-1" role="dialog"
      aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">
              Patient History
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table style="width: 100%; border-collapse: collapse; margin: 10px 0">
              <thead>
                <tr>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    S.No
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Bio Bank ID
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Age
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Gender
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Procedure
                  </th>

                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Type of Cancer
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Grade
                  </th>
                  <th style="
                        border: 1px solid #ddd;
                        text-align: center;
                        background-color: #f2f2f2;
                      ">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">
            Patient History
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0">
            <thead>
              <tr>
                <th style="
                      border: 1px solid #ddd;
                      padding: 8px;
                      text-align: left;
                      background-color: #f2f2f2;
                    ">
                  S.No
                </th>
                <th style="
                      border: 1px solid #ddd;
                      padding: 8px;
                      text-align: left;
                      background-color: #f2f2f2;
                    ">
                  Date
                </th>
                <th style="
                      border: 1px solid #ddd;
                      padding: 8px;
                      text-align: left;
                      background-color: #f2f2f2;
                    ">
                  Time
                </th>
                <th style="
                      border: 1px solid #ddd;
                      padding: 8px;
                      text-align: left;
                      background-color: #f2f2f2;
                    ">
                  Action
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- Dynamic rows will be appended here by the JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer">
    <div class="container footer-bottom clearfix">
      <div class="copyright">
        &copy; Copyright <strong><span></span></strong>. All Rights Reserved
      </div>
      <div class="credits"></div>
      <div class="version" style="float: right; font-size: 12px; color: rgb(255, 255, 255)">
        Version 1.5.3
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>

    if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = "login.html";
    }
    // Firebase configuration
    // const firebaseConfig = {
    //   apiKey: "AIzaSyDIFI_4lVb7FJmKgzWMbq6ZfKcBwpj-K4E",
    //   authDomain: "biobank-development.firebaseapp.com",
    //   databaseURL: "https://biobank-development-default-rtdb.firebaseio.com",
    //   projectId: "biobank-development",
    //   storageBucket: "biobank-development.firebasestorage.app",
    //   messagingSenderId: "31278898937",
    //   appId: "1:31278898937:web:01f96df7a640d9c1410c28",
    //   measurementId: "G-B98TGR5Q8Q"
    // };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    document.getElementById('sampleSubmit').addEventListener('click', function () {
      const naviButtons = document.getElementById('naviButtons');
      naviButtons.style.display = 'block'

    });
    let allDataDown = [];

    function historyModal() {
      $("#exampleModalCenter").modal("show");
    }
    function logout() {
      sessionStorage.removeItem("isLoggedIn");
      sessionStorage.removeItem("userName");
      window.location.href = "login.html";
    }
    function handleView() {
      window.location.href = "default.html";
    }
    // let filteredPatientData = [];

    function handleHistory(bioBankId, seq) {
      const patientSeq = window.patientData[bioBankId];
      const patientTimestamps = patientSeq[seq];

      if (!patientTimestamps) {
        console.error(
          `No timestamps found for BioBank ID: ${bioBankId} and sequence: ${seq}`
        );
        return;
      }

      const timestampKeys = Object.keys(patientTimestamps);
      const modalBody = document.querySelector(
        "#exampleModal .modal-body tbody"
      );
      modalBody.innerHTML = "";

      timestampKeys.forEach((timestampKey, index) => {
        const timestampData = patientTimestamps[timestampKey];

        console.log("timestampData", timestampKey);

        const dateObj = new Date(Number(timestampKey) * 1000);
        console.log("dateObj", dateObj);
        const dateStr = dateObj.toLocaleDateString();
        const timeStr = dateObj.toLocaleTimeString();

        // Create a new row for each timestamp
        const row = document.createElement("tr");
        row.innerHTML = `
        <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${index + 1
          }</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${dateStr}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${timeStr}</td>
        <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">
          <button class="btn btn-info btn-sm" onclick="viewPatient('${bioBankId}', '${seq}', '${timestampKey}')">View</button>
        </td>
      `;
        modalBody.appendChild(row);
      });
      $("#exampleModal").modal("show");

      // Apply blur effect to the main content (background) only
      document.getElementById("mainContent").style.filter = "blur(10px)";

      // Remove blur effect when modal is closed
      $("#exampleModal").on("hidden.bs.modal", function () {
        document.getElementById("mainContent").style.filter = "none";
      });
      // Open the modal
    }

    let currentPage = 1;
    let indRowsPerPage = 10;
    let samRowsPerPage = 10;
    let filteredSefData = {};
    document.getElementById("entriesInput1").addEventListener("change", function () {
      indRowsPerPage = parseInt(this.value) || 10;
      console.log("Rows per page for Ind updated to:", indRowsPerPage);
      currentPage = 1;
      displayIndSefEntries(filteredSefData);
    });

    document.getElementById("entriesInput2").addEventListener("change", function () {
      samRowsPerPage = parseInt(this.value) || 10;
      console.log("Rows per page for sam updated to:", samRowsPerPage);
      currentPage = 1;
      displaySamPatients(filteredPatientData);
    });

    function updateIndPagination(totalRows) {
      const totalPages = Math.ceil(totalRows / indRowsPerPage);
      const pagination = document.querySelector('.indPagination');
      pagination.innerHTML = '';

      const maxVisiblePages = 5; // Adjust this to control how many pages are shown at once
      let startPage, endPage;

      // Determine the range of visible pages
      if (totalPages <= maxVisiblePages) {
        startPage = 1;
        endPage = totalPages;
      } else {
        if (currentPage <= 3) {
          startPage = 1;
          endPage = maxVisiblePages;
        } else if (currentPage + 2 >= totalPages) {
          startPage = totalPages - maxVisiblePages + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - 2;
          endPage = currentPage + 2;
        }
      }

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="IndchangePage(${currentPage - 1})">Previous</a>`;
      pagination.appendChild(prevLi);

      // First page and ellipsis if necessary
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="IndchangePage(1)">1</a>`;
        pagination.appendChild(firstLi);

        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(ellipsisLi);
      }

      // Page number buttons
      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="IndchangePage(${i})">${i}</a>`;
        pagination.appendChild(li);
      }

      // Last page and ellipsis if necessary
      if (endPage < totalPages) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(ellipsisLi);

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="IndchangePage(${totalPages})">${totalPages}</a>`;
        pagination.appendChild(lastLi);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="IndchangePage(${currentPage + 1})">Next</a>`;
      pagination.appendChild(nextLi);
    }


    function IndchangePage(page) {
      currentPage = page;
      displayIndSefEntries(filteredSefData);
    }

    function updateSamPagination(totalRows) {
      const totalPages = Math.ceil(totalRows / samRowsPerPage);
      const pagination = document.querySelector('.samPagination');
      pagination.innerHTML = '';

      const maxVisiblePages = 5;
      let startPage, endPage;

      if (totalPages <= maxVisiblePages) {
        startPage = 1;
        endPage = totalPages;
      } else {
        if (currentPage <= 3) {
          startPage = 1;
          endPage = maxVisiblePages;
        } else if (currentPage + 2 >= totalPages) {
          startPage = totalPages - maxVisiblePages + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - 2;
          endPage = currentPage + 2;
        }
      }

      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="samChangePage(${currentPage - 1})">Previous</a>`;
      pagination.appendChild(prevLi);

      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="samChangePage(1)">1</a>`;
        pagination.appendChild(firstLi);

        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(ellipsisLi);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="samChangePage(${i})">${i}</a>`;
        pagination.appendChild(li);
      }

      if (endPage < totalPages) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
        pagination.appendChild(ellipsisLi);

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="samChangePage(${totalPages})">${totalPages}</a>`;
        pagination.appendChild(lastLi);
      }

      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="samChangePage(${currentPage + 1})">Next</a>`;
      pagination.appendChild(nextLi);
    }

    function samChangePage(page) {
      currentPage = page;
      displaySamPatients(filteredPatientData);
    }


    let filteredPatientData = [];

    function searchPatient(event) {

      event.preventDefault();
      fetchBnData();
      searchLoadingModal();

      const bioID = document.getElementById("bioInput").value.trim().toLowerCase();

      const filteredSefEntries = {};
      Object.keys(window.sefData).forEach((bioBankId) => {
        if (bioBankId.toLowerCase().includes(bioID)) {
          filteredSefEntries[bioBankId] = window.sefData[bioBankId];
        }
      });

      console.log("filteredSefEntries", filteredSefEntries);
      filteredSefData = filteredSefEntries;

      currentPage = 1;
      displayIndSefEntries(filteredSefEntries, bioID);
    }



    document.addEventListener("DOMContentLoaded", function () {
      var checkbox = document.querySelector("input[name=checkbox]");

      if (checkbox) {
        checkbox.addEventListener('change', function () {
          if (this.checked) {
            console.log("Checkbox is checked..");
          } else {
            console.log("Checkbox is not checked..");
          }
        });
      }
    });


    document.addEventListener("DOMContentLoaded", function () {
      db.ref("sef")
        .once("value")
        .then((snapshot) => {
          const data = snapshot.val();

          if (data) {
            window.sefData = data;
            filteredSefData = data;

            displayIndSefEntries(data);
          } else {
            console.log("No SEF data found");
          }
        })
        .catch((error) => {
          console.error("Error fetching the data from Firebase:", error);
        });
    });

    // function displayIndSefEntries(data, bioId) {
    //   console.log("displayIndSefEntries - ", data);
    //   filteredSefEntries = data;
    //   const tbody = document.querySelector(".patientTableBody");
    //   tbody.innerHTML = "";
    //   let bnLocalS = [];

    //   db.ref('bn/').once('value')
    //     .then((snapshot) => {
    //       if (snapshot.exists()) {
    //         const boxIDs = snapshot.val();
    //         console.log("Bio Box Names in the BN node", boxIDs);

    //         let bnLocalS = [];

    //         for (const [key, value] of Object.entries(boxIDs)) {
    //           bnLocalS.push({ id: key, name: value });
    //         }
    //         // bnLocalS = boxIDs;
    //         localStorage.setItem('bnData', JSON.stringify(bnLocalS));

    //         console.log("Data stored in bnLocalS:", bnLocalS);
    //         console.log("Data stored in local storage.");
    //       }
    //     })
    //     .catch((error) => {
    //       console.error('Error fetching data:', error);
    //     });


    //   const start = (currentPage - 1) * rowsPerPage;
    //   const end = start + rowsPerPage;

    //   const bioBankIds = Object.keys(data);
    //   const paginatedBioBankIds = bioBankIds.slice(start, end);

    //   paginatedBioBankIds.forEach((bioBankId, index) => {
    //     const patientSeq = data[bioBankId];

    //     const seqKeys = Object.keys(patientSeq);
    //     const lastSeqKey = seqKeys[seqKeys.length - 1];
    //     const patientTimestamps = patientSeq[lastSeqKey];

    //     const timestampKeys = Object.keys(patientTimestamps);
    //     const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
    //     const patient = patientTimestamps[lastTimestampKey];

    //     // console.log("BioBank ID:", bioBankId);

    //     const row = document.createElement("tr");
    //     row.classList.add("patientRow");
    //     row.innerHTML = `
    //     <th scope="row" class="sno">${start + index + 1}</th>
    //     <td class="bioid">${bioBankId}</td>
    //     <td class="age">${patient.ie.ag || "-"}</td>
    //     <td class="gender">${patient.ie.sx || "-"}</td>
    //     <td class="cancerType">${patient.ie.ct === 'brst' ? "Breast Cancer" : "-"}</td>

    //     <td class="grade">${patient.md.gd || "-"}</td>

    //     <td class="action">

    //       <button class="btn btn-success btn-sm" onclick="showHistory('${bioBankId}')">View Samples</button>
    //     </td>
    //   `;
    //     tbody.appendChild(row);
    //   });
    //   hideLoadingModal()
    //   updateIndPagination(bioBankIds.length);
    // }


    function displayIndSefEntries(data, bioId) {
      console.log("displayIndSefEntries - ", data);
      filteredSefEntries = data; // Keep filteredSefEntries updated
      const tbody = document.querySelector(".patientTableBody");
      tbody.innerHTML = "";

      // Fetch data from the 'bn' node
      db.ref('bn/').once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const boxIDs = snapshot.val();
            console.log("Bio Box Names in the BN node", boxIDs);

            let bnLocalS = [];
            for (const [key, value] of Object.entries(boxIDs)) {
              bnLocalS.push({ id: key, name: value });
            }

            localStorage.setItem('bnData', JSON.stringify(bnLocalS));
            console.log("Data stored in bnLocalS:", bnLocalS);
            console.log("Data stored in local storage.");
          }
        })
        .catch((error) => {
          console.error('Error fetching data:', error);
        });

      const start = (currentPage - 1) * indRowsPerPage;
      const end = start + indRowsPerPage;

      const bioBankIds = Object.keys(data);
      let indSeqData = [];
      let promises = [];

      Object.entries(data).forEach(([bioBankId, patientSeq]) => {
        const seqKeys = Object.keys(patientSeq);
        const lastSeqKey = seqKeys[seqKeys.length - 1];
        const patientTimestamps = patientSeq[lastSeqKey];
        const timestampKeys = Object.keys(patientTimestamps);
        const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
        const patient = patientTimestamps[lastTimestampKey];

        if (!patient || !patient.ie || !patient.md) return;

        // Collect patient data
        const promise1 = indSeqData.push({
          serialNumber: indSeqData.length + 1,
          bioBankId,
          seqKey: lastSeqKey,
          age: patient.ie.ag || "-",
          gender: patient.ie.sx || "-",
          grade: patient.md.gd || "-",
          cancerType: patient.ie.ct === 'brst' ? "Breast Cancer" : "-",
          patientData: patient,
        });
        promises.push(promise1);
      });

      // Once all promises are resolved, paginate the results
      Promise.all(promises).then(() => {
        const paginatedBioBankIds = indSeqData.slice(start, end);

        paginatedBioBankIds.forEach((indSeqData) => {
          const {
            serialNumber,
            bioBankId,
            age,
            gender,
            grade,
            cancerType
          } = indSeqData;

          const row = document.createElement("tr");
          row.classList.add("patientRow");
          row.innerHTML = `
        <th scope="row" class="sno small-text">${serialNumber}</th>
        <td class="bioid small-text">${bioBankId}</td>
        <td class="age small-text">${age}</td>
        <td class="gender small-text">${gender}</td>
        <td class="cancerType small-text">${cancerType}</td>
        <td class="grade small-text">${grade}</td>
        <td class="action small-text">
          <button class="btn btn-success btn-sm" onclick="showHistory('${bioBankId}')">View Samples</button>
        </td>
      `;
          tbody.appendChild(row);
        });

        hideLoadingModal();
        updateIndPagination(bioBankIds.length); // Update pagination based on filtered data length
      });
    }

    function sharedFunc() {
      const checkedBoxes = document.querySelectorAll(".selection:checked");

      const selectedPatients = [];

      console.log("checked boxes print -- ", checkedBoxes);

      if (checkedBoxes.length === 0) {
        console.log(" No sample is selected ---- ");
        alert("Please select a sample to Share");
        return
      }

      checkedBoxes.forEach((checkbox) => {

        const row = checkbox.closest("tr");

        const bioBankId = row.getAttribute("data-bioBankId");
        const seqKey = row.getAttribute("data-seqKey");
        const timestampKey = row.getAttribute("data-timestampKey");
        const gridData = row.getAttribute("data-grid");
        const boxName = row.getAttribute("data-box");

        selectedPatients.push({
          bioBankId: bioBankId,
          seqKey: seqKey,
          timestampKey: timestampKey,
          gridData: gridData,
          boxName: boxName,
        });
      });
      const mode = "share";
      shareData(mode, selectedPatients);
      console.log("Selected patients for sharing:", selectedPatients);
    }

    function editPatient(bioBankId, seq, timestampKey) {
      let editS = "SearchEdit";
      console.log("timestampKey", timestampKey);
      let user = sessionStorage.getItem('userName');
      console.log("User Name", user);
      let act = {
        "mode": "e",
        "user": user
      };

      let refPath = `act/${bioBankId}/${seq}`;

      db.ref(refPath).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            let data = snapshot.val();

            if (data.mode === "e") {

              alert(`This form is being edited by ${data.user}. Please try after sometime...`);
            }
            else {
              db.ref(refPath).set(act)
                .then(() => {
                  console.log("New act set, proceeding with pages_display.");
                  pages_display(editS, bioBankId, seq, timestampKey);
                })
                .catch((error) => {
                  console.error("Error setting new act: ", error);
                });
            }
          }
          else {
            db.ref(refPath).set(act)
              .then(() => {
                console.log("Path not found, new act set. Proceeding with pages_display.");
                pages_display(editS, bioBankId, seq, timestampKey);
              })
              .catch((error) => {
                console.error("Error setting new act: ", error);
              });
          }
        })
        .catch((error) => {
          console.error("Error checking path in Firebase: ", error);
        });
    }


    function viewPatient(bioBankId, seq, timestampKey) {
      const patientSeq = window.patientData[bioBankId];
      const timestampData = patientSeq[seq][timestampKey]; // Get the timestamp data
      let viewS = "SearchView";
      console.log("timestampKey", timestampKey);
      pages_display(viewS, bioBankId, seq, timestampKey);

      // window.location.href = `default.html?hideMnrId=true`;
    }

    function showHistory(bioBankId) {

      const patientSeq = window.patientData[bioBankId]; // Assuming you are using filtered data
      console.log("Filtered Patient Data:", window.patientData);

      if (!patientSeq) {
        console.error(`No data found for BioBank ID: ${bioBankId}`);
        return;
      }

      // Get the modal body table
      const tbody = document.querySelector(
        "#exampleModalCenter .modal-body tbody"
      );
      tbody.innerHTML = ""; // Clear the existing content

      const seqKeys = Object.keys(patientSeq);

      // Loop through each sequence and populate the table rows
      seqKeys.forEach((seq, index) => {
        const patientTimestamps = patientSeq[seq];
        const timestampKeys = Object.keys(patientTimestamps);
        const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
        const patientData = patientTimestamps[lastTimestampKey];
        const patient = patientData.ie || {};
        const fields = ["bpg", "bsg", "bbcg", "ftg", "fng", "osg", "rlt", "pc"];

        let boxid = "";
        let seatList = [];

        // Iterate through the fields to find the first available box and seat info
        fields.forEach((field) => {
          const fieldData = patient[field];
          if (fieldData) {
            const parts = fieldData.split("/"); // Assuming the box name and seat list are separated by "/"

            boxid = parts[0].trim();

            seatList = parts[1] ? parts[1].split(",") : []; // Split the seats into an array
          }
          console.log("seatList", fieldData);
        });
        const storedBnData = JSON.parse(localStorage.getItem('bnData'));
        console.log('Retrieved bnData from local storage:', storedBnData);

        const boxEntry = storedBnData.find(entry => entry.id === boxid);

        if (boxEntry) {
          boxName = boxEntry.name;
        }
        let metas = "";
        if(patient.mspt){
          if(patient.mspt === 'Bx'){
            metas = "Biopsy"
          }
          if(patient.mspt === 'Sx'){
            metas = "Resection"
          }if(patient.mspt === 'MBx'){
            metas = "Metastasis Biopsy"
          }if(patient.mspt === 'MSx'){
            metas = "Metastasis Resection"
          }
        }

        const seatListDisplay = seatList.length ? seatList.join(", ") : "-";

        // Create a table row for each sequence
        const row = document.createElement("tr");
        row.innerHTML = `
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${index + 1
          }</td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${bioBankId}</td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.ag || "-"
          }</td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.sx || "-"
          }</td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${metas || "-"
          }</td> <!-- Display box name -->
      
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.ct === 'brst' ? "Breast Cancer" : "-"
          }</td>
     
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patientData.md?.gd || "-"
          }</td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">
        <button class="btn btn-primary btn-sm" onclick="editPatient('${bioBankId}', '${seq}', '${lastTimestampKey}')"><img src="assets/images/edit.svg" alt="Edit" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"> </button>
        <button class="btn btn-info btn-sm" onclick="viewPatient('${bioBankId}', '${seq}', '${lastTimestampKey}')"> <img src="assets/images/visibility.svg" alt="View" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"></button>
        <button class="btn btn-primary btn-sm" onclick="handleHistory('${bioBankId}', '${seq}')"><img src="assets/images/history.svg" alt="History" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"> </button>


        
      </td>
    `;

        tbody.appendChild(row);
      });

      // Open the modal
      $("#exampleModalCenter").modal("show");
    }

    document.addEventListener("DOMContentLoaded", function () {
      db.ref("sef")
        .once("value")
        .then((snapshot) => {
          const data = snapshot.val();

          // Check if data exists
          if (data) {
            window.patientData = data;
            filteredPatientData = data;

            console.log(" ############### ", data);

            //displaySamPatients_load(data);
            displaySamPatients(data);


          } else {
            console.log("No SEF data found");
          }
        })
        .catch((error) => {
          console.error("Error fetching the data from Firebase:", error);
        });
    });


    function formatTimestamp(timestamp) {
      const dateObj = new Date(parseInt(timestamp) * 1000);

      const day = String(dateObj.getDate()).padStart(2, "0");
      const month = String(dateObj.getMonth() + 1).padStart(2, "0");
      const year = dateObj.getFullYear();

      let hours = dateObj.getHours();
      const minutes = String(dateObj.getMinutes()).padStart(2, "0");
      const seconds = String(dateObj.getSeconds()).padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12 || 12;
      const formattedTime = `${String(hours).padStart(
        2,
        "0"
      )}:${minutes}:${seconds} ${ampm}`;

      return `${day}/${month}/${year}, ${formattedTime}`;
    }


    async function displaySamPatients(data) {
      console.log("displaysamPatients - ", data);
      let countDownData = 0
      filteredPatientData = data;
      const tbody = document.querySelector(".patientTableBody1");
      tbody.innerHTML = "";
      let bnLocalS = [];

      db.ref('bn/').once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const boxIDs = snapshot.val();
            console.log("Bio Box Names in the BN node", boxIDs);

            let bnLocalS = [];

            for (const [key, value] of Object.entries(boxIDs)) {
              bnLocalS.push({ id: key, name: value });
            }
            // bnLocalS = boxIDs;
            localStorage.setItem('bnData', JSON.stringify(bnLocalS));

            console.log("Data stored in bnLocalS:", bnLocalS);
            console.log("Data stored in local storage.");
          }
        })
        .catch((error) => {
          console.error('Error fetching data:', error);
        });
      const start = (currentPage - 1) * samRowsPerPage;
      const end = (currentPage) * samRowsPerPage;

      // Retrieve and normalize the sampleTypeInput from localStorage
      const sampleTypeInput = localStorage.getItem("sampleTypeInput")?.trim().toUpperCase();
      const sampleAvailable = localStorage.getItem("sampleAvailable");
      let allSequences = [];
      let promises = [];
      let boxName = '';
      console.log("Starting to populate allSequences...");
      Object.entries(data).forEach(([bioBankId, sequenceData]) => {
        Object.entries(sequenceData).forEach(([seqKey, timestampEntries]) => {
          // Get the latest timestamp key
          const lastTimestampKey = Object.keys(timestampEntries).sort().pop();
          let patient = timestampEntries[lastTimestampKey];

          if (!patient) return;

          let hasSubChildren = false;

          if (patient) {
            hasSubChildren = Object.keys(patient).some(key => typeof patient[key] === 'object' && patient[key] !== null);
          }

          if (hasSubChildren) {
            let patientmd = patient.md;
            patient = patient.ie;
            // function capitalizeFirstLetter(string) {
            //   if (!string) return string; 
            //   return string.charAt(0).toUpperCase() + string.slice(1);
            // }
            const patientdd = { ...patient };
            if (patientmd && patientmd.gd) {
              // patient.gd = capitalizeFirstLetter(patientmd?.gd);

            }
            // patient.gd = patientmd?.gd
            patientdd.gd = patientmd?.gd.charAt(0).toUpperCase() + patientmd?.gd.slice(1);


            // patientmd?.gd.charAt(0).toUpperCase() + string.slice(1)

            patient = patientdd;
            console.log("patient.gd", patient, patient.gd)
          }

          const fields = ["bpg", "bsg", "bbcg", "ftg", "fng", "osg", "rlt", "pc"];
          fields.forEach((field) => {
            const fieldData = patient[field];
            if (!fieldData) return;

            const [boxid = "-", seatData = "", sampleData = ""] = fieldData.split("/");

            const seatList = seatData.split(",").map((seat) => seat.trim());
            let sampleTypeList = sampleData.split(",").map((type) => type.trim().toUpperCase());
            console.log("sampleTypeList 0", sampleTypeList)
            console.log("sampleTypeList 2", fieldData)

            const uniformSampleTypes = [
              "PLASMA", "MPLASMA", "SERUM", "MSERUM", "BUFFY COAT", "MBUFFY COAT", "OTHER", "MOTHER", "FN", "FT", "MFN", "MFT", "RLT", "PC"
            ];

            // Check if the sampleTypeList length is less than seatList
            if (sampleTypeList.length < seatList.length) {
              // Repeat the last valid sampleType to fill in the rest of seatList entries
              const lastSampleType = sampleTypeList[sampleTypeList.length - 1];
              while (sampleTypeList.length < seatList.length) {
                sampleTypeList.push(lastSampleType);  // Repeat the last valid sample type
                
              }
            }
            console.log("seatList ",seatList, " sampleTypeList ",sampleTypeList, " sampleTypeInput ",sampleTypeInput)

            seatList.forEach((seat, index) => {
              const sampleType = sampleTypeList[index];

              if (
                (sampleTypeInput === "ALL") ||
                ((sampleType.startsWith("PLASMA") || sampleType.startsWith("MPLASMA")) && sampleTypeInput.startsWith("PLASMA")) ||
                ((sampleType.startsWith("SERUM") || sampleType.startsWith("MSERUM")) && sampleTypeInput.startsWith("SERUM")) ||
                ((sampleType.startsWith("BUFFY COAT") || sampleType.startsWith("MBUFFY COAT")) && sampleTypeInput.startsWith("BUFFY COAT")) ||
                ((sampleType.startsWith("OTHER") || sampleType.startsWith("MOTHER")) && sampleTypeInput.startsWith("OTHER")) ||
                ((sampleType.startsWith("FN") || sampleType.startsWith("MFN")) && sampleTypeInput.startsWith("FN")) ||
                ((sampleType.startsWith("FT") || sampleType.startsWith("MFT")) && sampleTypeInput.startsWith("FT")) ||
                ((sampleType.startsWith("RLT") || sampleType.startsWith("MRLT")) && sampleTypeInput.startsWith("RLT")) ||
                ((sampleType.startsWith("PC") || sampleType.startsWith("PC")) && sampleTypeInput.startsWith("PC"))
              ) {
                console.log("Condition successful")
                const seatIndex = getSeatIndex(seat.trim());
                countDownData++;
                const promise1 =
                  db.ref(`bb/${boxid}/${seatIndex}/`).once('value')
                    .then(snapshot => {
                      const box = snapshot.val();
                      if (box) {
                        const sts = box.status;
                        const status = sampleAvailable === "All" || (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) || (sampleAvailable === "Available" && (sts === null || sts === "o"));

                        const storedBnData = JSON.parse(localStorage.getItem('bnData'));
                        const boxEntry = storedBnData.find(entry => entry.id === boxid);
                        if (boxEntry) {
                          boxName = boxEntry.name;
                        }
                        console.log("Status: ", status, sampleAvailable)


                        if (status) {
                          allSequences.push({
                            serialNumber: allSequences.length + 1,
                            bioBankId,
                            seqKey,
                            timestampKey: lastTimestampKey,
                            field,
                            boxName: boxName.trim(),
                            seat: seat.trim(),
                            sampleType,
                            patientData: patient,
                          });
                          console.log("sampleType bb -----", allSequences.length)
                        }
                      }
                    });

                const promise2 =
                  db.ref(`sb/${boxid}/${seatIndex}/`).once('value')
                    .then(snapshot => {
                      const box1 = snapshot.val();
                      if (box1) {
                        const sts = box1.status;
                        const status = sampleAvailable === "All" ||
                          (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) ||
                          (sampleAvailable === "Available" && (sts === null || sts === "o"));

                        const storedBnData = JSON.parse(localStorage.getItem('bnData'));
                        const boxEntry = storedBnData.find(entry => entry.id === boxid);
                        if (boxEntry) {
                          boxName = boxEntry.name;
                        }
                        console.log("Status: ", status)

                        if (status) {
                          allSequences.push({
                            serialNumber: allSequences.length + 1,
                            bioBankId,
                            seqKey,
                            timestampKey: lastTimestampKey,
                            field,
                            boxName: boxName.trim(),
                            seat: seat.trim(),
                            sampleType,
                            patientData: patient,
                          });
                          allDataDown = allSequences
                          console.log("sampleType sb -----", allSequences.length)
                        }
                      }
                    });
                    const promise3 =
                  db.ref(`rlt/${boxid}/${seatIndex}/`).once('value')
                    .then(snapshot => {
                      const box1 = snapshot.val();
                      if (box1) {
                        const sts = box1.status;
                        const status = sampleAvailable === "All" ||
                          (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) ||
                          (sampleAvailable === "Available" && (sts === null || sts === "o"));

                        const storedBnData = JSON.parse(localStorage.getItem('bnData'));
                        const boxEntry = storedBnData.find(entry => entry.id === boxid);
                        if (boxEntry) {
                          boxName = boxEntry.name;
                        }
                        console.log("Status: ", status)

                        if (status) {
                          allSequences.push({
                            serialNumber: allSequences.length + 1,
                            bioBankId,
                            seqKey,
                            timestampKey: lastTimestampKey,
                            field,
                            boxName: boxName.trim(),
                            seat: seat.trim(),
                            sampleType,
                            patientData: patient,
                          });
                          allDataDown = allSequences
                          console.log("sampleType sb -----", allSequences.length)
                        }
                      }
                    });
                    const promise4 =
                  db.ref(`pcb/${boxid}/${seatIndex}/`).once('value')
                    .then(snapshot => {
                      const box1 = snapshot.val();
                      if (box1) {
                        const sts = box1.status;
                        const status = sampleAvailable === "All" ||
                          (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) ||
                          (sampleAvailable === "Available" && (sts === null || sts === "o"));

                        const storedBnData = JSON.parse(localStorage.getItem('bnData'));
                        const boxEntry = storedBnData.find(entry => entry.id === boxid);
                        if (boxEntry) {
                          boxName = boxEntry.name;
                        }
                        console.log("Status: ", status)

                        if (status) {
                          allSequences.push({
                            serialNumber: allSequences.length + 1,
                            bioBankId,
                            seqKey,
                            timestampKey: lastTimestampKey,
                            field,
                            boxName: boxName.trim(),
                            seat: seat.trim(),
                            sampleType,
                            patientData: patient,
                          });
                          allDataDown = allSequences
                          console.log("sampleType sb -----", allSequences.length)
                        }
                      }
                    });

                promises.push(promise1);
                promises.push(promise2);
                promises.push(promise3);
                promises.push(promise4);
                document.getElementById('allDownload').innerHTML= countDownData;


              }
              // else{
              //   console.log("sampleType -----",sampleType)
              //   console.log("sampleTypeList -----",sampleTypeList[index])
              // }
            });


          });

        });

      });
      // console.log("promise2",promises)


      // Wait for all promises to resolve
      Promise.all(promises).then(() => {
        hideLoadingModal();
        console.log("All promises resolved. Processing allSequences:", allSequences);
        console.log("All promises resolved", allSequences.length)

        // Paginate the filtered sequences
        const paginatedSequences = allSequences.slice(start, end);

        console.log("paginatedSequences --- ", paginatedSequences)



        // Populate the table with filtered sequences
        paginatedSequences.forEach((sequence) => {
          const {
            serialNumber,
            bioBankId,
            seqKey,
            timestampKey,
            field,
            boxName,
            seat,
            sampleType,
            patientData,
          } = sequence;

          const row = document.createElement("tr");
          row.classList.add("patientRow");
          row.setAttribute("data-bioBankId", bioBankId);
          row.setAttribute("data-seqKey", seqKey);
          row.setAttribute("data-timestampKey", timestampKey);
          row.setAttribute("data-grid", seat);
          row.setAttribute("data-box", boxName);


          console.log("boxName --- ", boxName)
          console.log("seqKey --- ", bioBankId, " ", seqKey)
          console.log("sampleType ----", sampleType)


          row.innerHTML = `
            <td class="small-text"><input type='checkbox' class="btn btn-primary btn-sm selection" name="checkbox"></td>
            <th scope="row" class="sno small-text">${serialNumber}</th>
            <td class="patientName small-text">${bioBankId || "-"}</td>
            <td class="age small-text">${patientData.ag || "-"}</td>
            <td class="gender small-text">${patientData.sx || "-"}</td>
            <td class="timestamp small-text" data-seq-key="${seqKey}" data-timestamp-key="${timestampKey}">${formatTimestamp(timestampKey) || "-"}</td>
            <td class="box small-text">${boxName || "-"}</td>
            <td class="grid small-text">${seat || '-'}</td>
            <td class="sampleType small-text">${sampleType || "-"}</td>
            <td class="cancerType small-text">${patientData.ct === "brst" ? "Breast Cancer" : "-"}</td>
            <td class="grade small-text">${patientData.gd || "-"}</td>
            <td class="action small-text">
              <div class="btn-group" role="group" aria-label="Patient Actions">
                <button class="btn btn-primary btn-sm small-text" onclick="editPatient('${bioBankId}', '${seqKey}', '${timestampKey}')">
                  <img src="assets/images/edit.svg" alt="Edit" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
                <button class="btn btn-info btn-sm small-text" onclick="viewPatient('${bioBankId}', '${seqKey}', '${timestampKey}')">
                  <img src="assets/images/visibility.svg" alt="View" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
                <button class="btn btn-success btn-sm small-text" onclick="handleHistory('${bioBankId}', '${seqKey}')">
                  <img src="assets/images/history.svg" alt="History" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
              </div>
            </td>
          `;

          tbody.appendChild(row);
        });

        // Call the function to update pagination and show the page
        updateSamPagination(allSequences.length);
      });
    }


    async function searchSample(event) {
      searchLoadingModal();
      event.preventDefault();

      // Retrieve input values from the form
      const ageCriterion = document.getElementById("ageCriterion").value;
      const ageInput = parseInt(document.getElementById("ageInput").value);
      const cancerTypeInput = document.getElementById("cancerTypeInput").value;
      const gradeInput = document.getElementById("gradeInput").value;
      const nactInput = document.getElementById("nactInput").value;
      const pathSubtypeInput = document.getElementById("pathSubtype").value;
      const sampleTypeInput = document.getElementById("sampleType").value.toUpperCase();
      const sampleAvailable = document.getElementById("sampleavailable").value;
      const clinicalSubInput = document.getElementById("cSubInput").value;
      const metaInput = document.getElementById("metaInput").value;
      const ajjcInput = document.getElementById("AJCCInput").value;

      
      
      if (!window.patientData) {
        console.error("Patient data is not available.");
        return;
      }

      const criteria = {
        ageCriterion,
        ageInput,
        cancerTypeInput,
        gradeInput,
        nactInput,
        pathSubtypeInput,
        sampleTypeInput,
        sampleAvailable,
        metaInput,
        ajjcInput,
        clinicalSubInput
      };

      const filteredPatientData = {};

      for (const bioBankId of Object.keys(window.patientData)) {
        const patientEntries = window.patientData[bioBankId];
        const seqNumbers = Object.keys(patientEntries);

        if (seqNumbers.length === 0) continue;

        filteredPatientData[bioBankId] = {};
        let countDownData = 0

        for (const seqNumber of seqNumbers) {
          const entryData = patientEntries[seqNumber];
          const nestedKeys = Object.keys(entryData);

          for (const nestedKey of nestedKeys) {
            const patientData = entryData[nestedKey]?.ie;
            const patientmd = entryData[nestedKey]?.md;
            const patientbrf = entryData[nestedKey]?.brf;
            console.log("patientmd.ag",patientmd.ag)

            if (!patientData) continue;

            const ageMatch =
              !criteria.ageInput ||
              (criteria.ageCriterion === "Greater than" && parseInt(patientData.ag) > criteria.ageInput) ||
              (criteria.ageCriterion === "Less than" && parseInt(patientData.ag) < criteria.ageInput) ||
              (criteria.ageCriterion === "Equal to" && parseInt(patientData.ag) === criteria.ageInput);

            const cancerTypeMatch =
              criteria.cancerTypeInput === "All" ||
              !criteria.cancerTypeInput ||
              patientData.ct === criteria.cancerTypeInput.toLowerCase();

            const gradeMatch =
              criteria.gradeInput === "All" ||
              !criteria.gradeInput ||
              patientmd.gd.toLowerCase() === criteria.gradeInput.toLowerCase();

            const nactMatch =
              criteria.nactInput === "All" ||
              !criteria.nactInput ||
              (criteria.nactInput === "Yes" && patientData.nact === "true") ||
              (criteria.nactInput === "No" && patientData.nact === "false");

            const pathSubtypeMatch =
              criteria.pathSubtypeInput === "All" ||
              !criteria.pathSubtypeInput ||
              patientmd.pst === criteria.pathSubtypeInput.toLowerCase();

            const sampleTypeMatch = (() => {
              const sampleFields = ["bpg", "bsg", "bbcg", "fng", "ftg", "osg", "rlt", "pc"];
              return sampleFields.some((field) => {
                const sampleValue = patientData[field];
                if (sampleValue) {
                  const sampleType = sampleValue.split("/")[2]?.toUpperCase();
                  return (
                    (sampleTypeInput === "ALL") ||
                    (sampleTypeInput === "PLASMA" && (sampleType.startsWith("MPLASMA") || sampleType === "PLASMA")) ||
                    (sampleTypeInput === "SERUM" && (sampleType.startsWith("MSERUM") || sampleType === "SERUM")) ||
                    (sampleTypeInput === "BUFFY COAT" && (sampleType.startsWith("MBUFFY COAT") || sampleType === "BUFFY COAT")) ||
                    (sampleTypeInput === "OTHER" && (sampleType.startsWith("MOTHER") || sampleType === "OTHER")) ||
                    ((sampleType.startsWith("FN") || sampleType.startsWith("MFN")) && sampleTypeInput.startsWith("FN")) ||
                    ((sampleType.startsWith("FT") || sampleType.startsWith("MFT")) && sampleTypeInput.startsWith("FT"))||
                    (sampleTypeInput === "RLT" && (sampleType.startsWith("RLT") || sampleType === "RLT")) ||
                    (sampleTypeInput === "PC" && (sampleType.startsWith("PC") || sampleType === "PC"))

                  );
                }
                return false;
              });
            })();

            localStorage.setItem("sampleTypeInput", sampleTypeInput);
            localStorage.setItem("sampleAvailable", sampleAvailable);

            const metaInputMatch = 
               criteria.metaInput === "All" ||
              !criteria.metaInput ||
              (criteria.metaInput === "Yes" && patientData.mts === "true") ||
              (criteria.metaInput === "No" && patientData.mts === "false");

            const ajjcInputMatch = 
               criteria.ajjcInput === "All" ||
              !criteria.ajjcInput ||
              (criteria.ajjcInput === "I" && patientmd.as === "IA") ||
              (criteria.ajjcInput === "I" && patientmd.as === "IB") ||
              (criteria.ajjcInput === "I" && patientmd.as === "IC") ||
              (criteria.ajjcInput === "II" && patientmd.as === "IIA") ||
              (criteria.ajjcInput === "II" && patientmd.as === "IIB") ||
              (criteria.ajjcInput === "II" && patientmd.as === "IIC") ||
              (criteria.ajjcInput === "III" && patientmd.as === "IIIA") ||
              (criteria.ajjcInput === "III" && patientmd.as === "IIIB")||
              (criteria.ajjcInput === "III" && patientmd.as === "IIIC") ||
              (criteria.ajjcInput === "IV" && patientmd.as === "IVA") ||
              (criteria.ajjcInput === "IV" && patientmd.as === "IVB") ||
              (criteria.ajjcInput === "IV" && patientmd.as === "IVC");
          
            const cSubInputMatch = 
               criteria.clinicalSubInput === "All" ||
              !criteria.clinicalSubInput ||
              (criteria.clinicalSubInput === "HR positive" && patientbrf.sbt === "HR positive") ||
              (criteria.clinicalSubInput === "Her2 enriched" && patientbrf.sbt === "Her2 enriched")||
              (criteria.clinicalSubInput === "Triple positive" && patientbrf.sbt === "Triple positive") ||
              (criteria.clinicalSubInput === "TNBC" && patientbrf.sbt === "TNBC");
          

            if (ageMatch && cancerTypeMatch && gradeMatch && nactMatch && pathSubtypeMatch && sampleTypeMatch && metaInputMatch && ajjcInputMatch && cSubInputMatch) {
              if (!filteredPatientData[bioBankId][seqNumber]) {
                filteredPatientData[bioBankId][seqNumber] = {};
              }
              function capitalizeFirstLetter(string) {
                if (!string) return string;
                return string.charAt(0).toUpperCase() + string.slice(1);
              }

              filteredPatientData[bioBankId][seqNumber][nestedKey] = { ...patientData, gd: capitalizeFirstLetter(patientmd?.gd) };
              /*if (sampleAvailableMatch) {
                filteredPatientData[bioBankId][seqNumber][nestedKey] = {
                  ...patientData,
                  ssts: sampleStatusList,
                };
              }*/

            }
           
          }

        }

        if (Object.keys(filteredPatientData[bioBankId]).length === 0) {
          delete filteredPatientData[bioBankId];
        }

      }
      //Update_samplestatus(filteredPatientData, criteria);


      currentPage = 1;
      console.log("Filtered Patient Data:", filteredPatientData);
      displaySamPatients(filteredPatientData);
    }







    function processAndCheckSampleType(patientField, sampleTypeInput, sampleAvailableCriteria) {
      console.log(" processAndCheckSampleType ", patientField);

      if (patientField !== undefined) {
        // Split the patientField into its components
        const parts = patientField.split("/");

        if (parts.length < 3) {
          console.error("Invalid sample format:", patientField);
          return false;
        }

        const [boxName, gridNumber, sampleType] = parts.map(part => part.trim());

        // Normalize sample type to uppercase for comparisons
        const normalizedSampleType = sampleType.toUpperCase();

        // Check if the sample type matches the input criteria
        const sampleTypeMatch =
          sampleTypeInput === "ALL" ||
          (sampleTypeInput === "PLASMA" && (normalizedSampleType.startsWith("MPLASMA") || normalizedSampleType === "PLASMA")) ||
          (sampleTypeInput === "SERUM" && (normalizedSampleType.startsWith("MSERUM") || normalizedSampleType === "SERUM")) ||
          (sampleTypeInput === "BUFFY COAT" && (normalizedSampleType.startsWith("MBUFFY COAT") || normalizedSampleType === "BUFFY COAT")) ||
          (sampleTypeInput === "OTHER" && (normalizedSampleType.startsWith("MOTHER") || normalizedSampleType === "OTHER")) ||
          ((normalizedSampleType.startsWith("FN") || normalizedSampleType.startsWith("MFN")) && sampleTypeInput.startsWith("FN")) ||
          ((normalizedSampleType.startsWith("FT") || normalizedSampleType.startsWith("MFT")) && sampleTypeInput.startsWith("FT"));

        if (!sampleTypeMatch) {
          return false;
        }

        // Check if the box name exists in sb or bb nodes
        const boxExists = checkBoxExists(boxName);

        if (!boxExists) {
          console.error(`Box "${boxName}" does not exist in sb/ or bb/ nodes.`);
          return false;
        }

        // Optional: Check availability criteria if provided
        const sampleAvailableMatch =
          !sampleAvailableCriteria ||
          (sampleAvailableCriteria === "Available" && patientField.bs === "true") ||
          (sampleAvailableCriteria === "Not Available" && patientField.bs === "false");

        return sampleAvailableMatch;
      } else {
        return false;
      }
    }

    // Helper function to simulate checking box existence
    function checkBoxExists(boxName) {
      const mockSbNodes = ["Blood Box 01", "Blood Box 02"]; // Example data for sb/ nodes
      const mockBbNodes = ["Blood Box 03", "Blood Box 04"]; // Example data for bb/ nodes

      return mockSbNodes.includes(boxName) || mockBbNodes.includes(boxName);
    }



    function isMatch(patientData, criteria) {
      const { ageCriterion, ageInput, cancerTypeInput, gradeInput, nactInput, pathSubtypeInput, sampleTypeInput } = criteria;

      const patient = patientData.ie || {};
      const ageMatch = checkAgeCriterion(patient.ag, ageCriterion, ageInput);
      const cancerTypeMatch = cancerTypeInput === "All" || patient.ct === cancerTypeInput;
      const gradeMatch = gradeInput === "All" || patientData.md?.gd === gradeInput;
      const nactMatch =
        nactInput === "All" ||
        (nactInput === "Y" && patientData.md?.nact === "true") ||
        (nactInput === "N" && patientData.md?.nact === "false");
      const pathSubtypeMatch = pathSubtypeInput === "All" || patientData.md?.pst === pathSubtypeInput;

      const sampleTypeMatch =
        sampleTypeInput === "ALL" ||
        ["bpg", "bsg", "bbcg", "fng", "ftg", "osg"].some((field) =>
          checkSampleType(patient[field], sampleTypeInput)
        );

      return ageMatch && cancerTypeMatch && gradeMatch && nactMatch && pathSubtypeMatch && sampleTypeMatch;
    }

    // Helper function to check sample type
    function checkSampleType(sampleType, sampleTypeInput) {
      if (sampleTypeInput === "ALL") return true;

      const sampleTypePatterns = {
        "PLASMA": ["PLASMA", "MPLASMA"],
        "SERUM": ["SERUM", "MSERUM"],
        "BUFFY COAT": ["BUFFY COAT", "MBUFFY COAT"],
        "OTHER": ["OTHER", "MOTHER"],
        "FN": ["FN", "MFN"],
        "FT": ["FT", "MFT"],
      };

      const patterns = sampleTypePatterns[sampleTypeInput];
      return patterns ? patterns.some((pattern) => sampleType.startsWith(pattern)) : false;
    }


    function checkAgeCriterion(age, criterion, selectedAge) {
      if (!selectedAge) return true;

      const ageNumber = parseInt(selectedAge, 10);
      const patientAge = parseInt(age, 10);
      if (isNaN(ageNumber)) return true;
      //console.log(" checking age = ", patientAge, " input ", selectedAge, " : ", (patientAge === ageNumber));

      switch (criterion) {
        case "Greater than":
          return patientAge > ageNumber;
        case "Less than":
          return patientAge < ageNumber;
        case "Equal to":
          return patientAge === ageNumber;
        default:
          return true;
      }
    }

    document
      .getElementById("individualSearchBtn")
      .addEventListener("click", function () {
        const sampleSearch = document.getElementById("collapseExample1");
        const individualSearch = document.getElementById("collapseExample");
        individualSearchBtn.classList.add("active");

        if (sampleSearch.classList.contains("show")) {
          sampleSearch.classList.remove("show");
          sampleSearchBtn.classList.remove("active");
        }
      });

    document
      .getElementById("sampleSearchBtn")
      .addEventListener("click", function () {
        const individualSearch = document.getElementById("collapseExample");
        const sampleSearch = document.getElementById("collapseExample1");
        sampleSearchBtn.classList.add("active");

        if (individualSearch.classList.contains("show")) {
          individualSearch.classList.remove("show");
          individualSearchBtn.classList.remove("active");
        }
      });
    document.getElementById("download3").addEventListener("click", function () {

      const rowPromises = [];

      console.log("allData Download", allDataDown);
      allDataDown.forEach((data) => {
        // console.log("allData ", data.bioBankId)
        const bioBankId = data.bioBankId
        const seqKey = data.seqKey
        const timestampKey = data.timestampKey
        const gridData = data.seat

        // console.log("bioBankId ", bioBankId, " seqKey ", seqKey, " timestampKey ", timestampKey, " gridData ", gridData);
        const promise1 = db.ref(`sef/${bioBankId}/${seqKey}/${timestampKey}/`).once('value')
          .then(snapshot => snapshot.val() || {});

        const promise2 = db.ref(`Fw/${bioBankId}/`).limitToLast(1).once('value')
          .then(snapshot => {
            const fwdata = snapshot.val();
            console.log("fwdata - ", fwdata);
            let timestamp;
            let fwlastTimestamp;
            if (fwdata) {

              timestamp = Object.keys(fwdata)[0]; // Since we are limiting to last 1, there should be only one key
              const fwlastTimestamp = fwdata[timestamp]; // Get the lastTimestamp object using the key

              return { fwlastTimestamp, timestamp };
            }
            return { fwlastTimestamp, timestamp };
          });

        const promise3 = db.ref(`Os/${bioBankId}/${seqKey}`).limitToLast(1).once('value')
          .then(snapshot => {
            const osdata = snapshot.val();
            console.log("osdata -- ", osdata);
            let lastKey;

            if (osdata) {
              // Get the last key (timestamp) from the osdata
              lastKey = Object.keys(osdata)[0]; // Since we are limiting to last 1, there should be only one key
              let oslastTimestamp = osdata[lastKey]; // Get the lastTimestamp object using the key

              console.log('Last Timestamp in os :', oslastTimestamp, lastKey);

              // Check if lbi exists and loop through it
              if (oslastTimestamp && oslastTimestamp.lbi) {
                for (const box in oslastTimestamp.lbi) {
                  if (oslastTimestamp.lbi.hasOwnProperty(box)) {
                    const grids = oslastTimestamp.lbi[box];
                    if (grids.includes(gridData)) {
                      console.log(`Grid Data "${gridData}" found in "${box}":`, grids);
                      return { oslastTimestamp: oslastTimestamp, lastKey: lastKey }; // Return structured object
                    }
                  }
                }
              }
              return { oslastTimestamp: oslastTimestamp, lastKey: lastKey || {} }; // Return lastTimestamp or empty object if no match found
            } else {
              return {}; // Return empty object if osdata does not exist
            }
          });

        const rowPromise = Promise.all([promise1, promise2, promise3])
          .then(async ([sefData, fwData, osData]) => {
            // Wait for decodeGridValue to fully resolve
            const plasmaGrid = await decodeGridValue(sefData.ie.bpg);
            const serumGrid = await decodeGridValue(sefData.ie.bsg);
            const buffyCoatGrid = await decodeGridValue(sefData.ie.bbcg);
            const otherGrid = await decodeGridValue(sefData.ie.osg);
            const ftgGrid = await decodeGridValue(sefData.ie.ftg);
            const fngGrid = await decodeGridValue(sefData.ie.fng);
            const rltGrid = await decodeGridValue(sefData.ie.rlt);
            const pcGrid = await decodeGridValue(sefData.ie.pc);
            // const oSgridData = await formatOsData(osData.oslastTimestamp.lbi);
            
            // const oSgrid = "-"
            let oSgrid = "";
            console.log("osData",osData)
            if(osData !== null && Object.keys(osData).length!==0 ){
              const oSgridData = await formatOsData(osData.oslastTimestamp.lbi);
              oSgrid = await decodeOSGridValue(oSgridData);
            }
            else{
              oSgrid= "-";
            }
            // Return the full row data with resolved plasmaGrid
            return {
              bioBankId,
              seqKey,
              timestampKey,
              sefData,
              fwData,
              osData,
              plasmaGrid,
              serumGrid,
              buffyCoatGrid,
              otherGrid,
              ftgGrid,
              fngGrid,
              rltGrid,
              pcGrid,
              oSgrid
            };
          });

        rowPromises.push(rowPromise);



      });

      // Process all rows once promises resolve
      Promise.all(rowPromises)
        .then((rowsData) => {
          console.log("All data fetched:", rowsData);

          const excelData = rowsData.map(row => ({

            Sample_Timestamp: formatTimestamp(row.timestampKey),
            bioBankId: row.bioBankId,
            Age: row.sefData.ie.ag || "-",
            Gender: decodeProcedureType(row.sefData.ie.sx) || "-",
            CancerType: decodeProcedureType(row.sefData.ie.ct) || "-",
            ProcedureType: decodeProcedureType(row.sefData.ie.tpr),
            DetailProcedure: row.sefData.ie.dpr || "-",
            SurgeonName: row.sefData.ie.srn || "-",
            BloodSample: decodeProcedureType(row.sefData.ie.bs) || "-",
            SpecimenSample: decodeProcedureType(row.sefData.ie.ss) || "-",
            OtherSample: decodeProcedureType(row.sefData.ie.osmp) || "-",
            RLTSample: decodeProcedureType(row.sefData.ie.rltS) || "-",
            PrimaryCultureSample: decodeProcedureType(row.sefData.ie.pcS) || "-",
            PlasmaGrid: row.plasmaGrid || "-",
            SerumGrid: row.serumGrid || "-",
            BuffyCoatGrid: row.buffyCoatGrid || "-",
            FTTubeGrids: row.ftgGrid || "-",
            FNTubeGrids: row.fngGrid || "-",
            OtherSample_description: row.sefData.ie.osdsc || "-",
            OtherSampleGrid: row.otherGrid || "-",
            RLTSampleGrid: row.rltGrid || "-",
            PrimarySampleGrid: row.pcGrid || "-",
            nact: decodeProcedureType(row.sefData.ie.nact) || "-",
            NACT_Drug_Cycles: row.sefData.ie.nactdc || "-",
            NACT_date_of_last_cycle: row.sefData.ie.nactdlc || "-",             
            IschemicSample: decodeProcedureType(row.sefData.ie.iss) || "-",
            ProcessedBy: row.sefData.ie.prb || "-",
            // SampleEntryUpdatedBy: row.sefData.ie.fng || "-",
            MetastasisSample: decodeProcedureType(row.sefData.ie.mts) || "-",
            Consent: decodeProcedureType(row.sefData.ie.cnst) || "-",//Math.floor()/ 1000
            SampleReceivedTime: formatTimestamp1(row.sefData.ie.srt) || "-",
            SampleProcessedTime: formatTimestamp1(row.sefData.ie.spt) || "-",
            BloodReceivedTime: formatTimestamp1(row.sefData.ie.brt) || "-",
            BloodProcessedTime: formatTimestamp1(row.sefData.ie.bpt) || "-",
            BloodSampleProcessedBy: row.sefData.ie.bsby || "-",
            SpecimenReceivedTime: formatTimestamp1(row.sefData.ie.sprt) || "-",
            SpecimenProcessedTime: formatTimestamp1(row.sefData.ie.sppt) || "-",
            SpecimenSampleProcessedby: row.sefData.ie.ssby || "-",
            OtherSampleReceivedTime: formatTimestamp1(row.sefData.ie.ospt) || "-",
            OtherSampleProcessedTime: formatTimestamp1(row.sefData.ie.osrt) || "-",
            OtherSampleProcessedby: row.sefData.ie.osby || "-",
            RLTSampleReceivedTime: formatTimestamp1(row.sefData.ie.rspt) || "-",
            RLTSampleProcessedTime: formatTimestamp1(row.sefData.ie.rsrt) || "-",
            RLTSampleProcessedby: row.sefData.ie.rltpb || "-",
            PrimaryCultureSampleReceivedTime: formatTimestamp1(row.sefData.ie.pspt) || "-",
            PrimaryCultureampleProcessedTime: formatTimestamp1(row.sefData.ie.psrt) || "-",
            PrimaryCultureSampleProcessedby: row.sefData.ie.psspb || "-",
            Initial_form_updatedby: row.sefData.ie.sef_ub || "-",

            FamilyHistoryCancer: decodeProcedureType(row.sefData.md.fhc),
            FamilyRelation: row.sefData.md.fhcr || "-",
            FamilyCancerType: row.sefData.md.fhct || "-",
            FoodHabbits: decodeProcedureType(row.sefData.md.fh) || "-",
            HistoryOfAlcoholConsumption: decodeProcedureType(row.sefData.md.hac) || "-",
            HistoryOfSmoking: decodeProcedureType(row.sefData.md.hs) || "-",
            ExistingComorbidities: decodeProcedureType(row.sefData.md.ec) || "-",
            ComorbidityandCorrespondingMedicationsforComorbidity: row.sefData.md.ecm || "-",
            FF_QC_comments: row.sefData.md.ffqc || "-",
            FF_Tissue_Remarks: row.sefData.md.ftr || "-",
            Tumor_Site: decodeProcedureType(row.sefData.md.tst) || "-",
            TumorPercentage: row.sefData.md.tp || "-",
            AgeAtDiagnosis: row.sefData.md.ad || "-",
            ClinicalStage: row.sefData.md.cs || "-",
            IHC_Marker_status: decodeProcedureType(row.sefData.md.ihcm) || "-",
            IHC_marker_description: row.sefData.md.ihcd || "-",
            Genetic_Testing: decodeProcedureType(row.sefData.md.gt) || "-",
            Genetic_Testing_Description: row.sefData.md.gtd || "-",
            Pathologic_Subtype: decodeProcedureType(row.sefData.md.pst) || "-",
            Grade: row.sefData.md.gd || "-",
            Focality: row.sefData.md.fc === "true" ? "Unifocal" : row.sefData.md.fc === "false" ? "Multifocal" : "-",
            LVI: decodeProcedureType(row.sefData.md.lvi) || "-",
            PNI: decodeProcedureType(row.sefData.md.pni) || "-",
            pTNM: row.sefData.md.ptnm || "-",
            AJCCStaging: row.sefData.md.as || "-",
            NumberOfNodesTested: row.sefData.md.nnt || "-",
            NumberOfPositiveNodes: row.sefData.md.npn || "-",
            TumorSize: row.sefData.md.tsz || "-",
            Denovo_metastasis: decodeProcedureType(row.sefData.md.dm) || "-",
            Metastasis_Post_Treatment: decodeProcedureType(row.sefData.md.mpt) || "-",
            BiopsyTissueNumber: row.sefData.md.btn || "-",
            BiopsyDate: row.sefData.md.bd || "-",
            Surgery_Tissue_Number_HPE: row.sefData.md.stn || "-",
            SurgeryDate: row.sefData.md.sd || "-",
            RCBScore: row.sefData.md.rcbs || "-",
            RCBClass: row.sefData.md.rcbc || "-",
            ACT: decodeProcedureType(row.sefData.md.act) || "-",
            ACT_Drug_Cycles: row.sefData.md.actdc || "-",
            ACT_Date_of_last_Cycle: row.sefData.md.actdls || "-",
            Radiotherapy: decodeProcedureType(row.sefData.md.rd) || "-",
            Radiotherapy_details: row.sefData.md.rdd || "-",
            RT_date_of_last_cycle: row.sefData.md.rtdls || "-",
            ParaffinBlockAvailable: decodeProcedureType(row.sefData.md.ipba) || "-",
            ParaffinBlockNumber: row.sefData.md.ipbainfo || "-",
            Metadata_updated_by: row.sefData.md.mdu || "-",

            AgeOfMenarche: row.sefData.brf.am || "-",
            Parity: row.sefData.brf.pty || "-",
            NoOfChildren: row.sefData.brf.noc || "-",
            AgeAtFirstChild: row.sefData.brf.afc || "-",
            Breastfed: decodeProcedureType(row.sefData.brf.bf) || "-",
            DurationBreastfeeding: row.sefData.brf.dbf || "-",
            MenopausalStatus: row.sefData.brf.ms || "-",
            //ER: decodeProcedureType(row.sefData.brf.er) || "-",
            ER: decodeProcedureType(row.sefData.brf.er)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            PR: decodeProcedureType(row.sefData.brf.pr)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            HER2: decodeProcedureType(row.sefData.brf.h2)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            Subtype: row.sefData.brf.sbt || "-",
            Ki67: row.sefData.brf.k67 || "-",
            // ClinicalStage_Brf: row.sefData.brf.cs || "-",
            BIRADS_score: row.sefData.brf.ht || "-",
            sTILsPercentScores: row.sefData.brf.sps || "-",
            BR_form_updated_By: row.sefData.brf.brfu || "-",

            followUpTime: getValue(formatTimestamp(Math.floor(row.fwData?.timestamp) / 1000)) || "-",
            LastFollowUpDate: getValue(row.fwData?.fwlastTimestamp?.dd) || "-",
            LastFollowUpStatus: getValue(row.fwData?.fwlastTimestamp?.lfs) || "-",
            VitalStatus: getValue(row.fwData?.fwlastTimestamp?.vs) || "-",
            RecurrenceDate: getValue(row.fwData?.fwlastTimestamp?.rd) || "-",
            Reported_Date_for_Progressive_Disease: getValue(row.fwData?.fwlastTimestamp?.rdpd) || "-",
            Progression_metastasis_remark: getValue(row.fwData?.fwlastTimestamp?.pet) || "-",
            Reason_For_lost_to_follow_up: getValue(row.fwData?.fwlastTimestamp?.rlfw) || "-",
            Other_reason: getValue(row.fwData?.fwlastTimestamp?.othrs) || "-",
            Death_date: getValue(row.fwData?.fwlastTimestamp?.dd) || "-",
            Remarks: getValue(row.fwData?.fwlastTimestamp?.rmks) || "-",
            followUp_updated_by: getValue(row.fwData?.fwlastTimestamp?.fw_ub) || "-",


            SharedTime: getValue(formatTimestamp(row.osData?.lastKey)) || "-",
            Shared_date: getValue(row.osData?.oslastTimestamp?.doe) || "-",
            Shared_Grid: row.oSgrid,
            institute_or_Department: getValue(row.osData?.oslastTimestamp?.dpt) || "-",
            project: getValue(row.osData?.oslastTimestamp?.prj) || "-",
            PI_of_the_project: getValue(row.osData?.oslastTimestamp?.pip) || "-",
            Shared_status: getValue(row.osData?.oslastTimestamp?.ossts) || "-",
            Partial_shared_remark: getValue(row.osData?.oslastTimestamp?.psr) || "-",
            Shared_form_updated_by: getValue(row.osData?.oslastTimestamp?.os_ub) || "-"


          }));

          // Export to Excel
          const worksheet = XLSX.utils.json_to_sheet(excelData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "BioBank Data");

          // Download the Excel file
          XLSX.writeFile(workbook, "BioBank_Data.xlsx");
        })
        .catch(error => {
          console.error("Error fetching data:", error);
        });

    })

    document.getElementById("download2").addEventListener("click", function () {
      console.log("Download Begin");

      const checkedBoxes = document.querySelectorAll(".selection:checked");

      console.log("checked boxes print -- ", checkedBoxes);

      if (checkedBoxes.length === 0) {
        console.log(" No sample is selected ---- ");
        alert("Please select a sample to download");
        return
      }

      const selectedPatients = [];
      const promises = [];

      // Create an array to hold all the row promises
      const rowPromises = [];

      checkedBoxes.forEach((checkbox) => {
        const row = checkbox.closest("tr");

        const bioBankId = row.getAttribute("data-bioBankId");
        const seqKey = row.getAttribute("data-seqKey");
        const timestampKey = row.getAttribute("data-timestampKey");
        const gridData = row.getAttribute("data-grid");

        // Fetch promises for each row
        const promise1 = db.ref(`sef/${bioBankId}/${seqKey}/${timestampKey}/`).once('value')
          .then(snapshot => snapshot.val() || {});

        const promise2 = db.ref(`Fw/${bioBankId}/`).limitToLast(1).once('value')
          .then(snapshot => {
            const fwdata = snapshot.val();
            console.log("fwdata - ", fwdata);
            let timestamp;
            let fwlastTimestamp;
            if (fwdata) {

              timestamp = Object.keys(fwdata)[0]; // Since we are limiting to last 1, there should be only one key
              const fwlastTimestamp = fwdata[timestamp]; // Get the lastTimestamp object using the key

              return { fwlastTimestamp, timestamp };
            }
            return { fwlastTimestamp, timestamp };
          });

        const promise3 = db.ref(`Os/${bioBankId}/${seqKey}`).limitToLast(1).once('value')
          .then(snapshot => {
            const osdata = snapshot.val();
            console.log("osdata -- ", osdata);
            let lastKey;

            if (osdata) {
              // Get the last key (timestamp) from the osdata
              lastKey = Object.keys(osdata)[0]; // Since we are limiting to last 1, there should be only one key
              const oslastTimestamp = osdata[lastKey]; // Get the lastTimestamp object using the key

              console.log('Last Timestamp in os :', oslastTimestamp, lastKey);

              // Check if lbi exists and loop through it
              if (oslastTimestamp && oslastTimestamp.lbi) {
                for (const box in oslastTimestamp.lbi) {
                  if (oslastTimestamp.lbi.hasOwnProperty(box)) {
                    const grids = oslastTimestamp.lbi[box];
                    if (grids.includes(gridData)) {
                      console.log(`Grid Data "${gridData}" found in "${box}":`, grids);
                      return { oslastTimestamp: oslastTimestamp, lastKey: lastKey }; // Return structured object
                    }
                  }
                }
              }
              return { oslastTimestamp: oslastTimestamp, lastKey: lastKey || {} }; // Return lastTimestamp or empty object if no match found
            } else {
              return {}; // Return empty object if osdata does not exist
            }
          });

        // Combine all three promises for the current row
        // Combine all three promises for the current row
        // Combine all three promises for the current row
        const rowPromise = Promise.all([promise1, promise2, promise3])
          .then(async ([sefData, fwData, osData]) => {
            // Wait for decodeGridValue to fully resolve
            const plasmaGrid = await decodeGridValue(sefData.ie.bpg);
            const serumGrid = await decodeGridValue(sefData.ie.bsg);
            const buffyCoatGrid = await decodeGridValue(sefData.ie.bbcg);
            const otherGrid = await decodeGridValue(sefData.ie.osg);
            const ftgGrid = await decodeGridValue(sefData.ie.ftg);
            const fngGrid = await decodeGridValue(sefData.ie.fng);
            const rltGrid = await decodeGridValue(sefData.ie.rlt);
            const pcGrid = await decodeGridValue(sefData.ie.pc);

            let oSgrid = "";
            console.log("osData",osData)
            if(osData !== null && Object.keys(osData).length!==0 ){
              const oSgridData = await formatOsData(osData.oslastTimestamp.lbi);
              oSgrid = await decodeOSGridValue(oSgridData);
            }
            else{
              oSgrid= "-";
            }
            // console.log("PlasmaGrid", osData);
            // console.log("PlasmaGrid", osData.oslastTimestamp);
            // console.log("PlasmaGrid", osData.oslastTimestamp.lbi);

            console.log("PlasmaGrid", oSgrid);

            console.log("PlasmaGrid", plasmaGrid);

            // Return the full row data with resolved plasmaGrid
            return {
              bioBankId,
              seqKey,
              timestampKey,
              sefData,
              fwData,
              osData,
              plasmaGrid,
              serumGrid,
              buffyCoatGrid,
              otherGrid,
              ftgGrid,
              fngGrid,
              rltGrid,
              pcGrid,
              oSgrid
            };
          });

        rowPromises.push(rowPromise);



      });

      // Process all rows once promises resolve
      Promise.all(rowPromises)
        .then((rowsData) => {
          console.log("All data fetched:", rowsData);

          const excelData = rowsData.map(row => ({

            Sample_Timestamp: formatTimestamp(row.timestampKey),
            bioBankId: row.bioBankId,
            Age: row.sefData.ie.ag || "-",
            Gender: decodeProcedureType(row.sefData.ie.sx) || "-",
            CancerType: decodeProcedureType(row.sefData.ie.ct) || "-",
            ProcedureType: decodeProcedureType(row.sefData.ie.tpr),
            DetailProcedure: row.sefData.ie.dpr || "-",
            SurgeonName: row.sefData.ie.srn || "-",
            BloodSample: decodeProcedureType(row.sefData.ie.bs) || "-",
            SpecimenSample: decodeProcedureType(row.sefData.ie.ss) || "-",
            OtherSample: decodeProcedureType(row.sefData.ie.osmp) || "-",
            RLTSample: decodeProcedureType(row.sefData.ie.rltS) || "-",
            PrimaryCultureSample: decodeProcedureType(row.sefData.ie.pcS) || "-",
            PlasmaGrid: row.plasmaGrid || "-",
            SerumGrid: row.serumGrid || "-",
            BuffyCoatGrid: row.buffyCoatGrid || "-",
            FTTubeGrids: row.ftgGrid || "-",
            FNTubeGrids: row.fngGrid || "-",
            OtherSample_description: row.sefData.ie.osdsc || "-",
            OtherSampleGrid: row.otherGrid || "-",
            RLTSampleGrid: row.rltGrid || "-",
            PrimarySampleGrid: row.pcGrid || "-",
            nact: decodeProcedureType(row.sefData.ie.nact) || "-",
            NACT_Drug_Cycles: row.sefData.ie.nactdc || "-",
            NACT_date_of_last_cycle: row.sefData.ie.nactdlc || "-",             
            IschemicSample: decodeProcedureType(row.sefData.ie.iss) || "-",
            ProcessedBy: row.sefData.ie.prb || "-",
            // SampleEntryUpdatedBy: row.sefData.ie.fng || "-",
            MetastasisSample: decodeProcedureType(row.sefData.ie.mts) || "-",
            Consent: decodeProcedureType(row.sefData.ie.cnst) || "-",//Math.floor()/ 1000
            SampleReceivedTime: formatTimestamp1(row.sefData.ie.srt) || "-",
            SampleProcessedTime: formatTimestamp1(row.sefData.ie.spt) || "-",
            BloodReceivedTime: formatTimestamp1(row.sefData.ie.brt) || "-",
            BloodProcessedTime: formatTimestamp1(row.sefData.ie.bpt) || "-",
            BloodSampleProcessedBy: row.sefData.ie.bsby || "-",
            SpecimenReceivedTime: formatTimestamp1(row.sefData.ie.sprt) || "-",
            SpecimenProcessedTime: formatTimestamp1(row.sefData.ie.sppt) || "-",
            SpecimenSampleProcessedby: row.sefData.ie.ssby || "-",
            OtherSampleReceivedTime: formatTimestamp1(row.sefData.ie.ospt) || "-",
            OtherSampleProcessedTime: formatTimestamp1(row.sefData.ie.osrt) || "-",
            OtherSampleProcessedby: row.sefData.ie.osby || "-",
            RLTSampleReceivedTime: formatTimestamp1(row.sefData.ie.rspt) || "-",
            RLTSampleProcessedTime: formatTimestamp1(row.sefData.ie.rsrt) || "-",
            RLTSampleProcessedby: row.sefData.ie.rltpb || "-",
            PrimaryCultureSampleReceivedTime: formatTimestamp1(row.sefData.ie.pspt) || "-",
            PrimaryCultureampleProcessedTime: formatTimestamp1(row.sefData.ie.psrt) || "-",
            PrimaryCultureSampleProcessedby: row.sefData.ie.psspb || "-",
            Initial_form_updatedby: row.sefData.ie.sef_ub || "-",

            FamilyHistoryCancer: decodeProcedureType(row.sefData.md.fhc),
            FamilyRelation: row.sefData.md.fhcr || "-",
            FamilyCancerType: row.sefData.md.fhct || "-",
            FoodHabbits: decodeProcedureType(row.sefData.md.fh) || "-",
            HistoryOfAlcoholConsumption: decodeProcedureType(row.sefData.md.hac) || "-",
            HistoryOfSmoking: decodeProcedureType(row.sefData.md.hs) || "-",
            ExistingComorbidities: decodeProcedureType(row.sefData.md.ec) || "-",
            ComorbidityandCorrespondingMedicationsforComorbidity: row.sefData.md.ecm || "-",
            FF_QC_comments: row.sefData.md.ffqc || "-",
            FF_Tissue_Remarks: row.sefData.md.ftr || "-",
            Tumor_Site: decodeProcedureType(row.sefData.md.tst) || "-",
            TumorPercentage: row.sefData.md.tp || "-",
            AgeAtDiagnosis: row.sefData.md.ad || "-",
            ClinicalStage: row.sefData.md.cs || "-",
            IHC_Marker_status: decodeProcedureType(row.sefData.md.ihcm) || "-",
            IHC_marker_description: row.sefData.md.ihcd || "-",
            Genetic_Testing: decodeProcedureType(row.sefData.md.gt) || "-",
            Genetic_Testing_Description: row.sefData.md.gtd || "-",
            Pathologic_Subtype: decodeProcedureType(row.sefData.md.pst) || "-",
            Grade: row.sefData.md.gd || "-",
            Focality: row.sefData.md.fc === "true" ? "Unifocal" : row.sefData.md.fc === "false" ? "Multifocal" : "-",
            LVI: decodeProcedureType(row.sefData.md.lvi) || "-",
            PNI: decodeProcedureType(row.sefData.md.pni) || "-",
            pTNM: row.sefData.md.ptnm || "-",
            AJCCStaging: row.sefData.md.as || "-",
            NumberOfNodesTested: row.sefData.md.nnt || "-",
            NumberOfPositiveNodes: row.sefData.md.npn || "-",
            TumorSize: row.sefData.md.tsz || "-",
            Denovo_metastasis: decodeProcedureType(row.sefData.md.dm) || "-",
            Metastasis_Post_Treatment: decodeProcedureType(row.sefData.md.mpt) || "-",
            BiopsyTissueNumber: row.sefData.md.btn || "-",
            BiopsyDate: row.sefData.md.bd || "-",
            Surgery_Tissue_Number_HPE: row.sefData.md.stn || "-",
            SurgeryDate: row.sefData.md.sd || "-",
            RCBScore: row.sefData.md.rcbs || "-",
            RCBClass: row.sefData.md.rcbc || "-",
            ACT: decodeProcedureType(row.sefData.md.act) || "-",
            ACT_Drug_Cycles: row.sefData.md.actdc || "-",
            ACT_Date_of_last_Cycle: row.sefData.md.actdls || "-",
            Radiotherapy: decodeProcedureType(row.sefData.md.rd) || "-",
            Radiotherapy_details: row.sefData.md.rdd || "-",
            RT_date_of_last_cycle: row.sefData.md.rtdls || "-",
            ParaffinBlockAvailable: decodeProcedureType(row.sefData.md.ipba) || "-",
            ParaffinBlockNumber: row.sefData.md.ipbainfo || "-",
            Metadata_updated_by: row.sefData.md.mdu || "-",

            AgeOfMenarche: row.sefData.brf.am || "-",
            Parity: row.sefData.brf.pty || "-",
            NoOfChildren: row.sefData.brf.noc || "-",
            AgeAtFirstChild: row.sefData.brf.afc || "-",
            Breastfed: decodeProcedureType(row.sefData.brf.bf) || "-",
            DurationBreastfeeding: row.sefData.brf.dbf || "-",
            MenopausalStatus: row.sefData.brf.ms || "-",
            //ER: decodeProcedureType(row.sefData.brf.er) || "-",
            ER: decodeProcedureType(row.sefData.brf.er)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            PR: decodeProcedureType(row.sefData.brf.pr)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            HER2: decodeProcedureType(row.sefData.brf.h2)?.toLowerCase() === "yes" ? "Positive" : "Negative" || "-",
            Subtype: row.sefData.brf.sbt || "-",
            Ki67: row.sefData.brf.k67 || "-",
            // ClinicalStage_Brf: row.sefData.brf.cs || "-",
            BIRADS_score: row.sefData.brf.ht || "-",
            sTILsPercentScores: row.sefData.brf.sps || "-",
            BR_form_updated_By: row.sefData.brf.brfu || "-",

            followUpTime: getValue(formatTimestamp(Math.floor(row.fwData?.timestamp) / 1000)) || "-",
            LastFollowUpDate: getValue(row.fwData?.fwlastTimestamp?.dd) || "-",
            LastFollowUpStatus: getValue(row.fwData?.fwlastTimestamp?.lfs) || "-",
            VitalStatus: getValue(row.fwData?.fwlastTimestamp?.vs) || "-",
            RecurrenceDate: getValue(row.fwData?.fwlastTimestamp?.rd) || "-",
            Reported_Date_for_Progressive_Disease: getValue(row.fwData?.fwlastTimestamp?.rdpd) || "-",
            Progression_metastasis_remark: getValue(row.fwData?.fwlastTimestamp?.pet) || "-",
            Reason_For_lost_to_follow_up: getValue(row.fwData?.fwlastTimestamp?.rlfw) || "-",
            Other_reason: getValue(row.fwData?.fwlastTimestamp?.othrs) || "-",
            Death_date: getValue(row.fwData?.fwlastTimestamp?.dd) || "-",
            Remarks: getValue(row.fwData?.fwlastTimestamp?.rmks) || "-",
            followUp_updated_by: getValue(row.fwData?.fwlastTimestamp?.fw_ub) || "-",


            SharedTime: getValue(formatTimestamp(row.osData?.lastKey)) || "-",
            Shared_date: getValue(row.osData?.oslastTimestamp?.doe) || "-",
            Shared_Grid: row.oSgrid,
            institute_or_Department: getValue(row.osData?.oslastTimestamp?.dpt) || "-",
            project: getValue(row.osData?.oslastTimestamp?.prj) || "-",
            PI_of_the_project: getValue(row.osData?.oslastTimestamp?.pip) || "-",
            Shared_status: getValue(row.osData?.oslastTimestamp?.ossts) || "-",
            Partial_shared_remark: getValue(row.osData?.oslastTimestamp?.psr) || "-",
            Shared_form_updated_by: getValue(row.osData?.oslastTimestamp?.os_ub) || "-"


          }));

          // Export to Excel
          const worksheet = XLSX.utils.json_to_sheet(excelData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "BioBank Data");

          // Download the Excel file
          XLSX.writeFile(workbook, "BioBank_Data.xlsx");
        })
        .catch(error => {
          console.error("Error fetching data:", error);
        });


    });


    window.onload = function () {
      //localStorage.removeItem("sampleTypeInput");
      localStorage.setItem("sampleTypeInput", "All");

    }



    function getValue(value) {
      return value !== undefined && value !== null ? value : "-";
    }


    const TypeMapping = {
      b: "Biopsy",
      r: "Resection",
      Y: "Yes",
      N: "No",
      true: "Yes",
      false: "No",
      brst: "Breast",
      F: "Female",
      M: "Male",
      BL: "Bilateral",
      R: "Right",
      L: "Left",
      option1: "No residual invasive carcinoma",
      option2: "Invasive carcinoma of no special type(ductal)",
      option3: "Micro - invasive carcinoma",
      option4: "Invasive lobular carcinoma",
      option5: "Invasive carcinoma with mixed ductal and lobular features",
      option6: "Invasive carcinoma with features of(specify)",
      option7: "Tubular carcinoma",
      option8: "Invasive cribriform carcinoma",
      option9: "Mucinous carcinoma",
      option10: "Invasive micropapillary carcinoma",
      option11: "Apocrine adenocarcinoma",
      option12: "Metaplastic carcinoma",
      option13: "Encapsulated papillary carcinoma with invasion",
      option14: "Solid papillary carcinoma with invasion",
      option15: "Intraductal papillary adenocarcinoma with invasion",
      option16: "Adenoid cystic carcinoma",
      option17: "Neuroendocrine tumor",
      option18: "Neuroendocrine carcinoma",
      option19: "Invasive carcinoma, type cannot be determined:",
      other: "Other histologic type not listed(specify)",
      s: "Shared",
      ps: "Partially Shared",
      // Add more mappings as needed
    };

    function decodeProcedureType(encodedValue) {
      return TypeMapping[encodedValue] || "-"; // Fallback to 'Unknown' if the value is not in the mapping
    }

    function decodeGridValue(gridValue) {
      return new Promise((resolve, reject) => {
        if (gridValue) {
          let parts = gridValue.split('/');
          let boxName = parts[0];

          const storedBnData = JSON.parse(localStorage.getItem('bnData'));
          // console.log("storedBnData", storedBnData);
          // console.log("boxName", boxName);

          // Use find to search for the boxName in the array of objects
          const boxEntry = storedBnData.find((entry) => entry.id === boxName);

          if (boxEntry) {
            parts[0] = boxEntry.name;  // Replace the ID with the corresponding name
            const updatedGridNo = parts.join('/');
            // console.log("updatedGridNo", updatedGridNo);
            resolve(updatedGridNo);
          } else {
            resolve(gridValue); // If no match found, resolve with the original value
          }
        } else {
          resolve(null); // If gridValue is null or undefined, resolve with null
        }
      });
    }

    async function formatOsData(lib) {
      let result = [];
      console.log("lib", lib)
      if (lib) {
        for (let key in lib) {
          if (lib[key] && Array.isArray(lib[key])) {
            let formattedValue = `${key}/${lib[key].join(',')}`;
            result.push(formattedValue);
          }
        }
      }

      return result.join('; ');
    }

    function decodeOSGridValue(gridValue) {
      return new Promise((resolve, reject) => {
        if (gridValue) {
          let gridParts = [];
          let processedGridParts = [];

          if (gridValue.includes(';')) {
            gridParts = gridValue.split('; ');
            const storedBnData = JSON.parse(localStorage.getItem('bnData'));
            // console.log("storedBnData", storedBnData);

            gridParts.forEach((part) => {
              let parts = part.split('/');
              let boxName = parts[0];

              const boxEntry = storedBnData.find((entry) => entry.id === boxName);

              if (boxEntry) {
                parts[0] = boxEntry.name;
                const updatedGridNo = parts.join(': ');
                processedGridParts.push(updatedGridNo);
              } else {
                processedGridParts.push(part);
              }
            });

            resolve(processedGridParts.join('; '));
          }
          else {
            gridParts = gridValue;
            let parts = gridValue.split('/');
            let boxName = parts[0];

            const storedBnData = JSON.parse(localStorage.getItem('bnData'));
            console.log("storedBnData", storedBnData);
            console.log("boxName", boxName);

            // Use find to search for the boxName in the array of objects
            const boxEntry = storedBnData.find((entry) => entry.id === boxName);

            if (boxEntry) {
              parts[0] = boxEntry.name;  // Replace the ID with the corresponding name
              const updatedGridNo = parts.join(': ');
              console.log("updatedGridNo", updatedGridNo);
              resolve(updatedGridNo);
            } else {
              resolve(gridValue); // If no match found, resolve with the original value
            }
          }
        } else {
          resolve(null);
        }
      });
    }

    function formatTimestamp(unixTimestamp) {
      if (!unixTimestamp || isNaN(unixTimestamp)) {
        return "-"; // Return '-' if the input is invalid
      }

      // Determine if the timestamp is in seconds or milliseconds
      const timestamp =
        unixTimestamp > 9999999999 ? unixTimestamp : unixTimestamp * 1000;

      const date = new Date(timestamp); // Create a Date object

      const day = String(date.getDate()).padStart(2, "0"); // Get day with leading zero
      const month = String(date.getMonth() + 1).padStart(2, "0"); // Get month (0-based, so +1) with leading zero
      const year = String(date.getFullYear()).slice(-2); // Get last 2 digits of the year

      const hours = String(date.getHours()).padStart(2, "0"); // Get hours with leading zero
      const minutes = String(date.getMinutes()).padStart(2, "0"); // Get minutes with leading zero

      return `${day}-${month}-${year} ${hours}:${minutes}`; // Format as DD-MM-YY HH:MM
    }


    function formatTimestamp1(timestamp) {
      // Check if the timestamp is a valid number
      if (!timestamp || isNaN(timestamp)) {
        return "-";
      }

      // Convert timestamp to Date object
      const date = new Date(timestamp);

      // Check if the Date object is valid
      if (isNaN(date.getTime())) {
        return "-";
      }

      // Format date and time components
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");

      // Combine into the desired format
      return `${day}-${month}-${year} ${hours}:${minutes}`;
    }

    // function generateExcelData() {
    //   const dataToExport = [];
    //   let count = 0;

    //   const patients =
    //     filteredPatientData && Object.keys(filteredPatientData).length ? filteredPatientData : window.patientData;
    //   const currentTimestamp = Math.floor(Date.now() / 1000);

    //   Object.keys(patients).forEach((bioBankId) => {
    //     const patientSeq = patients[bioBankId];

    //     let latestSample = null;
    //     let latestFollowUp = null;
    //     let osSharedData = null;
    //     console.log("patientSeq", patientSeq);

    //     // Iterate through the sample entry form (Sef) data
    //     if (patientSeq) {
    //       Object.keys(patientSeq).forEach((seqKey) => {
    //         const sampleData = patientSeq[seqKey];
    //         Object.keys(sampleData).forEach((timestampKey) => {
    //           const sample = sampleData[timestampKey];
    //           if (!latestSample || timestampKey > latestSample.timestamp) {

    //             const gridData = (gridValue) => {
    //               return new Promise((resolve) => {
    //                 const gridVal = gridValue;
    //                 if (gridVal) {
    //                   let parts = gridVal.split('/');
    //                   let boxName = parts[0];
    //                   db.ref(`bn/`).once('value').then(snapshot => {
    //                     let boxIDs = snapshot.val();
    //                     const boxEntry = Object.entries(boxIDs).find(([id, name]) => name === boxName);
    //                     if (boxEntry) {
    //                       const [id] = boxEntry;
    //                       parts[0] = id;
    //                       const updatedgridNo = parts.join('/');
    //                       console.log("updatedgridNo", updatedgridNo);
    //                       resolve(updatedgridNo);
    //                     }
    //                     else {
    //                       resolve(gridVal); // If no match found, resolve with original value
    //                     }
    //                   });
    //                 }
    //                 else {
    //                   resolve(null); // If invalid or empty, resolve with null
    //                 }
    //               });
    //             };

    //             const plasmagrid = gridData(sample.ie.bpg);
    //             // const Serumgrid = gridData('SerumgridNo');
    //             // const buffyCoatgrid = gridData('bufferCoatgridNo');
    //             // const ftSgrid = gridData('ftgrid');
    //             // const fnSgrid = gridData('fngrid');

    //             latestSample = {
    //               SefTimestamp: formatTimestamp(timestampKey),
    //               BioBankID: bioBankId,
    //               Age: sample.ie.ag || "-",
    //               Gender: decodeProcedureType(sample.ie.sx) || "-",
    //               CancerType: decodeProcedureType(sample.ie.ct) || "-",
    //               ProcedureType: decodeProcedureType(sample.ie.tpr),
    //               DetailProcedure: sample.ie.dpr || "-",
    //               SurgeonName: sample.ie.srn || "-",
    //               BloodSample: decodeProcedureType(sample.ie.bs) || "-",
    //               SpecimenSample: decodeProcedureType(sample.ie.ss) || "-",
    //               OtherSample: decodeProcedureType(sample.ie.osmp) || "-",
    //               PlasmaGrid: plasmagrid || "-",
    //               SerumGrid: sample.ie.bsg || "-",
    //               BuffyCoatGrid: sample.ie.bbcg || "-",
    //               FTTubeGrids: sample.ie.ftg || "-",
    //               FNTubeGrids: sample.ie.fng || "-",
    //               OtherSample_description: sample.ie.osdsc || "-",
    //               OtherSampleGrid: sample.ie.osg || "-",
    //               IschemicSample: decodeProcedureType(sample.ie.iss) || "-",
    //               ProcessedBy: sample.ie.prb || "-",
    //               SampleEntryUpdatedBy: sample.ie.fng || "-",
    //               MetastasisSample: decodeProcedureType(sample.ie.mts) || "-",
    //               Consent: decodeProcedureType(sample.ie.cnst) || "-",
    //               SampleReceivedTime: formatTimestamp(sample.ie.srt) || "-",
    //               SampleProcessedTime: formatTimestamp(sample.ie.spt) || "-",
    //               BloodReceivedTime: formatTimestamp(sample.ie.brt) || "-",
    //               BloodProcessedTime: formatTimestamp(sample.ie.bpt) || "-",
    //               BloodSampleProcessedBy: sample.ie.bsby || "-",
    //               SpecimenReceivedTime: formatTimestamp(sample.ie.sprt) || "-",
    //               SpecimenProcessedTime: formatTimestamp(sample.ie.sppt) || "-",
    //               SpecimenSampleProcessedby: sample.ie.ssby || "-",
    //               OtherSampleReceivedTime: formatTimestamp(sample.ie.ospt) || "-",
    //               OtherSampleProcessedTime: formatTimestamp(sample.ie.osrt) || "-",
    //               OtherSampleProcessedby: sample.ie.osby || "-",

    //               FamilyHistoryCancer: decodeProcedureType(sample.md.fhc),
    //               FamilyRelation: sample.md.fhcr || "-",
    //               FamilyCancerType: sample.md.fhct || "-",
    //               FoodHabbits: decodeProcedureType(sample.md.fh) || "-",
    //               HistoryOfAlcoholConsumption: decodeProcedureType(sample.md.hac) || "-",
    //               HistoryOfSmoking: decodeProcedureType(sample.md.hs) || "-",
    //               ExistingComorbidities: decodeProcedureType(sample.md.ec) || "-",
    //               ComorbidityandCorrespondingMedicationsforComorbidity: sample.md.ecm || "-",
    //               FF_QC_comments: sample.md.ffqc || "-",
    //               FF_Tissue_Remarks: sample.md.ftr || "-",
    //               Tumor_Site: sample.md.tst || "-",
    //               TumorPercentage: sample.md.tp || "-",
    //               AgeAtDiagnosis: sample.md.ad || "-",
    //               ClinicalStage: sample.md.cs || "-",
    //               IHC_Marker_status: decodeProcedureType(sample.md.ihcm) || "-",
    //               IHC_marker_description: sample.md.ihcd || "-",
    //               Genetic_Testing: decodeProcedureType(sample.md.gt) || "-",
    //               Genetic_Testing_Description: sample.md.gtd || "-",
    //               Pathologic_Subtype: decodeProcedureType(sample.md.pst) || "-",
    //               Grade: sample.md.gd || "-",
    //               Focality: sample.md.fc === "Y" ? "Unifocal" : sample.md.fc === "N" ? "Multifocal" : "-",
    //               LVI: decodeProcedureType(sample.md.lvi) || "-",
    //               PNI: decodeProcedureType(sample.md.pni) || "-",
    //               pTNM: sample.md.ptnm || "-",
    //               AJCCStaging: sample.md.as || "-",
    //               NumberOfNodesTested: sample.md.nnt || "-",
    //               NumberOfPositiveNodes: sample.md.npn || "-",
    //               TumorSize: sample.md.tsz || "-",
    //               Denovo_metastasis: decodeProcedureType(sample.md.dm) || "-",
    //               Metastasis_Post_Treatment: decodeProcedureType(sample.md.mpt) || "-",
    //               BiopsyTissueNumber: sample.md.btn || "-",
    //               BiopsyDate: sample.md.bd || "-",
    //               nact: decodeProcedureType(sample.md.nact) || "-",
    //               NACT_Drug_Cycles: sample.md.nactdc || "-",
    //               NACT_date_of_last_cycle: sample.md.nactdlc || "-",
    //               Surgery_Tissue_Number_HPE: sample.md.stn || "-",
    //               SurgeryDate: sample.md.sd || "-",
    //               RCBScore: sample.md.rcbs || "-",
    //               ACT: decodeProcedureType(sample.md.act) || "-",
    //               ACT_Drug_Cycles: sample.md.actdc || "-",
    //               ACT_Date_of_last_Cycle: sample.md.actdls || "-",
    //               Radiotherapy: decodeProcedureType(sample.md.rd) || "-",
    //               Radiotherapy_details: sample.md.rdd || "-",
    //               RT_date_of_last_cycle: sample.md.rtdls || "-",
    //               ParaffinBlockAvailable: decodeProcedureType(sample.md.ipba) || "-",
    //               Metadata_updated_by: sample.md.mdu || "-",

    //               AgeOfMenarche: sample.brf.am || "-",
    //               Parity: sample.brf.pty || "-",
    //               NoOfChildren: sample.brf.noc || "-",
    //               AgeAtFirstChild: sample.brf.afc || "-",
    //               Breastfed: decodeProcedureType(sample.brf.bf) || "-",
    //               DurationBreastfeeding: sample.brf.dbf || "-",
    //               MenopausalStatus: sample.brf.ms || "-",
    //               ER: decodeProcedureType(sample.brf.er) || "-",
    //               PR: decodeProcedureType(sample.brf.pr) || "-",
    //               HER2: decodeProcedureType(sample.brf.h2) || "-",
    //               Subtype: sample.brf.sbt || "-",
    //               Ki67: sample.brf.k67 || "-",
    //               ClinicalStage_Brf: sample.brf.cs || "-",
    //               HistologicalType: sample.brf.ht || "-",
    //               sTILsPercentScores: sample.brf.sps || "-",
    //               BR_form_updated_By: sample.brf.brfu || "-",
    //             };
    //           }
    //           console.log("latestSample.FamilyHistoryCancer", decodeProcedureType(sample.md.fhc), " bioBankId", bioBankId);

    //         });
    //       });
    //       console.log("latestSample of ie", latestSample.FamilyHistoryCancer)

    //     }


    //     // Fetch follow-up data from the Firebase reference `Fw/{bioBankId}`
    //     db.ref(`Fw/${bioBankId}`)
    //       .once("value")
    //       .then((snapshot) => {
    //         const followUpData = snapshot.val();
    //         console.log("followUpData", followUpData);

    //         if (followUpData) {
    //           Object.keys(followUpData).forEach((timestampKey) => {
    //             const followUp = followUpData[timestampKey];
    //             if (
    //               !latestFollowUp ||
    //               timestampKey > latestFollowUp.timestamp
    //             ) {
    //               latestFollowUp = {
    //                 BioBankID: bioBankId,
    //                 LastFollowUpStatus: followUp.lfs || "-",
    //                 LastFollowUpDate: followUp.lfd || "-",
    //                 VitalStatus: followUp.vs || "-",
    //                 RecurrenceDate: followUp.rd || "-",
    //                 Remarks: followUp.rmks || "-",
    //                 Timestamp: formatTimestamp(timestampKey / 1000),
    //               };
    //             }
    //           });
    //         } else {
    //           latestFollowUp = {
    //             BioBankID: bioBankId,
    //             LastFollowUpStatus: "-",
    //             LastFollowUpDate: "-",
    //             VitalStatus: "-",
    //             RecurrenceDate: "-",
    //             Remarks: "-",
    //             Timestamp: "-",
    //           };
    //         }

    //         // Fetch `Os (Shared)` data from the Firebase reference `Os (Shared)/{bioBankId}`
    //         return db.ref(`Os/${bioBankId}`).once("value");
    //       })
    //       .then((osSharedSnapshot) => {
    //         const osShared = osSharedSnapshot.val();
    //         if (osShared) {
    //           // Fetch the latest sequence, such as 's1', 's2', etc.
    //           const latestSeq = osShared[Object.keys(osShared).sort().pop()];

    //           // Get the latest timestamp from the sequence
    //           const latestTimestamp =
    //             latestSeq && latestSeq[Object.keys(latestSeq).sort().pop()];
    //           if (latestTimestamp) {
    //             osSharedData = {
    //               Department: latestTimestamp.dpt || "-",
    //               Project: latestTimestamp.prj || "-",
    //               PI: latestTimestamp.pip || "-",
    //               SharedFormUpdatedBy: latestTimestamp.os_ub || "-",
    //               SampleIdentifiers: latestTimestamp.lbi || "-",
    //               OutsourceStatus: decodeProcedureType(latestTimestamp.ossts) || "-",
    //               OsTimestamp: latestTimestamp.doe || "-",
    //             };
    //           }
    //           console.log("osSharedData", osSharedData);
    //         }
    //         console.log("osSharedData", osSharedData);
    //         const nonDashCounts = [
    //           latestSample?.PlasmaGrid,
    //           latestSample?.SerumGrid,
    //           latestSample?.BuffyCoatGrid,
    //           latestSample?.FTTubeGrids,
    //           latestSample?.FNTubeGrids,
    //           latestSample?.OtherSample_description,
    //         ].filter((field) => field !== "-").length;
    //         console.log("nonDashCounts", nonDashCounts)

    //         for (let i = 0; i < nonDashCounts; i++) {
    //           const rowData = {
    //             Timestamp: latestSample?.SefTimestamp,
    //             BioBankID: bioBankId,
    //             Age: latestSample?.Age || "-",
    //             Gender: latestSample?.Gender || "-",
    //             CancerType: latestSample?.CancerType || "-",
    //             ProcedureType: latestSample?.ProcedureType || "-",
    //             DetailProcedure: latestSample?.DetailProcedure || "-",
    //             SurgeonName: latestSample?.SurgeonName || "-",
    //             BloodSample: latestSample?.BloodSample || "-",
    //             SpecimenSample: latestSample?.SpecimenSample || "-",
    //             OtherSample: latestSample?.OtherSample || "-",
    //             PlasmaGrid: latestSample?.PlasmaGrid || "-",
    //             SerumGrid: latestSample?.SerumGrid || "-",
    //             BuffyCoatGrid: latestSample?.BuffyCoatGrid || "-",
    //             OtherSampleGrid: latestSample?.OtherSampleGrid || "-",
    //             NumberOfFTTubes: latestSample?.NumberOfFTTubes || "-", // FT Tubes
    //             FTTubeGrids: latestSample?.FTTubeGrids || "-", // FT tube grids
    //             NumberOfFNTubes: latestSample?.NumberOfFNTubes || "-", // FN Tubes
    //             FNTubeGrids: latestSample?.FNTubeGrids || "-", // FN tube grids
    //             OtherSample_description: latestSample?.OtherSample_description || "-",
    //             IschemicSample: latestSample?.IschemicSample || "-", // Ischemic sample
    //             ProcessedBy: latestSample?.ProcessedBy || "-", // Processed By
    //             SampleEntryUpdatedBy: latestSample?.SampleEntryUpdatedBy || "-", // Updated By
    //             MetastasisSample: latestSample?.MetastasisSample || "-", // Metastasis sample
    //             Consent: latestSample?.Consent || "-", // Consent
    //             SampleReceivedTime: latestSample?.SampleReceivedTime || "-",
    //             SampleProcessedTime: latestSample?.SampleProcessedTime || "-",
    //             SpecimenSampleProcessedby: latestSample?.SpecimenSampleProcessedby || "-",
    //             BloodReceivedTime: latestSample?.BloodReceivedTime || "-",
    //             BloodProcessedTime: latestSample?.BloodProcessedTime || "-",
    //             BloodSampleProcessedBy: latestSample?.BloodSampleProcessedBy || "-",
    //             SpecimenReceivedTime: latestSample?.SpecimenReceivedTime || "-",
    //             SpecimenProcessedTime: latestSample?.SpecimenProcessedTime || "-",
    //             OtherSampleProcessedby: latestSample?.OtherSampleProcessedby || "-",
    //             OtherSampleReceivedTime: latestSample?.OtherSampleReceivedTime || "-",
    //             OtherSampleProcessedTime: latestSample?.OtherSampleProcessedTime || "-",

    //             FamilyHistoryCancer: latestSample.FamilyHistoryCancer || "-",
    //             FamilyRelation: latestSample?.FamilyRelation || "-",
    //             FamilyCancerType: latestSample?.FamilyCancerType || "-",
    //             FoodHabbits: latestSample?.FoodHabbits || "-",
    //             HistoryOfAlcoholConsumption: latestSample?.HistoryOfAlcoholConsumption || "-",
    //             HistoryOfSmoking: latestSample?.HistoryOfSmoking || "-",
    //             ExistingComorbidities: latestSample?.ExistingComorbidities || "-",
    //             ComorbidityDetails: latestSample?.ComorbidityDetails || "-",
    //             FF_QC_comments: latestSample?.FF_QC_comments || "-",
    //             FF_Tissue_Remarks: latestSample?.FF_Tissue_Remarks || "-",
    //             Tumor_Site: latestSample?.Tumor_Site || "-",
    //             TumorPercentage: latestSample?.TumorPercentage || "-",
    //             AgeAtDiagnosis: latestSample?.AgeAtDiagnosis || "-",
    //             ClinicalStage: latestSample?.ClinicalStage || "-",
    //             IHC_Marker_status: latestSample?.IHC_Marker_status || "-",
    //             IHC_marker_description: latestSample?.IHC_marker_description || "-",
    //             Genetic_Testing: latestSample?.Genetic_Testing || "-",
    //             Genetic_Testing_Description: latestSample?.Genetic_Testing_Description || "-",
    //             Pathologic_Subtype: latestSample?.Pathologic_Subtype || "-",
    //             Grade: latestSample?.Grade || "-",
    //             Focality: latestSample?.Focality || "-",
    //             LVI: latestSample?.LVI || "-",
    //             PNI: latestSample?.PNI || "-",
    //             pTNM: latestSample?.pTNM || "-",
    //             AJCCStaging: latestSample?.AJCCStaging || "-",
    //             NumberOfNodesTested: latestSample?.NumberOfNodesTested || "-",
    //             NumberOfPositiveNodes: latestSample?.NumberOfPositiveNodes || "-",
    //             TumorSize: latestSample?.TumorSize || "-",
    //             Denovo_metastasis: latestSample?.Denovo_metastasis || "-",
    //             Metastasis_Post_Treatment: latestSample?.Metastasis_Post_Treatment || "-",
    //             BiopsyTissueNumber: latestSample?.BiopsyTissueNumber || "-",
    //             BiopsyDate: latestSample?.BiopsyDate || "-",
    //             NACT: latestSample?.nact || "-",
    //             NACT_Drug_Cycles: latestSample?.NACT_Drug_Cycles || "-",
    //             NACT_date_of_last_cycle: latestSample?.NACT_date_of_last_cycle || "-",
    //             Surgery_Tissue_Number_HPE: latestSample?.Surgery_Tissue_Number_HPE || "-",
    //             SurgeryDate: latestSample?.SurgeryDate || "-",
    //             RCBScore: latestSample?.RCBScore || "-",
    //             ACT: latestSample?.ACT || "-",
    //             ACT_Drug_Cycles: latestSample?.ACT_Drug_Cycles || "-",
    //             ACT_Date_of_last_Cycle: latestSample?.ACT_Date_of_last_Cycle || "-",
    //             Radiotherapy: latestSample?.Radiotherapy || "-",
    //             Radiotherapy_details: latestSample?.Radiotherapy_details || "-",
    //             RT_date_of_last_cycle: latestSample?.RT_date_of_last_cycle || "-",
    //             ParaffinBlockAvailable: latestSample?.ParaffinBlockAvailable || "-",
    //             Metadata_updated_by: latestSample?.Metadata_updated_by || "-",

    //             AgeOfMenarche: latestSample?.AgeOfMenarche || "-",
    //             Parity: latestSample?.Parity || "-",
    //             NoOfChildren: latestSample?.NoOfChildren || "-",
    //             AgeAtFirstChild: latestSample?.AgeAtFirstChild || "-",
    //             Breastfed: latestSample?.Breastfed || "-",
    //             DurationBreastfeeding: latestSample?.DurationBreastfeeding || "-",
    //             MenopausalStatus: latestSample?.MenopausalStatus || "-",
    //             ER: latestSample?.ER || "-",
    //             PR: latestSample?.PR || "-",
    //             HER2: latestSample?.HER2 || "-",
    //             Subtype: latestSample?.Subtype || "-",
    //             Ki67: latestSample?.Ki67 || "-",
    //             ClinicalStage_Brf: latestSample?.ClinicalStage || "-", // To avoid duplicate field name
    //             HistologicalType: latestSample?.HistologicalType || "-",
    //             sTILsPercentScores: latestSample?.sTILsPercentScores || "-",
    //             BR_form_updated_By: latestSample?.BR_form_updated_By || "-",

    //             LastFollowUpStatus: latestFollowUp?.LastFollowUpStatus || "-",
    //             LastFollowUpDate: latestFollowUp?.LastFollowUpDate || "-",
    //             VitalStatus: latestFollowUp?.VitalStatus || "-",
    //             RecurrenceDate: latestFollowUp?.RecurrenceDate || "-",
    //             Remarks: latestFollowUp?.Remarks || "-",
    //             LatestFollowUpTimestamp: latestFollowUp?.Timestamp || "-",

    //             OsTimestamp: osSharedData?.OsTimestamp || "-",
    //             Department: osSharedData?.Department || "-",
    //             Project: osSharedData?.Project || "-",
    //             PI: osSharedData?.PI || "-",
    //             SharedFormUpdatedBy: osSharedData?.SharedFormUpdatedBy || "-",
    //             SampleIdentifiers: osSharedData?.SampleIdentifiers || "-",
    //             OutsourceStatus: osSharedData?.OutsourceStatus || "-",
    //           };

    //           dataToExport.push(rowData);
    //         }
    //         count++;


    //         console.log("count", count)
    //         console.log("patients length", Object.keys(patients).length)
    //         if (count === Object.keys(patients).length) {
    //           const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    //           console.log("worksheet", worksheet)
    //           const workbook = XLSX.utils.book_new();
    //           XLSX.utils.book_append_sheet(workbook, worksheet, "Biobank_Samples");
    //           const excelFileName = `Biobank_Samples_${currentTimestamp}.xlsx`;
    //           XLSX.writeFile(workbook, excelFileName);
    //         }
    //       })
    //   });
    // }

    function exportToExcel(blob, filename) {
      if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(blob, filename);
      } else {
        const url = window.URL.createObjectURL(blob);
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.href = url;
        a.download = filename;
        a.click();
      }
    }
  </script>
  <script>
    function checkBox() {
      if ($("#selectAll").is(":checked")) {
        $(".selection").prop("checked", true);
      } else {
        $(".selection").prop("checked", false);
      }
    }

    $("#selectAll").change(function () {
      checkBox();
    });

    $(".selection").change(function () {
      if (!$(this).is(":checked")) {
        $("#selectAll").prop("checked", false);
      }
    });
  </script>
</body>

</html>
