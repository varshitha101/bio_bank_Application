<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bio Bank | Search</title>
    <link rel="icon" type="image/png" href="assets/images/main_logo.png" />
    <!-- Google Fonts and Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/style.css" />

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Replace XLSX script with ExcelJS -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <link rel="stylesheet" href="assets/css/search.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="index.js"></script>
    <style>
      .navbar-image-logo2 {
        position: fixed; /* pin to viewport */
        top: 0.4167vw;
        left: 0.4167vw;
        width: 5.208vw;
        height: 5vw;
        background-color: #ffffff00; /* White background */
      }
    </style>
  </head>

  <body data-page="search">
    <img class="navbar-image-logo2" src="assets/images/bio_bank_option1.png" />
    <nav class="navbar sticky-top navbar-expand-lg navbar-light" style="background-color: rgba(25, 145, 201, 1); width: 500px; margin: 0 auto">
      <div class="container-fluid">
        <div class="mx-auto p-2">
          <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
              <a class="nav-link" href="statistics.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="home.html">Sample</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Search</a>
            </li>
            <li class="nav-item position-relative">
              <a class="nav-link" href="todo.html">To-Do list <span id="todoBadge" class="badge badge-pill badge-danger todo-badge">0</span></a>
            </li>
          </ul>
        </div>
        <div id="loading" class="spinmodal" style="display: none">
          <!-- Initially hidden -->
          <div class="spinmodal-content">
            <div class="row">
              <div class="col-4">
                <div class="spinner"></div>
                <!-- Spinner circle -->
              </div>
              <div class="col-8">
                <h3 style="align-content: center; padding-top: 20px">Loading...</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div
      class="d-flex ms-auto align-items-center justify-content-center"
      style="position: absolute; top: 8px; right: 8px; z-index: 2000; pointer-events: auto; background-color: rgba(25, 145, 201, 1); width: 50px; height: 50px">
      <button
        onclick="logout()"
        id="logout"
        type="button"
        class="btn btn-link p-0 w-100 h-100 d-flex align-items-center justify-content-center"
        aria-label="Logout"
        title="Logout"
        style="line-height: 1">
        <span class="material-icons text-white" style="font-size: 28px">logout</span>
      </button>
    </div>
    <div class="wrapper">
      <div class="container" style="margin-top: 30px">
        <div class="row" style="justify-content: space-around; margin-bottom: 10px; margin-bottom: 20px">
          <div>
            <a href="#collapseExample" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapseExample" id="individualSearchBtn"> Individual Search </a>
          </div>
          <div>
            <a href="#collapseExample1" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapseExample1" id="sampleSearchBtn"> Sample Search </a>
          </div>
        </div>
        <div class="collapse" id="collapseExample">
          <div class="card card-body">
            <form id="individualSearchForm" onsubmit="return searchPatient(event);">
              <div class="row" style="justify-content: center">
                <div class="form-group col-md-2">
                  <label for="bioInput">Patient Biobank ID</label>
                  <input type="text" class="form-control" id="bioInput" placeholder="Enter Biobank ID" />
                </div>
                <div class="form-group col-md-1">
                  <label for="searchBtn">Search</label>
                  <button type="submit" class="btn btn-primary">Submit</button>
                </div>
              </div>
            </form>
          </div>
          <div class="container mt-2">
            <div style="display: flex; align-items: center; justify-content: space-between">
              <p style="margin: 0; font-weight: bold">
                Show<span>
                  <select id="entriesInput1" class="btn" style="margin-left: 5px; width: 50px; border: rgb(177, 211, 243) solid 0.18rem; padding: 2px">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                </span>
                entries
              </p>
              <div>
                <div class="row" style="justify-content: center">
                  <button type="button" id="download1" class="btn btn-success mr-2" style="display: none">Download</button>
                  <!-- <button type="submit" class="btn btn-primary" onclick="sharedFunc()">Share</button> -->
                </div>
              </div>
            </div>
          </div>

          <div class="container my-1">
            <div id="patientList" class="row">
              <table id="patientTable" class="table table-striped table-bordered">
                <thead style="position: sticky">
                  <tr>
                    <!-- <th scope="col"><input type='checkbox' id="selectAll" class="btn btn-primary btn-sm"></th> -->
                    <th class="head-text" scope="col">S.No</th>
                    <th class="head-text" scope="col">Bio Bank ID</th>
                    <th class="head-text" scope="col">Age</th>
                    <th class="head-text" scope="col">Gender</th>
                    <th class="head-text" scope="col">Cancer Type</th>
                    <th class="head-text" scope="col">Nodal Status</th>
                    <th class="head-text" scope="col">Action</th>
                  </tr>
                </thead>
                <tbody class="patientTableBody" style="scroll-behavior: smooth">
                  <tr class="patientRow">
                    <!-- <td></td> -->
                    <th scope="row" class="sno"></th>
                    <td class="patientName"></td>
                    <td class="age"></td>
                    <td class="gender"></td>
                    <td class="cancerType"></td>
                    <!--<td class="stage"></td>-->
                    <td class="grade"></td>
                    <td class="action"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <nav aria-label="Page navigation example">
            <ul class="pagination indPagination justify-content-center">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#">Next</a>
              </li>
            </ul>
          </nav>
        </div>
        <div class="collapse" id="collapseExample1">
          <div class="card card-body">
            <form id="sampleSearchForm">
              <div class="row" style="justify-content: space-evenly">
                <div class="form-group col-xs-1 mr-2">
                  <label for="ageCriterion">Age Criterion</label>
                  <select id="ageCriterion" class="form-control">
                    <option selected>All</option>
                    <option>Greater than</option>
                    <option>Greater than Equal to</option>
                    <option>Less than</option>
                    <option>Less than Equal to</option>
                    <option>Equal to</option>
                  </select>
                </div>

                <div class="form-group col-sm-1">
                  <label for="ageInput">Age</label>
                  <input type="text" id="ageInput" class="form-control" placeholder="yrs" value="15" />
                </div>

                <div class="form-group col-xs-2 mr-2">
                  <label for="cancerTypeInput">Cancer Type</label>
                  <select id="cancerTypeInput" class="form-control">
                    <option selected>All</option>
                    <option value="brst">Breast Cancer</option>
                    <option value="2">Ovary</option>
                    <option value="3">Cervix</option>
                    <option value="4">Endometrium</option>
                    <option value="5">Pancreas</option>
                    <option value="6">Uterus</option>
                    <option value="7">Omentum</option>
                    <option value="8">Vulva</option>
                    <option value="9">Rectum</option>
                    <option value="10">Colon</option>
                    <option value="10">Esophagus</option>
                    <option value="10">Stomach</option>
                    <option value="10">Liver</option>
                    <option value="10">Head and Neck</option>
                    <option value="10">Urinary Bladder</option>
                    <option value="10">Lung</option>
                    <option value="10">Ureter</option>
                    <option value="10">Thyroid</option>
                    <option value="10">Lymph node</option>
                    <option value="10">Soft tissue</option>
                  </select>
                </div>
                <div class="form-group col-xs-2 mr-2">
                  <label for="sampleType">Sample</label>
                  <div class="dropdown">
                    <input class="dropdown-input form-control" id="sampleDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" value="All" onkeydown="return false;" readonly />

                    <div class="dropdown-menu">
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="All" checked /> All </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="Plasma" checked /> Plasma </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="Serum" checked /> Serum </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="Buffy Coat" checked /> Buffy Coat </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="FN" checked /> FN </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="FT" checked /> FT </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="Other" checked /> Other </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="RLT" checked /> RLT </label>
                      <label class="dropdown-item"> <input type="checkbox" class="btn sampleCheck" name="sampleType" value="PC" checked /> Primary Culture </label>
                    </div>
                  </div>
                </div>

                <!-- <div class="form-group col-xs-2 mr-2">
                <label for="ischemicInput">Ischemic</label>
                <select id="ischemicInput" class="form-control">

                  <option selected>All</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div> -->
                <div class="form-group col-xs-2 mr-2">
                  <label for="metaInput">Event</label>
                  <select id="metaInput" class="form-control">
                    <option selected>All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>
                <div class="form-group col-xs-2 mr-2">
                  <label for="nactInput">NACT</label>
                  <select id="nactInput" class="form-control">
                    <option selected>All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>
                <div class="form-group col-xs-2 mr-2">
                  <label for="sampleavailable">Status</label>
                  <select id="sampleavailable" class="form-control">
                    <option selected>All</option>
                    <option value="Shared">Shared</option>
                    <option value="Available">Available</option>
                  </select>
                </div>

                <div class="form-group col-xs-2 mr-2">
                  <label for="pathSubtype">Histological subtype</label>
                  <select id="pathSubtype" class="form-control">
                    <option selected>All</option>
                    <option value="option1">No residual invasive carcinoma</option>
                    <option value="option2">Invasive carcinoma of no special type (ductal)</option>
                    <option value="option3">Micro-invasive carcinoma</option>
                    <option value="option4">Invasive lobular carcinoma</option>
                    <option value="option5">Invasive carcinoma with mixed ductal and lobular features</option>
                    <option value="option6">Invasive carcinoma with features of (specify)</option>
                    <option value="option7">Tubular carcinoma</option>
                    <option value="option8">Invasive cribriform carcinoma</option>
                    <option value="option9">Mucinous carcinoma</option>
                    <option value="option10">Invasive micropapillary carcinoma</option>
                    <option value="option11">Apocrine adenocarcinoma</option>
                    <option value="option12">Metaplastic carcinoma</option>
                    <option value="option13">Encapsulated papillary carcinoma with invasion</option>
                    <option value="option14">Solid papillary carcinoma with invasion</option>
                    <option value="option15">Intraductal papillary adenocarcinoma with invasion</option>
                    <option value="option16">Adenoid cystic carcinoma</option>
                    <option value="option17">Neuroendocrine tumor</option>
                    <option value="option18">Neuroendocrine carcinoma</option>
                    <option value="option19">Invasive carcinoma, type cannot be determined:</option>
                    <option value="other">Other histologic type not listed (specify)</option>
                  </select>
                </div>
                <div class="form-group col-xs-2 mr-2">
                  <label for="gradeInput">Grade</label>
                  <select id="gradeInput" class="form-control">
                    <option selected>All</option>
                    <option value="grade1">Grade 1</option>
                    <option value="grade2">Grade 2</option>
                    <option value="grade3">Grade 3</option>
                    <option value="Only microinvasion present">Only microinvasion present</option>
                  </select>
                </div>

                <div class="form-group col-xs-2 mr-2">
                  <label for="fh1">Family History</label>
                  <select id="fh1" class="form-control">
                    <option selected>All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>
                <div class="form-group col-xs-2 mr-2">
                  <label for="cSubInput">Subtype</label>
                  <select id="cSubInput" class="form-control">
                    <option selected>All</option>
                    <option value="HR_positive_HER2_negative">HR positive HER2 negative</option>
                    <option value="HR_positive_HER2_positive">HR positive HER2 positive</option>
                    <option value="HR_negative_HER2_positive">HR negative HER2 positive</option>
                    <option value="TNBC">TNBC</option>
                  </select>
                </div>
              </div>
              <div class="row mb-1" style="justify-content: space-around">
                <div class="row">
                  <div style="justify-content: space-around">
                    <button type="submit" class="btn btn-primary" id="sampleSubmit" onclick="searchSample(event);">Submit</button>
                  </div>
                  &emsp; &emsp;
                  <div style="justify-content: space-around">
                    <button type="reset" class="btn btn-warning" id="sampleReset" onclick=" resetSample(); ">Reset</button>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="container mt-2">
            <div style="display: flex; align-items: center; justify-content: space-between">
              <p style="margin: 0; font-weight: bold">
                Show<span>
                  <select id="entriesInput2" class="btn" style="margin-left: 5px; width: 50px; border: rgb(177, 211, 243) solid 0.18rem; padding: 2px">
                    <option value="all">All</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                </span>
                entries
              </p>
              <div>
                <div class="row" id="naviButtons" style="justify-content: center; display: none">
                  <label for="AllCheck" title="Select to download all samples details" style="margin-right: 5px; cursor: pointer">
                    <input type="checkbox" id="AllCheck" class="btn btn-primary btn-lg" style="width: 28px; height: 28px" />
                    <span style="font-size: 1rem; vertical-align: middle"></span>
                  </label>
                  <img src="assets/images/download.svg" id="download2" alt="Edit" width="45" height="45" style="vertical-align: middle; cursor: pointer" title="Download" />
                  <div class="position-relative" style="display: inline-block"></div>

                  <img src="assets/images/share3.svg" alt="Share" width="38" height="38" style="vertical-align: middle; cursor: pointer" onclick="sharedFunc()" title="Share" />
                </div>
              </div>
            </div>
          </div>

          <div class="container my-1">
            <div id="patientList" class="row">
              <table id="patientTable" class="table table-striped table-bordered">
                <thead class="patientTableHead1" style="position: sticky">
                  <tr>
                    <th scope="col">
                      <input type="checkbox" id="selectAll" class="btn btn-primary btn-sm" />
                    </th>
                    <th class="head-text" scope="col">S.No</th>
                    <th class="head-text" scope="col">Bio Bank ID</th>
                    <th class="head-text" scope="col">Age</th>
                    <th class="head-text" scope="col">Gender</th>
                    <th class="head-text" scope="col">Time</th>
                    <th class="head-text" scope="col">Box</th>
                    <th class="head-text" scope="col">Grid</th>
                    <th class="head-text" scope="col">Sample Type</th>
                    <th class="head-text" scope="col">Cancer Type</th>
                    <th class="head-text" scope="col">Nodal Status</th>
                    <th class="head-text" scope="col">Action</th>
                  </tr>
                </thead>
                <tbody class="patientTableBody1" style="scroll-behavior: smooth">
                  <tr class="patientRow">
                    <td></td>
                    <th scope="row" class="sno"></th>
                    <td class="patientName"></td>
                    <td class="age"></td>
                    <td class="gender"></td>
                    <td class="latestTimestamp"></td>
                    <td class="box"></td>
                    <td class="grid"></td>
                    <td class="sampleTypes"></td>
                    <td class="cancerType"></td>
                    <td class="grade"></td>
                    <td class="action"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <nav aria-label="Page navigation example">
            <ul class="pagination samPagination justify-content-center">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#">Next</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <div id="mainContent">
      <div class="modal fade bd-example-modal-lg" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Patient History</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <table style="width: 100%; border-collapse: collapse; margin: 10px 0">
                <thead>
                  <tr>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">S.No</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Bio Bank ID</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Age</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Gender</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Procedure</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Type of Cancer</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Grade</th>
                    <th style="border: 1px solid #ddd; text-align: center; background-color: #f2f2f2">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Patient History</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table style="width: 100%; border-collapse: collapse; margin: 10px 0">
              <thead>
                <tr>
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2">S.No</th>
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2">Date</th>
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2">Time</th>
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2">Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer id="footer" style="margin-bottom: -30px">
      <div class="container footer-bottom clearfix">
        <div class="copyright">
          &copy; Copyright <strong><span></span></strong>. All Rights Reserved
        </div>
        <div class="credits"></div>
        <div class="version" style="float: right; font-size: 12px; color: rgb(255, 255, 255)">Version 1.7.13</div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
      function valueExists(val) {
        return val !== null && val !== undefined && val !== "";
      }
      function setElementValue(id, value) {
        var el = document.getElementById(id);
        if (el && valueExists(value)) {
          el.value = value;
        }
      }

      setElementValue("ageCriterion", sessionStorage.getItem("ageCriterion"));
      setElementValue("ageInput", sessionStorage.getItem("ageInput"));
      setElementValue("cancerTypeInput", sessionStorage.getItem("cancerTypeInput"));
      setElementValue("gradeInput", sessionStorage.getItem("gradeInput"));
      setElementValue("nactInput", sessionStorage.getItem("nactInput"));
      setElementValue("pathSubtype", sessionStorage.getItem("pathSubtypeInput"));
      setElementValue("sampleType", sessionStorage.getItem("sampleTypeInput"));
      setElementValue("sampleavailable", sessionStorage.getItem("sampleAvailable"));
      setElementValue("cSubInput", sessionStorage.getItem("clinicalSubInput"));
      setElementValue("metaInput", sessionStorage.getItem("metaInput"));
      setElementValue("fh1", sessionStorage.getItem("FamilyHInput"));
    </script>
    <script>
      if (!sessionStorage.getItem("isLoggedIn") || sessionStorage.getItem("isLoggedIn") !== "true") {
        window.location.href = "login.html";
      }

      localStorage.removeItem("MRN");

      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.database(app);

      document.getElementById("sampleSubmit").addEventListener("click", function () {
        const naviButtons = document.getElementById("naviButtons");
        naviButtons.style.display = "block";
      });
      let allDataDown = [];
      function historyModal() {
        $("#exampleModalCenter").modal("show");
      }
      function logout() {
        sessionStorage.removeItem("isLoggedIn");
        sessionStorage.removeItem("userName");
        window.location.href = "login.html";
      }
      function searchLoadingModal() {
        document.getElementById("loading").style.display = "flex";
      }
      function handleView() {
        window.location.href = "default.html";
      }

      document.addEventListener("DOMContentLoaded", function () {
        const page = document.body && document.body.dataset ? document.body.dataset.page : "";
        if (page === "todo") {
          // Only run To-Do specific loaders here
          if (typeof fetchPendingEntries === "function") fetchPendingEntries();
          if (typeof fetchPendingFollowUps === "function") fetchPendingFollowUps();
        } else {
          // On other pages just update the badge if needed
          if (typeof updateTodoBadge === "function") updateTodoBadge("todoBadge");
        }
      });

      function handleHistory(bioBankId, seq) {
        const patientSeq = window.patientData[bioBankId];
        const patientTimestamps = patientSeq[seq];

        if (!patientTimestamps) {
          console.error(`No timestamps found for BioBank ID: ${bioBankId} and sequence: ${seq}`);
          return;
        }

        const timestampKeys = Object.keys(patientTimestamps);
        const modalBody = document.querySelector("#exampleModal .modal-body tbody");
        modalBody.innerHTML = "";

        timestampKeys.forEach((timestampKey, index) => {
          const timestampData = patientTimestamps[timestampKey];

          const dateObj = new Date(Number(timestampKey) * 1000);
          const dateStr = dateObj.toLocaleDateString();
          const timeStr = dateObj.toLocaleTimeString();
          const row = document.createElement("tr");
          row.innerHTML = `
              <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${index + 1}</td>
              <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${dateStr}</td>
              <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${timeStr}</td>
              <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">
                <button class="btn btn-info btn-sm" onclick="viewPatient('${bioBankId}', '${seq}', '${timestampKey}')">View</button>
              </td>
            `;
          modalBody.appendChild(row);
        });
        $("#exampleModal").modal("show");
        document.getElementById("mainContent").style.filter = "blur(10px)";
        $("#exampleModal").on("hidden.bs.modal", function () {
          document.getElementById("mainContent").style.filter = "none";
        });
      }

      let currentPage = 1;
      let indRowsPerPage = 10;
      let samRowsPerPage = 10;
      let filteredSefData = {};
      document.getElementById("entriesInput1").addEventListener("change", function () {
        searchLoadingModal();
        setTimeout(() => {
          indRowsPerPage = parseInt(this.value) || 10;
          currentPage = 1;
          displayIndSefEntries(filteredSefData);
        }, 1);
      });

      document.getElementById("entriesInput2").addEventListener("change", function () {
        document.getElementById("loading").style.display = "flex";
        setTimeout(() => {
          const value = this.value; // Get the selected value
          if (value === "all") {
            samRowsPerPage = "all"; // Set samRowsPerPage to "all"
          } else {
            samRowsPerPage = parseInt(value) || 10; // Use the selected number or default to 10
          }
          currentPage = 1;
          displaySamPatients(filteredPatientData);
        }, 1);
      });

      function updateIndPagination(totalRows) {
        const totalPages = Math.ceil(totalRows / indRowsPerPage);
        const pagination = document.querySelector(".indPagination");
        pagination.innerHTML = "";

        const maxVisiblePages = 5; // Adjust this to control how many pages are shown at once
        let startPage, endPage;
        if (totalPages <= maxVisiblePages) {
          startPage = 1;
          endPage = totalPages;
        } else {
          if (currentPage <= 3) {
            startPage = 1;
            endPage = maxVisiblePages;
          } else if (currentPage + 2 >= totalPages) {
            startPage = totalPages - maxVisiblePages + 1;
            endPage = totalPages;
          } else {
            startPage = currentPage - 2;
            endPage = currentPage + 2;
          }
        }
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); IndchangePage(${currentPage - 1})">Previous</a>`;
        pagination.appendChild(prevLi);
        if (startPage > 1) {
          const firstLi = document.createElement("li");
          firstLi.className = "page-item";
          firstLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); IndchangePage(1)">1</a>`;
          pagination.appendChild(firstLi);

          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); IndchangePage(${i})">${i}</a>`;
          pagination.appendChild(li);
        }
        if (endPage < totalPages) {
          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);

          const lastLi = document.createElement("li");
          lastLi.className = "page-item";
          lastLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); IndchangePage(${totalPages})">${totalPages}</a>`;
          pagination.appendChild(lastLi);
        }
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); IndchangePage(${currentPage + 1})">Next</a>`;
        pagination.appendChild(nextLi);
      }

      function IndchangePage(page) {
        currentPage = page;
        displayIndSefEntries(filteredSefData);
      }

      function updateSamPagination(totalRows) {
        if (samRowsPerPage === "all") {
          samRowsPerPage = totalRows;
        }
        const totalPages = Math.ceil(totalRows / samRowsPerPage);
        const pagination = document.querySelector(".samPagination");
        pagination.innerHTML = "";

        const maxVisiblePages = 5;
        let startPage, endPage;

        if (totalPages <= maxVisiblePages) {
          startPage = 1;
          endPage = totalPages;
        } else {
          if (currentPage <= 3) {
            startPage = 1;
            endPage = maxVisiblePages;
          } else if (currentPage + 2 >= totalPages) {
            startPage = totalPages - maxVisiblePages + 1;
            endPage = totalPages;
          } else {
            startPage = currentPage - 2;
            endPage = currentPage + 2;
          }
        }

        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); setTimeout(() => { samChangePage(${currentPage - 1})},1)">Previous</a>`;
        pagination.appendChild(prevLi);

        if (startPage > 1) {
          const firstLi = document.createElement("li");
          firstLi.className = "page-item";
          firstLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); setTimeout(() => { samChangePage(1)},1)">1</a>`;
          pagination.appendChild(firstLi);

          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }

        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#" onclick=" searchLoadingModal(); setTimeout(() => { samChangePage(${i})},1)">${i}</a>`;
          pagination.appendChild(li);
        }

        if (endPage < totalPages) {
          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);

          const lastLi = document.createElement("li");
          lastLi.className = "page-item";
          lastLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); setTimeout(() => { samChangePage(${totalPages})},1)">${totalPages}</a>`;
          pagination.appendChild(lastLi);
        }

        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="searchLoadingModal(); setTimeout(() => {samChangePage(${currentPage + 1})},1)">Next</a>`;
        pagination.appendChild(nextLi);
      }

      function samChangePage(page) {
        currentPage = page;
        displaySamPatients(filteredPatientData);
      }

      let filteredPatientData = [];

      function searchPatient(event) {
        event.preventDefault();
        fetchBnData();

        const bioID = document.getElementById("bioInput").value.trim().toLowerCase();
        // console.log("Bio ID:", bioID);

        const filteredSefEntries = {};
        Object.keys(window.sefData).forEach((bioBankId) => {
          if (bioBankId.toLowerCase().includes(bioID)) {
            filteredSefEntries[bioBankId] = window.sefData[bioBankId];
          }
        });
        filteredSefData = filteredSefEntries;

        currentPage = 1;
        displayIndSefEntries(filteredSefEntries, bioID);
      }

      document.addEventListener("DOMContentLoaded", function () {
        var checkbox = document.querySelector("input[name=checkbox]");

        if (checkbox) {
          checkbox.addEventListener("change", function () {
            if (this.checked) {
            } else {
            }
          });
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        db.ref("sef")
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();

            if (data) {
              window.sefData = data;
              filteredSefData = data;

              displayIndSefEntries(data);
            } else {
            }
          })
          .catch((error) => {
            console.error("Error fetching the data from Firebase:", error);
          });
      });

      function displayIndSefEntries(data, bioId) {
        filteredSefEntries = data;
        const tbody = document.querySelector(".patientTableBody");
        tbody.innerHTML = "";
        let bnLocalS = [];

        db.ref("bn/")
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              const boxIDs = snapshot.val();

              let bnLocalS = [];

              for (const [key, value] of Object.entries(boxIDs)) {
                bnLocalS.push({ id: key, name: value });
              }
              localStorage.setItem("bnData", JSON.stringify(bnLocalS));
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        const bioBankIds = Object.keys(data);
        const paginatedBioBankIds = bioBankIds.slice(start, end);

        paginatedBioBankIds.forEach((bioBankId, index) => {
          const patientSeq = data[bioBankId];

          const seqKeys = Object.keys(patientSeq);
          const lastSeqKey = seqKeys[seqKeys.length - 1];
          const patientTimestamps = patientSeq[lastSeqKey];

          const timestampKeys = Object.keys(patientTimestamps);
          const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
          const patient = patientTimestamps[lastTimestampKey];

          const row = document.createElement("tr");
          row.classList.add("patientRow");
          row.innerHTML = `
              <th scope="row" class="sno">${start + index + 1}</th>
              <td class="bioid">${bioBankId}</td>
              <td class="age">${patient.ie.ag || "-"}</td>
              <td class="gender">${patient.ie.sx || "-"}</td>
              <td class="cancerType">${patient.ie.ct === "brst" ? "Breast Cancer" : "-"}</td>

              <td class="grade">${patient.md.gd || "-"}</td>

              <td class="action">

                <button class="btn btn-success btn-sm" onclick="showHistory('${bioBankId}')">View Samples</button>
              </td>
            `;
          tbody.appendChild(row);
        });
        hideLoadingModal();
        updateIndPagination(bioBankIds.length);
      }

      function displayIndSefEntries(data, bioId) {
        filteredSefEntries = data; // Keep filteredSefEntries updated
        const tbody = document.querySelector(".patientTableBody");
        tbody.innerHTML = "";
        db.ref("bn/")
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              const boxIDs = snapshot.val();

              let bnLocalS = [];
              for (const [key, value] of Object.entries(boxIDs)) {
                bnLocalS.push({ id: key, name: value });
              }

              localStorage.setItem("bnData", JSON.stringify(bnLocalS));
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });

        const start = (currentPage - 1) * indRowsPerPage;
        const end = start + indRowsPerPage;

        const bioBankIds = Object.keys(data);
        let indSeqData = [];
        let promises = [];
        Object.entries(data).forEach(([bioBankId, patientSeq]) => {
          const seqKeys = Object.keys(patientSeq);
          const lastSeqKey = seqKeys[seqKeys.length - 1];
          const patientTimestamps = patientSeq[lastSeqKey];
          const timestampKeys = Object.keys(patientTimestamps);
          const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
          const patient = patientTimestamps[lastTimestampKey];

          if (!patient || !patient.ie || !patient.md) return;
          const promise1 = indSeqData.push({
            serialNumber: indSeqData.length + 1,
            bioBankId,
            seqKey: lastSeqKey,
            age: patient.ie.ag || "-",
            gender: patient.ie.sx || "-",
            nodeS: patient.md.npn <= 0 ? "Negative" : patient.md.npn > 0 ? "Positive" : "-",

            cancerType: patient.ie.ct === "brst" ? "Breast Cancer" : "-",
            patientData: patient,
          });
          promises.push(promise1);
        });
        Promise.all(promises).then(() => {
          const paginatedBioBankIds = indSeqData.slice(start, end);

          paginatedBioBankIds.forEach((indSeqData) => {
            const { serialNumber, bioBankId, age, gender, nodeS, cancerType } = indSeqData;

            const row = document.createElement("tr");
            row.classList.add("patientRow");
            row.innerHTML = `
                  <th scope="row" class="sno small-text">${serialNumber}</th>
                  <td class="bioid small-text">${bioBankId}</td>
                  <td class="age small-text">${age}</td>
                  <td class="gender small-text">${gender === "F" ? "Female" : gender === "M" ? "Male" : "Unknown"}</td>
                  <td class="cancerType small-text">${cancerType}</td>
                  <td class="grade small-text">${nodeS}</td>
                  <td class="action small-text">
                    <button class="btn btn-success btn-sm" onclick="showHistory('${bioBankId}')">View Samples</button>
                  </td>
                `;
            tbody.appendChild(row);
          });

          hideLoadingModal();
          updateIndPagination(bioBankIds.length);
        });
      }

      function sharedFunc() {
        const isAllChecked = document.getElementById("AllCheck").checked;
        if (isAllChecked) {
          if (!allDataDown || allDataDown.length === 0) {
            alert("No samples available to share.");
            return;
          }
          const selectedPatients = allDataDown.map((data) => ({
            bioBankId: data.bioBankId,
            seqKey: data.seqKey,
            timestampKey: data.timestampKey,
            gridData: data.seat, // 'seat' is the grid info in allDataDown
            boxName: data.boxName,
          }));
          const mode = "share";
          shareData(mode, selectedPatients);
        } else {
          selectedSerialNumData;

          if (selectedSerialNumData.length === 0) {
            alert("Please select a sample to Share");
            return;
          }

          const selectedPatients = [];

          selectedSerialNumData.forEach((data) => {
            const bioBankId = data.bioBankId;
            const seqKey = data.seqKey;
            const timestampKey = data.timestampKey;
            const gridData = data.gridData;
            const boxName = data.boxName;

            selectedPatients.push({
              bioBankId: bioBankId,
              seqKey: seqKey,
              timestampKey: timestampKey,
              gridData: gridData,
              boxName: boxName,
            });
          });
          const mode = "share";
          shareData(mode, selectedPatients);
        }
      }

      function editPatient(bioBankId, seq, timestampKey) {
        let editS = "SearchEdit";
        let user = sessionStorage.getItem("userName");
        let act = {
          mode: "e",
          user: user,
        };

        let refPath = `act/${bioBankId}/${seq}`;

        db.ref(refPath)
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              let data = snapshot.val();

              if (data.mode === "e" && data.user !== user) {
                alert(`This form is being edited by ${data.user}. Please try after sometime...`);
              } else {
                db.ref(refPath)
                  .set(act)
                  .then(() => {
                    pages_display(editS, bioBankId, seq, timestampKey);
                  })
                  .catch((error) => {
                    console.error("Error setting new act: ", error);
                  });
              }
            } else {
              db.ref(refPath)
                .set(act)
                .then(() => {
                  pages_display(editS, bioBankId, seq, timestampKey);
                })
                .catch((error) => {
                  console.error("Error setting new act: ", error);
                });
            }
          })
          .catch((error) => {
            console.error("Error checking path in Firebase: ", error);
          });
      }

      function viewPatient(bioBankId, seq, timestampKey) {
        const patientSeq = window.patientData[bioBankId];
        const timestampData = patientSeq[seq][timestampKey]; // Get the timestamp data
        let viewS = "SearchView";
        pages_display(viewS, bioBankId, seq, timestampKey);
      }

      function showHistory(bioBankId) {
        const patientSeq = window.patientData[bioBankId]; // Assuming you are using filtered data

        if (!patientSeq) {
          console.error(`No data found for BioBank ID: ${bioBankId}`);
          return;
        }
        const tbody = document.querySelector("#exampleModalCenter .modal-body tbody");
        tbody.innerHTML = ""; // Clear the existing content

        const seqKeys = Object.keys(patientSeq);
        seqKeys.forEach((seq, index) => {
          const patientTimestamps = patientSeq[seq];
          const timestampKeys = Object.keys(patientTimestamps);
          const lastTimestampKey = timestampKeys[timestampKeys.length - 1];
          const patientData = patientTimestamps[lastTimestampKey];
          const patient = patientData.ie || {};
          const fields = ["bpg", "bsg", "bbcg", "ftg", "fng", "osg", "rlt", "pc"];

          let boxid = "";
          let seatList = [];
          fields.forEach((field) => {
            const fieldData = patient[field];
            if (fieldData) {
              const parts = fieldData.split("/"); // Assuming the box name and seat list are separated by "/"

              boxid = parts[0].trim();

              seatList = parts[1] ? parts[1].split(",") : []; // Split the seats into an array
            }
          });
          const storedBnData = JSON.parse(localStorage.getItem("bnData"));

          const boxEntry = storedBnData.find((entry) => entry.id === boxid);

          if (boxEntry) {
            boxName = boxEntry.name;
          }
          let metas = "";
          if (patient.mspt) {
            if (patient.mspt === "Bx") {
              metas = "Biopsy";
            }
            if (patient.mspt === "Sx") {
              metas = "Resection";
            }
            if (patient.mspt === "MBx") {
              metas = "Event Biopsy";
            }
            if (patient.mspt === "MSx") {
              metas = "Event Resection";
            }
          }

          const seatListDisplay = seatList.length ? seatList.join(", ") : "-";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${index + 1}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${bioBankId}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.ag || "-"}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.sx === "F" ? "Female" : (patient.sx === "M" ? "Male" : "Unknown") || "-"}</td>

            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${metas || "-"}</td> <!-- Display box name -->

            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patient.ct === "brst" ? "Breast Cancer" : "-"}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${patientData.md.gd.charAt(0).toUpperCase() + patientData.md.gd.slice(1) || "-"}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">
              <button class="btn btn-primary btn-sm" onclick="editPatient('${bioBankId}', '${seq}', '${lastTimestampKey}')"><img src="assets/images/edit.svg" alt="Edit" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"> </button>
              <button class="btn btn-info btn-sm" onclick="viewPatient('${bioBankId}', '${seq}', '${lastTimestampKey}')"> <img src="assets/images/visibility.svg" alt="View" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"></button>
              <button class="btn btn-primary btn-sm" onclick="handleHistory('${bioBankId}', '${seq}')"><img src="assets/images/history.svg" alt="History" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"> </button>



            </td>
          `;

          tbody.appendChild(row);
        });
        $("#exampleModalCenter").modal("show");
      }

      document.addEventListener("DOMContentLoaded", function () {
        db.ref("sef")
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (data) {
              window.patientData = data;
              filteredPatientData = data;
            } else {
            }
          })
          .catch((error) => {
            console.error("Error fetching the data from Firebase:", error);
          });
      });

      document.getElementById("AllCheck").addEventListener("change", function (event) {
        const isChecked = event.target.checked;
        if (isChecked) {
          selectedSerialNumbers = [];
          selectedSerialNumData = [];
          if (Array.isArray(allDataDown)) {
            allDataDown.forEach((row) => {
              selectedSerialNumbers.push(row.serialNumber ? row.serialNumber.toString() : "");
              selectedSerialNumData.push({
                bioBankId: row.bioBankId,
                seqKey: row.seqKey,
                timestampKey: row.timestampKey,
                gridData: row.seat,
                boxName: row.boxName,
              });
            });
          }
        } else {
          selectedSerialNumbers = [];
          selectedSerialNumData = [];
        }
        document.querySelectorAll(".selection").forEach((cb) => {
          cb.checked = isChecked;
        });
        const selectAllCheckbox = document.getElementById("selectAll");
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = isChecked;
        }
      });
      function formatTimestamp(unixTimestamp) {
        if (!unixTimestamp || isNaN(unixTimestamp)) {
          return "-";
        }
        const timestamp = unixTimestamp > 9999999999 ? unixTimestamp : unixTimestamp * 1000;

        const date = new Date(timestamp);

        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear(); // Use full year instead of slice(-2)
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
      }

      let selectedSerialNumbers = [];
      let selectedSerialNumData = [];

      async function displaySamPatients(data) {
        let countDownData = 0;
        filteredPatientData = data;
        const tbody = document.querySelector(".patientTableBody1");
        const thead = document.querySelector(".patientTableHead1");

        tbody.innerHTML = "";
        let bnLocalS = [];

        db.ref("bn/")
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              const boxIDs = snapshot.val();

              let bnLocalS = [];

              for (const [key, value] of Object.entries(boxIDs)) {
                bnLocalS.push({ id: key, name: value });
              }
              localStorage.setItem("bnData", JSON.stringify(bnLocalS));
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
        const start = (currentPage - 1) * samRowsPerPage;
        const end = samRowsPerPage === "all" ? data.length : currentPage * samRowsPerPage;
        const sampleTypeInput = localStorage
          .getItem("sampleTypeInput")
          .split(",")
          .map((item) => item.trim());
        const sampleAvailable = localStorage.getItem("sampleAvailable");
        let allSequences = [];
        let promises = [];
        let boxName = "";
        Object.entries(data).forEach(([bioBankId, sequenceData]) => {
          Object.entries(sequenceData).forEach(([seqKey, timestampEntries]) => {
            const lastTimestampKey = Object.keys(timestampEntries).sort().pop();
            let patient = timestampEntries[lastTimestampKey];

            if (!patient) return;

            let hasSubChildren = false;

            if (patient) {
              hasSubChildren = Object.keys(patient).some((key) => typeof patient[key] === "object" && patient[key] !== null);
            }

            if (hasSubChildren) {
              let patientmd = patient.md;
              patient = patient.ie;
              const patientdd = { ...patient };
              if (patientmd && patientmd.gd) {
                patientdd.gd = patientmd?.gd.charAt(0).toUpperCase() + patientmd?.gd.slice(1);
              }
              if (patientmd && patientmd.npt) {
                patientdd.npt = patientmd.npt;
              }
              patient = patientdd;
            }

            const fields = ["bpg", "bsg", "bbcg", "ftg", "fng", "osg", "rlt", "pc"];
            fields.forEach((field) => {
              const fieldData = patient[field];
              if (!fieldData) return;

              const [boxid = "-", seatData = "", sampleData = ""] = fieldData.split("/");

              const seatList = seatData.split(",").map((seat) => seat.trim());
              let sampleTypeList = sampleData.split(",").map((type) => type.trim().toUpperCase());

              const uniformSampleTypes = ["PLASMA", "MPLASMA", "SERUM", "MSERUM", "BUFFY COAT", "MBUFFY COAT", "OTHER", "MOTHER", "FN", "FT", "MFN", "MFT", "RLT", "PC"];
              if (sampleTypeList.length < seatList.length) {
                const lastSampleType = sampleTypeList[sampleTypeList.length - 1];
                while (sampleTypeList.length < seatList.length) {
                  sampleTypeList.push(lastSampleType); // Repeat the last valid sample type
                }
              }

              seatList.forEach((seat, index) => {
                const sampleType = sampleTypeList[index];

                const matchesCondition = sampleTypeInput.forEach((inputType) => {
                  const upperInputType = inputType.toUpperCase();

                  if (
                    upperInputType === "ALL" ||
                    ((sampleType.startsWith("PLASMA") || sampleType.startsWith("MPLASMA")) && upperInputType.startsWith("PLASMA")) ||
                    ((sampleType.startsWith("SERUM") || sampleType.startsWith("MSERUM")) && upperInputType.startsWith("SERUM")) ||
                    ((sampleType.startsWith("BUFFY COAT") || sampleType.startsWith("MBUFFY COAT")) && upperInputType.startsWith("BUFFY COAT")) ||
                    ((sampleType.startsWith("OTHER") || sampleType.startsWith("MOTHER")) && upperInputType.startsWith("OTHER")) ||
                    ((sampleType.startsWith("FN") || sampleType.startsWith("MFN")) && upperInputType.startsWith("FN")) ||
                    ((sampleType.startsWith("FT") || sampleType.startsWith("MFT")) && upperInputType.startsWith("FT")) ||
                    ((sampleType.startsWith("RLT") || sampleType.startsWith("MRLT")) && upperInputType.startsWith("RLT")) ||
                    ((sampleType.startsWith("PC") || sampleType.startsWith("PC")) && upperInputType.startsWith("PC"))
                  ) {
                    const seatIndex = getSeatIndex(seat.trim());
                    countDownData++;
                    const promise1 = db
                      .ref(`bb/${boxid}/${seatIndex}/`)
                      .once("value")
                      .then((snapshot) => {
                        const box = snapshot.val();
                        if (box) {
                          const sts = box.status;
                          const status =
                            sampleAvailable === "All" || (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) || (sampleAvailable === "Available" && (sts === null || sts === "o"));

                          const storedBnData = JSON.parse(localStorage.getItem("bnData"));
                          const boxEntry = storedBnData.find((entry) => entry.id === boxid);
                          if (boxEntry) {
                            boxName = boxEntry.name;
                          }

                          if (status) {
                            allSequences.push({
                              serialNumber: allSequences.length + 1,
                              bioBankId,
                              seqKey,
                              timestampKey: lastTimestampKey,
                              field,
                              boxName: boxName.trim(),
                              seat: seat.trim(),
                              sampleType,
                              patientData: patient,
                            });
                          }
                        }
                      });

                    const promise2 = db
                      .ref(`sb/${boxid}/${seatIndex}/`)
                      .once("value")
                      .then((snapshot) => {
                        const box1 = snapshot.val();
                        if (box1) {
                          const sts = box1.status;
                          const status =
                            sampleAvailable === "All" || (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) || (sampleAvailable === "Available" && (sts === null || sts === "o"));

                          const storedBnData = JSON.parse(localStorage.getItem("bnData"));
                          const boxEntry = storedBnData.find((entry) => entry.id === boxid);
                          if (boxEntry) {
                            boxName = boxEntry.name;
                          }

                          if (status) {
                            allSequences.push({
                              serialNumber: allSequences.length + 1,
                              bioBankId,
                              seqKey,
                              timestampKey: lastTimestampKey,
                              field,
                              boxName: boxName.trim(),
                              seat: seat.trim(),
                              sampleType,
                              patientData: patient,
                            });
                            allDataDown = allSequences;
                          }
                        }
                      });
                    const promise3 = db
                      .ref(`rlt/${boxid}/${seatIndex}/`)
                      .once("value")
                      .then((snapshot) => {
                        const box1 = snapshot.val();
                        if (box1) {
                          const sts = box1.status;
                          const status =
                            sampleAvailable === "All" || (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) || (sampleAvailable === "Available" && (sts === null || sts === "o"));

                          const storedBnData = JSON.parse(localStorage.getItem("bnData"));
                          const boxEntry = storedBnData.find((entry) => entry.id === boxid);
                          if (boxEntry) {
                            boxName = boxEntry.name;
                          }

                          if (status) {
                            allSequences.push({
                              serialNumber: allSequences.length + 1,
                              bioBankId,
                              seqKey,
                              timestampKey: lastTimestampKey,
                              field,
                              boxName: boxName.trim(),
                              seat: seat.trim(),
                              sampleType,
                              patientData: patient,
                            });
                            allDataDown = allSequences;
                          }
                        }
                      });
                    const promise4 = db
                      .ref(`pcb/${boxid}/${seatIndex}/`)
                      .once("value")
                      .then((snapshot) => {
                        const box1 = snapshot.val();
                        if (box1) {
                          const sts = box1.status;
                          const status =
                            sampleAvailable === "All" || (sampleAvailable === "Shared" && (sts === "s" || sts === "ps")) || (sampleAvailable === "Available" && (sts === null || sts === "o"));

                          const storedBnData = JSON.parse(localStorage.getItem("bnData"));
                          const boxEntry = storedBnData.find((entry) => entry.id === boxid);
                          if (boxEntry) {
                            boxName = boxEntry.name;
                          }

                          if (status) {
                            allSequences.push({
                              serialNumber: allSequences.length + 1,
                              bioBankId,
                              seqKey,
                              timestampKey: lastTimestampKey,
                              field,
                              boxName: boxName.trim(),
                              seat: seat.trim(),
                              sampleType,
                              patientData: patient,
                            });
                            allDataDown = allSequences;
                          }
                        }
                      });

                    promises.push(promise1);
                    promises.push(promise2);
                    promises.push(promise3);
                    promises.push(promise4);
                  }
                });
              });
            });
          });
        });
        Promise.all(promises).then(() => {
          hideLoadingModal();
          if (allSequences.length === 0) {
            alert("No samples found matching the criteria.");
          }
          updateSamPagination(allSequences.length);

          const paginatedSequences = allSequences.slice(start, end);
          paginatedSequences.forEach((sequence) => {
            const { serialNumber, bioBankId, seqKey, timestampKey, field, boxName, seat, sampleType, patientData } = sequence;
            const row = document.createElement("tr");
            row.classList.add("patientRow");
            row.setAttribute("data-bioBankId", bioBankId);
            row.setAttribute("data-seqKey", seqKey);
            row.setAttribute("data-timestampKey", timestampKey);
            row.setAttribute("data-grid", seat);
            row.setAttribute("data-box", boxName);

            const isChecked = selectedSerialNumbers.includes(serialNumber.toString());
            thead.innerHTML = `
                <tr>
                  <th scope="col">
                    <input type="checkbox" id="selectAll" class="btn btn-primary btn-sm" />
                  </th>
                  <th class="head-text" scope="col">S.No</th>
                  <th class="head-text" scope="col">Bio Bank ID</th>
                  <th class="head-text" scope="col">Age</th>
                  <th class="head-text" scope="col">Gender</th>
                  <th class="head-text" scope="col">Time</th>
                  <th class="head-text" scope="col">Box</th>
                  <th class="head-text" scope="col">Grid</th>
                  <th class="head-text" scope="col">Sample Type</th>
                  <th class="head-text" scope="col">Cancer Type</th>
                  <!--  <th scope="col">Stage of Cancer</th> -->
                  <th class="head-text" scope="col">Nodal Status</th>
                  <th class="head-text" scope="col">Action</th>
                </tr>
              `;

            row.innerHTML = `
              <td class="small-text"><input type='checkbox' class="btn btn-primary btn-sm selection" name="checkbox" data-serial-number="${serialNumber}" ${isChecked ? "checked" : ""}></td>
              <th scope="row" class="sno small-text">${serialNumber}</th>
              <td class="patientName small-text">${bioBankId || "-"}</td>
              <td class="age small-text">${patientData.ag || "-"}</td>
              <td class="gender small-text">${patientData.sx === "F" ? "Female" : (patientData.sx === "M" ? "Male" : "Unknown") || "-"}</td>
              <td class="timestamp small-text" data-seq-key="${seqKey}" data-timestamp-key="${timestampKey}">${formatDisplayTimestamp(timestampKey) || "-"}</td>
              <td class="box small-text">${boxName || "-"}</td>
              <td class="grid small-text">${seat || "-"}</td>
              <td class="sampleType small-text">${sampleType || "-"}</td>
              <td class="cancerType small-text">${patientData.ct === "brst" ? "Breast Cancer" : "-"}</td>
              <td class="grade small-text">${patientData.npn <= 0 ? "Negative" : patientData.npn > 0 ? "Positive" : "-"}</td>
              <td class="action small-text">
                <div class="btn-group" role="group" aria-label="Patient Actions">
                <button class="btn btn-primary btn-sm small-text" onclick="editPatient('${bioBankId}', '${seqKey}', '${timestampKey}')">
                  <img src="assets/images/edit.svg" alt="Edit" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
                <button class="btn btn-info btn-sm small-text" onclick="viewPatient('${bioBankId}', '${seqKey}', '${timestampKey}')">
                  <img src="assets/images/visibility.svg" alt="View" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
                <button class="btn btn-success btn-sm small-text" onclick="handleHistory('${bioBankId}', '${seqKey}')">
                  <img src="assets/images/history.svg" alt="History" width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                </button>
                </div>
              </td>
              `;

            tbody.appendChild(row);
          });

          function formatDisplayTimestamp(timestamp) {
            if (!timestamp || isNaN(timestamp)) {
              return "-";
            }
            const date = new Date(timestamp * 1000);
            if (isNaN(date.getTime())) {
              return "-";
            }
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${day}-${month}-${year} ${hours}:${minutes}`;
          } // Function to update selectAll checkbox state
          function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById("selectAll");
            const checkboxes = document.querySelectorAll(".selection");
            const checkedBoxes = document.querySelectorAll(".selection:checked");
            if (checkedBoxes.length === checkboxes.length && checkboxes.length > 0) {
              selectAllCheckbox.checked = true;
            } else {
              selectAllCheckbox.checked = false;
            }
          }
          const checkboxes = document.querySelectorAll(".selection");
          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", (event) => {
              const serialNumber = event.target.getAttribute("data-serial-number");
              if (event.target.checked) {
                if (!selectedSerialNumbers.includes(serialNumber)) {
                  selectedSerialNumbers.push(serialNumber);
                  const row = event.target.closest("tr");
                  const bioBankId = row.getAttribute("data-bioBankId");
                  const seqKey = row.getAttribute("data-seqKey");
                  const timestampKey = row.getAttribute("data-timestampKey");
                  const gridData = row.getAttribute("data-grid");
                  const boxName = row.getAttribute("data-box");
                  selectedSerialNumData.push({
                    bioBankId: bioBankId,
                    seqKey: seqKey,
                    timestampKey: timestampKey,
                    gridData: gridData,
                    boxName: boxName,
                  });
                }
              } else {
                selectedSerialNumbers = selectedSerialNumbers.filter((num) => num !== serialNumber);
                const row = event.target.closest("tr");
                const bioBankId = row.getAttribute("data-bioBankId");
                const seqKey = row.getAttribute("data-seqKey");
                const timestampKey = row.getAttribute("data-timestampKey");
                const gridData = row.getAttribute("data-grid");
                const boxName = row.getAttribute("data-box");

                selectedSerialNumData = selectedSerialNumData.filter(
                  (data) => !(data.bioBankId === bioBankId && data.seqKey === seqKey && data.timestampKey === timestampKey && data.gridData === gridData && data.boxName === boxName)
                );
              }
              updateSelectAllCheckbox();
              // console.log("Selected serial numbers Data: ", selectedSerialNumData);
            });
          });
          const selectAllCheckbox = document.getElementById("selectAll");
          selectAllCheckbox.addEventListener("change", (event) => {
            const isChecked = event.target.checked;
            const checkboxes = document.querySelectorAll(".selection");

            checkboxes.forEach((checkbox) => {
              checkbox.checked = isChecked;
              const serialNumber = checkbox.getAttribute("data-serial-number");

              if (isChecked) {
                if (!selectedSerialNumbers.includes(serialNumber)) {
                  selectedSerialNumbers.push(serialNumber);

                  const row = checkbox.closest("tr");
                  const bioBankId = row.getAttribute("data-bioBankId");
                  const seqKey = row.getAttribute("data-seqKey");
                  const timestampKey = row.getAttribute("data-timestampKey");
                  const gridData = row.getAttribute("data-grid");
                  const boxName = row.getAttribute("data-box");

                  selectedSerialNumData.push({
                    bioBankId: bioBankId,
                    seqKey: seqKey,
                    timestampKey: timestampKey,
                    gridData: gridData,
                    boxName: boxName,
                  });
                }
              } else {
                selectedSerialNumbers = selectedSerialNumbers.filter((num) => num !== serialNumber);

                const row = checkbox.closest("tr");
                const bioBankId = row.getAttribute("data-bioBankId");
                const seqKey = row.getAttribute("data-seqKey");
                const timestampKey = row.getAttribute("data-timestampKey");
                const gridData = row.getAttribute("data-grid");
                const boxName = row.getAttribute("data-box");

                selectedSerialNumData = selectedSerialNumData.filter(
                  (data) => !(data.bioBankId === bioBankId && data.seqKey === seqKey && data.timestampKey === timestampKey && data.gridData === gridData && data.boxName === boxName)
                );
              }
            });
          });
          updateSelectAllCheckbox();
        });
      }

      function handleAgeInput() {
        let ageC = document.getElementById("ageCriterion").value;
        let ageInput = document.getElementById("ageInput");

        if (ageC === "All") {
          ageInput.value = 15;
          ageInput.disabled = true;
        } else {
          ageInput.disabled = false;
        }
      }

      document.getElementById("ageCriterion").addEventListener("change", handleAgeInput);

      window.addEventListener("DOMContentLoaded", function () {
        handleAgeInput();
      });

      function resetSample() {
        selectedSerialNumbers = [];
        selectedSerialNumData = [];

        document.getElementById("ageCriterion").value = "All";
        document.getElementById("ageInput").value = "15";
        document.getElementById("ageInput").disabled = true; // Disable age input if "All"
        document.getElementById("cancerTypeInput").value = "All";
        document.getElementById("gradeInput").value = "All";
        document.getElementById("nactInput").value = "All";
        document.getElementById("pathSubtype").value = "All";
        document.getElementById("sampleavailable").value = "All";
        document.getElementById("cSubInput").value = "All";
        document.getElementById("metaInput").value = "All";
        document.getElementById("fh1").value = "All";
        document.querySelectorAll('input[name="sampleType"]').forEach((cb) => (cb.checked = true));
        if (typeof updateSampleDropdown === "function") updateSampleDropdown();

        const localStorageNames = [
          { name: "ageCriterion", value: "All" },
          { name: "ageInput", value: "15" },
          { name: "cancerTypeInput", value: "All" },
          { name: "gradeInput", value: "All" },
          { name: "nactInput", value: "All" },
          { name: "pathSubtypeInput", value: "All" },
          { name: "sampleTypeInput", value: "All" },
          { name: "sampleAvailable", value: "All" },
          { name: "clinicalSubInput", value: "All" },
          { name: "metaInput", value: "All" },
          { name: "FamilyHInput", value: "All" },
        ];
        localStorageNames.forEach((item) => {
          localStorage.setItem(item.name, item.value);
          sessionStorage.setItem(item.name, item.value);
        });
      }

      async function searchSample(event) {
        event.preventDefault();
        selectedSerialNumbers = [];
        selectedSerialNumData = [];
        const ageCriterion = document.getElementById("ageCriterion").value;
        const ageInput = parseInt(document.getElementById("ageInput").value);
        const cancerTypeInput = document.getElementById("cancerTypeInput").value;
        const gradeInput = document.getElementById("gradeInput").value;
        const nactInput = document.getElementById("nactInput").value;
        const pathSubtypeInput = document.getElementById("pathSubtype").value;
        const selectedCheckboxes = document.querySelectorAll('input[name="sampleType"]:checked');
        let sampleTypeInput = Array.from(selectedCheckboxes)
          .map((checkbox) => checkbox.value)
          .filter(function (e) {
            return e !== "All";
          });
        const sampleAvailable = document.getElementById("sampleavailable").value;
        const clinicalSubInput = document.getElementById("cSubInput").value;
        const metaInput = document.getElementById("metaInput").value;
        const FamilyHInput = document.getElementById("fh1").value;

        sessionStorage.setItem("ageCriterion", ageCriterion);
        sessionStorage.setItem("ageInput", ageInput);
        sessionStorage.setItem("cancerTypeInput", cancerTypeInput);
        sessionStorage.setItem("gradeInput", gradeInput);
        sessionStorage.setItem("nactInput", nactInput);
        sessionStorage.setItem("pathSubtypeInput", pathSubtypeInput);
        sessionStorage.setItem("sampleTypeInput", sampleTypeInput);
        sessionStorage.setItem("sampleAvailable", sampleAvailable);
        sessionStorage.setItem("clinicalSubInput", clinicalSubInput);
        sessionStorage.setItem("metaInput", metaInput);
        sessionStorage.setItem("FamilyHInput", FamilyHInput);

        if (!window.patientData) {
          console.error("Patient data is not available.");
          return;
        }

        const criteria = {
          ageCriterion,
          ageInput,
          cancerTypeInput,
          gradeInput,
          nactInput,
          pathSubtypeInput,
          sampleTypeInput,
          sampleAvailable,
          metaInput,
          FamilyHInput,
          clinicalSubInput,
        };

        const filteredPatientData = {};

        for (const bioBankId of Object.keys(window.patientData)) {
          const patientEntries = window.patientData[bioBankId];
          const seqNumbers = Object.keys(patientEntries);

          if (seqNumbers.length === 0) continue;

          filteredPatientData[bioBankId] = {};
          let countDownData = 0;

          for (const seqNumber of seqNumbers) {
            const entryData = patientEntries[seqNumber];
            const nestedKeys = Object.keys(entryData);

            for (const nestedKey of nestedKeys) {
              const patientData = entryData[nestedKey]?.ie;
              const patientmd = entryData[nestedKey]?.md;
              const patientbrf = entryData[nestedKey]?.brf;

              if (!patientData) continue;

              const ageMatch =
                !criteria.ageInput ||
                (criteria.ageCriterion === "All" && parseInt(patientData.ag) > criteria.ageInput) ||
                (criteria.ageCriterion === "Greater than" && parseInt(patientData.ag) > criteria.ageInput) ||
                (criteria.ageCriterion === "Greater than Equal to" && parseInt(patientData.ag) >= criteria.ageInput) ||
                (criteria.ageCriterion === "Less than" && parseInt(patientData.ag) < criteria.ageInput) ||
                (criteria.ageCriterion === "Less than Equal to" && parseInt(patientData.ag) <= criteria.ageInput) ||
                (criteria.ageCriterion === "Equal to" && parseInt(patientData.ag) === criteria.ageInput);

              const cancerTypeMatch = criteria.cancerTypeInput === "All" || !criteria.cancerTypeInput || patientData.ct === criteria.cancerTypeInput.toLowerCase();

              const gradeMatch = criteria.gradeInput === "All" || !criteria.gradeInput || patientmd.gd.toLowerCase() === criteria.gradeInput.toLowerCase();

              const nactMatch =
                criteria.nactInput === "All" || !criteria.nactInput || (criteria.nactInput === "Yes" && patientData.nact === "true") || (criteria.nactInput === "No" && patientData.nact === "false");

              const pathSubtypeMatch = criteria.pathSubtypeInput === "All" || !criteria.pathSubtypeInput || patientmd.pst === criteria.pathSubtypeInput.toLowerCase();

              const sampleTypeMatch = (() => {
                const sampleFields = ["bpg", "bsg", "bbcg", "fng", "ftg", "osg", "rlt", "pc"];
                const selectedSampleTypes = sampleTypeInput; // Assuming sampleTypeInput is an array

                return sampleFields.some((field) => {
                  const sampleValue = patientData[field];

                  if (sampleValue) {
                    const sampleType = sampleValue.split("/")[2]?.toUpperCase();
                    return selectedSampleTypes.some((inputType) => {
                      const upperInputType = inputType.toUpperCase();

                      if (upperInputType === "ALL") {
                        return true;
                      }
                      if (upperInputType === "PLASMA") {
                        return sampleType.startsWith("MPLASMA") || sampleType === "PLASMA";
                      }
                      if (upperInputType === "SERUM") {
                        return sampleType.startsWith("MSERUM") || sampleType === "SERUM";
                      }
                      if (upperInputType === "BUFFY COAT") {
                        return sampleType.startsWith("MBUFFY COAT") || sampleType === "BUFFY COAT";
                      }
                      if (upperInputType === "OTHER") {
                        return sampleType.startsWith("MOTHER") || sampleType === "OTHER";
                      }
                      if (upperInputType.startsWith("FN")) {
                        return sampleType.startsWith("FN") || sampleType.startsWith("MFN");
                      }
                      if (upperInputType.startsWith("FT")) {
                        return sampleType.startsWith("FT") || sampleType.startsWith("MFT");
                      }
                      if (upperInputType === "RLT") {
                        return sampleType.startsWith("RLT") || sampleType === "RLT";
                      }
                      if (upperInputType === "PC") {
                        return sampleType.startsWith("PC") || sampleType === "PC";
                      }

                      return false;
                    });
                  }
                  return false;
                });
              })();
              localStorage.setItem("sampleTypeInput", sampleTypeInput);
              localStorage.setItem("sampleAvailable", sampleAvailable);

              const metaInputMatch =
                criteria.metaInput === "All" || !criteria.metaInput || (criteria.metaInput === "Yes" && patientData.mts === "true") || (criteria.metaInput === "No" && patientData.mts === "false");

              const FamilyHInputMatch =
                criteria.FamilyHInput === "All" ||
                !criteria.FamilyHInput ||
                (criteria.FamilyHInput === "Yes" && patientmd.fhc === "true") ||
                (criteria.FamilyHInput === "No" && patientmd.fhc === "false");

              const cSubInputMatch =
                criteria.clinicalSubInput === "All" ||
                !criteria.clinicalSubInput ||
                (criteria.clinicalSubInput === "Her2 enriched" && patientbrf.sbt === "Her2 enriched") ||
                (criteria.clinicalSubInput === "Triple positive" && patientbrf.sbt === "Triple positive") ||
                (criteria.clinicalSubInput === "HR positive" && patientbrf.sbt === "HR positive") ||
                (criteria.clinicalSubInput === "HR_positive_HER2_negative" && patientbrf.sbt === "HR_positive_HER2_negative") ||
                (criteria.clinicalSubInput === "HR_positive_HER2_positive" && patientbrf.sbt === "HR_positive_HER2_positive") ||
                (criteria.clinicalSubInput === "HR_negative_HER2_positive" && patientbrf.sbt === "HR_negative_HER2_positive") ||
                (criteria.clinicalSubInput === "TNBC" && patientbrf.sbt === "TNBC");

              if (ageMatch && cancerTypeMatch && gradeMatch && nactMatch && pathSubtypeMatch && sampleTypeMatch && metaInputMatch && FamilyHInputMatch && cSubInputMatch) {
                if (!filteredPatientData[bioBankId][seqNumber]) {
                  filteredPatientData[bioBankId][seqNumber] = {};
                }
                function capitalizeFirstLetter(string) {
                  if (!string) return string;
                  return string.charAt(0).toUpperCase() + string.slice(1);
                }
                filteredPatientData[bioBankId][seqNumber][nestedKey] = { ...patientData, gd: capitalizeFirstLetter(patientmd?.gd), npn: patientmd?.npn };

                /*if (sampleAvailableMatch) {
                      filteredPatientData[bioBankId][seqNumber][nestedKey] = {
                        ...patientData,
                        ssts: sampleStatusList,
                      };
                    }*/
              }
            }
          }

          if (Object.keys(filteredPatientData[bioBankId]).length === 0) {
            delete filteredPatientData[bioBankId];
          }
        }
        selectedSerialNumbers = [];

        currentPage = 1;
        // console.log("Filtered Patient Data:", filteredPatientData);

        if (filteredPatientData && Object.keys(filteredPatientData).length > 0) {
          searchLoadingModal();
        }
        displaySamPatients(filteredPatientData);
      }

      function processAndCheckSampleType(patientField, sampleTypeInput, sampleAvailableCriteria) {
        if (patientField !== undefined) {
          const parts = patientField.split("/");

          if (parts.length < 3) {
            console.error("Invalid sample format:", patientField);
            return false;
          }

          const [boxName, gridNumber, sampleType] = parts.map((part) => part.trim());
          const normalizedSampleType = sampleType.toUpperCase();
          const sampleTypeMatch =
            sampleTypeInput === "ALL" ||
            (sampleTypeInput === "PLASMA" && (normalizedSampleType.startsWith("MPLASMA") || normalizedSampleType === "PLASMA")) ||
            (sampleTypeInput === "SERUM" && (normalizedSampleType.startsWith("MSERUM") || normalizedSampleType === "SERUM")) ||
            (sampleTypeInput === "BUFFY COAT" && (normalizedSampleType.startsWith("MBUFFY COAT") || normalizedSampleType === "BUFFY COAT")) ||
            (sampleTypeInput === "OTHER" && (normalizedSampleType.startsWith("MOTHER") || normalizedSampleType === "OTHER")) ||
            ((normalizedSampleType.startsWith("FN") || normalizedSampleType.startsWith("MFN")) && sampleTypeInput.startsWith("FN")) ||
            ((normalizedSampleType.startsWith("FT") || normalizedSampleType.startsWith("MFT")) && sampleTypeInput.startsWith("FT"));

          if (!sampleTypeMatch) {
            return false;
          }
          const boxExists = checkBoxExists(boxName);

          if (!boxExists) {
            console.error(`Box "${boxName}" does not exist in sb/ or bb/ nodes.`);
            return false;
          }
          const sampleAvailableMatch =
            !sampleAvailableCriteria || (sampleAvailableCriteria === "Available" && patientField.bs === "true") || (sampleAvailableCriteria === "Not Available" && patientField.bs === "false");

          return sampleAvailableMatch;
        } else {
          return false;
        }
      }
      function checkBoxExists(boxName) {
        const mockSbNodes = ["Blood Box 01", "Blood Box 02"]; // Example data for sb/ nodes
        const mockBbNodes = ["Blood Box 03", "Blood Box 04"]; // Example data for bb/ nodes

        return mockSbNodes.includes(boxName) || mockBbNodes.includes(boxName);
      }

      function isMatch(patientData, criteria) {
        const { ageCriterion, ageInput, cancerTypeInput, gradeInput, nactInput, pathSubtypeInput, sampleTypeInput } = criteria;

        const patient = patientData.ie || {};
        const ageMatch = checkAgeCriterion(patient.ag, ageCriterion, ageInput);
        const cancerTypeMatch = cancerTypeInput === "All" || patient.ct === cancerTypeInput;
        const gradeMatch = gradeInput === "All" || patientData.md?.gd === gradeInput;
        const nactMatch = nactInput === "All" || (nactInput === "Y" && patientData.nact === "true") || (nactInput === "N" && patientData.nact === "false");
        const pathSubtypeMatch = pathSubtypeInput === "All" || patientData.md?.pst === pathSubtypeInput;

        const sampleTypeMatch = sampleTypeInput === "ALL" || ["bpg", "bsg", "bbcg", "fng", "ftg", "osg"].some((field) => checkSampleType(patient[field], sampleTypeInput));
        return ageMatch && cancerTypeMatch && gradeMatch && nactMatch && pathSubtypeMatch && sampleTypeMatch;
      }
      function checkSampleType(sampleType, sampleTypeInput) {
        if (sampleTypeInput === "ALL") return true;

        const sampleTypePatterns = {
          PLASMA: ["PLASMA", "MPLASMA"],
          SERUM: ["SERUM", "MSERUM"],
          "BUFFY COAT": ["BUFFY COAT", "MBUFFY COAT"],
          OTHER: ["OTHER", "MOTHER"],
          FN: ["FN", "MFN"],
          FT: ["FT", "MFT"],
        };

        const patterns = sampleTypePatterns[sampleTypeInput];
        return patterns ? patterns.some((pattern) => sampleType.startsWith(pattern)) : false;
      }

      function checkAgeCriterion(age, criterion, selectedAge) {
        if (!selectedAge) return true;

        const ageNumber = parseInt(selectedAge, 10);
        const patientAge = parseInt(age, 10);
        if (isNaN(ageNumber)) return true;

        switch (criterion) {
          case "Greater than":
            return patientAge > ageNumber;
          case "Greater than Equal to":
            return patientAge >= ageNumber;
          case "Less than Equal to":
            return patientAge <= ageNumber;
          case "Less than":
            return patientAge < ageNumber;
          case "Equal to":
            return patientAge === ageNumber;
          case "All":
            return patientAge === ageNumber;
          default:
            return true;
        }
      }

      document.getElementById("individualSearchBtn").addEventListener("click", function () {
        const sampleSearch = document.getElementById("collapseExample1");
        const individualSearch = document.getElementById("collapseExample");
        individualSearchBtn.classList.add("active");

        if (sampleSearch.classList.contains("show")) {
          sampleSearch.classList.remove("show");
          sampleSearchBtn.classList.remove("active");
        }
      });

      document.getElementById("sampleSearchBtn").addEventListener("click", function () {
        const individualSearch = document.getElementById("collapseExample");
        const sampleSearch = document.getElementById("collapseExample1");
        sampleSearchBtn.classList.add("active");
        if (individualSearch.classList.contains("show")) {
          individualSearch.classList.remove("show");
          individualSearchBtn.classList.remove("active");
        }
      });

      document.getElementById("download2").addEventListener("click", function () {
        const isAllChecked = document.getElementById("AllCheck").checked;
        if (isAllChecked) {
          if (!allDataDown || allDataDown.length === 0) {
            alert("No data to download.");
            return;
          }
          const rowPromises = allDataDown.map((row) => {
            const { bioBankId, seqKey, timestampKey, seat } = row;
            const promise1 = db
              .ref(`sef/${bioBankId}/${seqKey}/${timestampKey}/`)
              .once("value")
              .then((snapshot) => snapshot.val() || {});

            const promise2 = db
              .ref(`Fw/${bioBankId}/`)
              .limitToLast(1)
              .once("value")
              .then((snapshot) => {
                const fwdata = snapshot.val();
                let timestamp;
                let fwlastTimestamp;
                if (fwdata) {
                  timestamp = Object.keys(fwdata)[0];
                  fwlastTimestamp = fwdata[timestamp];
                  return { fwlastTimestamp, timestamp };
                }
                return { fwlastTimestamp, timestamp };
              });

            const promise3 = db
              .ref(`Os/${bioBankId}/${seqKey}`)
              .limitToLast(1)
              .once("value")
              .then((snapshot) => {
                const osdata = snapshot.val();
                let lastKey;
                if (osdata) {
                  lastKey = Object.keys(osdata)[0];
                  const oslastTimestamp = osdata[lastKey];
                  if (oslastTimestamp && oslastTimestamp.lbi) {
                    for (const box in oslastTimestamp.lbi) {
                      if (oslastTimestamp.lbi.hasOwnProperty(box)) {
                        const grids = oslastTimestamp.lbi[box];
                        if (grids.includes(seat)) {
                          return { oslastTimestamp: oslastTimestamp, lastKey: lastKey };
                        }
                      }
                    }
                  }
                  return { oslastTimestamp: oslastTimestamp, lastKey: lastKey || {} };
                } else {
                  return {};
                }
              });

            return Promise.all([promise1, promise2, promise3]).then(async ([sefData, fwData, osData]) => {
              const plasmaGrid = await decodeGridValue(sefData.ie.bpg);
              const serumGrid = await decodeGridValue(sefData.ie.bsg);
              const buffyCoatGrid = await decodeGridValue(sefData.ie.bbcg);
              const otherGrid = await decodeGridValue(sefData.ie.osg);
              const ftgGrid = await decodeGridValue(sefData.ie.ftg);
              const fngGrid = await decodeGridValue(sefData.ie.fng);
              const rltGrid = await decodeGridValue(sefData.ie.rlt);
              const pcGrid = await decodeGridValue(sefData.ie.pc);

              let oSgrid = "";
              if (osData !== null && Object.keys(osData).length !== 0) {
                const oSgridData = await formatOsData(osData.oslastTimestamp.lbi);
                oSgrid = await decodeOSGridValue(oSgridData);
              } else {
                oSgrid = "-";
              }

              return {
                bioBankId,
                seqKey,
                timestampKey,
                sefData,
                fwData,
                osData,
                plasmaGrid,
                serumGrid,
                buffyCoatGrid,
                otherGrid,
                ftgGrid,
                fngGrid,
                rltGrid,
                pcGrid,
                oSgrid,
              };
            });
          });

          downloadExcel(rowPromises);
        } else {
          const checkedBoxes = document.querySelectorAll(".selection:checked");

          if (checkedBoxes.length === 0) {
            alert("Please select a sample to download");
            return;
          }

          const selectedPatients = [];
          const promises = [];
          const rowPromises = [];
          selectedSerialNumData.forEach((data) => {
            const bioBankId = data.bioBankId;
            const seqKey = data.seqKey;
            const timestampKey = data.timestampKey;
            const gridData = data.gridData;
            const boxName = data.boxName;

            selectedPatients.push({
              bioBankId: bioBankId,
              seqKey: seqKey,
              timestampKey: timestampKey,
              gridData: gridData,
              boxName: boxName,
            });
          });

          selectedPatients.forEach((data) => {
            const bioBankId = data.bioBankId;
            const seqKey = data.seqKey;
            const timestampKey = data.timestampKey;
            const gridData = data.gridData;
            const promise1 = db
              .ref(`sef/${bioBankId}/${seqKey}/${timestampKey}/`)
              .once("value")
              .then((snapshot) => snapshot.val() || {});

            const promise2 = db
              .ref(`Fw/${bioBankId}/`)
              .limitToLast(1)
              .once("value")
              .then((snapshot) => {
                const fwdata = snapshot.val();
                let timestamp;
                let fwlastTimestamp;
                if (fwdata) {
                  timestamp = Object.keys(fwdata)[0]; // Since we are limiting to last 1, there should be only one key
                  const fwlastTimestamp = fwdata[timestamp]; // Get the lastTimestamp object using the key

                  return { fwlastTimestamp, timestamp };
                }
                return { fwlastTimestamp, timestamp };
              });

            const promise3 = db
              .ref(`Os/${bioBankId}/${seqKey}`)
              .limitToLast(1)
              .once("value")
              .then((snapshot) => {
                const osdata = snapshot.val();
                let lastKey;

                if (osdata) {
                  lastKey = Object.keys(osdata)[0]; // Since we are limiting to last 1, there should be only one key
                  const oslastTimestamp = osdata[lastKey]; // Get the lastTimestamp object using the key
                  if (oslastTimestamp && oslastTimestamp.lbi) {
                    for (const box in oslastTimestamp.lbi) {
                      if (oslastTimestamp.lbi.hasOwnProperty(box)) {
                        const grids = oslastTimestamp.lbi[box];
                        if (grids.includes(gridData)) {
                          return { oslastTimestamp: oslastTimestamp, lastKey: lastKey }; // Return structured object
                        }
                      }
                    }
                  }
                  return { oslastTimestamp: oslastTimestamp, lastKey: lastKey || {} }; // Return lastTimestamp or empty object if no match found
                } else {
                  return {}; // Return empty object if osdata does not exist
                }
              });
            const rowPromise = Promise.all([promise1, promise2, promise3]).then(async ([sefData, fwData, osData]) => {
              const plasmaGrid = await decodeGridValue(sefData.ie.bpg);
              const serumGrid = await decodeGridValue(sefData.ie.bsg);
              const buffyCoatGrid = await decodeGridValue(sefData.ie.bbcg);
              const otherGrid = await decodeGridValue(sefData.ie.osg);
              const ftgGrid = await decodeGridValue(sefData.ie.ftg);
              const fngGrid = await decodeGridValue(sefData.ie.fng);
              const rltGrid = await decodeGridValue(sefData.ie.rlt);
              const pcGrid = await decodeGridValue(sefData.ie.pc);

              let oSgrid = "";
              if (osData !== null && Object.keys(osData).length !== 0) {
                const oSgridData = await formatOsData(osData.oslastTimestamp.lbi);
                oSgrid = await decodeOSGridValue(oSgridData);
              } else {
                oSgrid = "-";
              }
              return {
                bioBankId,
                seqKey,
                timestampKey,
                sefData,
                fwData,
                osData,
                plasmaGrid,
                serumGrid,
                buffyCoatGrid,
                otherGrid,
                ftgGrid,
                fngGrid,
                rltGrid,
                pcGrid,
                oSgrid,
              };
            });

            rowPromises.push(rowPromise);
          });

          Promise.all(rowPromises)
            .then((rowsData) => {
              downloadExcel(rowsData);
            })
            .catch((error) => {
              console.error("Error fetching data for selected samples:", error);
            });
        }
      });

      function downloadExcel(rowPromises) {
        Promise.all(rowPromises)
          .then((rowsData) => {
            const excelData = rowsData.map((row) => {
              return {
                Timestamp: formatTimestamp(row.timestampKey),
                "Cancer Type": decodeProcedureType(row.sefData.ie.ct) || "-",
                "Bio Bank ID": row.bioBankId,
                Age: row.sefData.ie.ag || "-",
                Gender: decodeProcedureType(row.sefData.ie.sx) || "-",
                "Procedure Types": decodeProcedureType(row.sefData.ie.tpr),
                "Details of Procedure": row.sefData.ie.dpr || "-",
                "Surgeon Name": row.sefData.ie.srn || "-",
                "Sample at Event": decodeProcedureType(row.sefData.ie.mts) || "-",
                "Event Info": decodeProcedureType(row.sefData.ie.es) || "-",
                "Denovo metastasis": decodeProcedureType(row.sefData.ie.dm) || "-",
                "Age at Event": row.sefData.ie.ag_ms || "-",
                Site: row.sefData.ie.site || "-",
                "Receptor status post event": row.sefData.ie.rcpt || "-",
                "Tissue Sample": decodeProcedureType(row.sefData.ie.ss) || "-",
                "No of FT Tubes": row.sefData.ie.nft || "-",
                "FT Tissue Box Name": row.ftgGrid && typeof row.ftgGrid === "string" ? row.ftgGrid.split("/")[0] : "-",
                "FT Tube Grids": row.ftgGrid && typeof row.ftgGrid === "string" ? row.ftgGrid.split("/")[1] : "-",
                "No of FN Tubes": row.sefData.ie.nfn || "-",
                "FN Tissue Box Name": row.fngGrid && typeof row.fngGrid === "string" ? row.fngGrid.split("/")[0] : "-",
                "FN Tube Grids": row.fngGrid && typeof row.fngGrid === "string" ? row.fngGrid.split("/")[1] : "-",
                "Blood Sample": decodeProcedureType(row.sefData.ie.bs) || "-",
                "Blood box name(Serum)": row.serumGrid && typeof row.serumGrid === "string" ? row.serumGrid.split("/")[0] : "-",
                "Serum Grid": row.serumGrid && typeof row.serumGrid === "string" ? row.serumGrid.split("/")[1] : "-",
                "Blood box name(Plasma)": row.plasmaGrid && typeof row.plasmaGrid === "string" ? row.plasmaGrid.split("/")[0] : "-",
                "Plasma Grid": row.plasmaGrid && typeof row.plasmaGrid === "string" ? row.plasmaGrid.split("/")[1] : "-",
                "Blood box name(Buffy coat)": row.buffyCoatGrid && typeof row.buffyCoatGrid === "string" ? row.buffyCoatGrid.split("/")[0] : "-",
                "Buffy Coat Grid": row.buffyCoatGrid && typeof row.buffyCoatGrid === "string" ? row.buffyCoatGrid.split("/")[1] : "-",
                "Other Sample": decodeProcedureType(row.sefData.ie.osmp) || "-",
                "Other Sample box name": row.otherGrid && typeof row.otherGrid === "string" ? row.otherGrid.split("/")[0] : "-",
                "Other Sample Grid": row.otherGrid && typeof row.otherGrid === "string" ? row.otherGrid.split("/")[1] : "-",
                "Other Sample description": row.sefData.ie.osdsc || "-",
                "RLT Sample": decodeProcedureType(row.sefData.ie.rltS) || "-",
                "RLT Sample Box name": row.rltGrid && typeof row.rltGrid === "string" ? row.rltGrid.split("/")[0] : "-",
                "RLT Sample Grid": row.rltGrid && typeof row.rltGrid === "string" ? row.rltGrid.split("/")[1] : "-",
                "Primary Culture Sample": decodeProcedureType(row.sefData.ie.pcS) || "-",
                "Is Primary Culture Viable": row.sefData.ie.pssvl || "-",
                "Primary Culture Sample Box name": row.pcGrid && typeof row.pcGrid === "string" ? row.pcGrid.split("/")[0] : "-",
                "Primary Culture Sample Grids": row.pcGrid && typeof row.pcGrid === "string" ? row.pcGrid.split("/")[1] : "-",
                Consent: decodeProcedureType(row.sefData.ie.cnst) || "-",
                "Ischemic Sample": decodeProcedureType(row.sefData.ie.iss) || "-",
                NACT: decodeProcedureType(row.sefData.ie.nact) || "-",
                "Treatment effect in Breast": decodeProcedureType(row.sefData.ie.nactEff) || "-",
                "NACT Drug Cycles": row.sefData.ie.nactdc || "-",
                "NACT date of last cycle": row.sefData.ie.nactdlc || "-",
                "All sample Received together?": decodeProcedureType(row.sefData.ie.scpt) || "-",
                "Processed By": row.sefData.ie.prb || "-",
                "Received Time": formatTimestamp(row.sefData.ie.srt) || "-",
                "Processed Time": formatTimestamp(row.sefData.ie.spt) || "-",
                "Blood Sample Processed By": row.sefData.ie.bspb || "-",
                "Blood Sample Received Time": formatTimestamp(row.sefData.ie.brt) || "-",
                "Blood Sample Processed Time": formatTimestamp(row.sefData.ie.bpt) || "-",
                "Tissue Sample Processed by": row.sefData.ie.sspb || "-",
                "Tissue Sample Received Time": formatTimestamp(row.sefData.ie.sprt) || "-",
                "Tissue Sample Processed Time": formatTimestamp(row.sefData.ie.sppt) || "-",
                "Other Sample Processed by": row.sefData.ie.ospb || "-",
                "Other Sample Received Time": formatTimestamp(row.sefData.ie.ospt) || "-",
                "Other Sample Processed Time": formatTimestamp(row.sefData.ie.osrt) || "-",
                "RLT Sample processed by": row.sefData.ie.rltpb || "-",
                "RLT Sample Received Time": formatTimestamp(row.sefData.ie.rspt) || "-",
                "RLT Sample processed Time": formatTimestamp(row.sefData.ie.rsrt) || "-",
                "Primary Culture Sample processed by": row.sefData.ie.psspb || "-",
                "Primary Culture Sample Received Time": formatTimestamp(row.sefData.ie.pspt) || "-",
                "Primary Culture Sample processed Time": formatTimestamp(row.sefData.ie.psrt) || "-",
                "Data Entry By": row.sefData.ie.sef_ub || "-",
                "Family History Cancer": decodeProcedureType(row.sefData.md.fhc),
                "Family Relation": row.sefData.md.fhcr || "-",
                "Family Cancer Type": row.sefData.md.fhct || "-",
                "Food Habbits": row.sefData.md.fh === "true" ? "Veg" : row.sefData.md.fh === "false" ? "Non-Veg" : "-",
                "History Of Alcohol Consumption": decodeProcedureType(row.sefData.md.hac) || "-",
                "History Of Smoking": decodeProcedureType(row.sefData.md.hs) || "-",
                "Existing Comorbidities": decodeProcedureType(row.sefData.md.ec) || "-",
                "Type 2 Diabetic Mellitus": findComorb("diabetic", row.sefData.md.cm),
                "Cardiac History": findComorb("cardiac", row.sefData.md.cm),
                Hypertension: findComorb("hypertension", row.sefData.md.cm),
                "Other Comorbidities": findComorb("other1", row.sefData.md.cm),
                "Other medications": findComorb("other2", row.sefData.md.cm),
                "FF QC comments": row.sefData.md.ffqc || "-",
                "FF Tissue Remarks": row.sefData.md.ftr || "-",
                "Tumor Site": decodeProcedureType(row.sefData.md.tst) || "-",
                "Tumor Percentage": row.sefData.md.tp || "-",
                "Age At Diagnosis": row.sefData.md.ad || "-",
                "Clinical Stage ": row.sefData.md.cs || "-",
                "IHC Marker status": decodeProcedureType(row.sefData.md.ihcm) || "-",
                "IHC marker description": row.sefData.md.ihcd || "-",
                "Genetic Testing": decodeProcedureType(row.sefData.md.gt) || "-",
                "Genetic Testing Results": decodeProcedureType(row.sefData.md.gtrs) || "-",
                "Genetic Testing Description": row.sefData.md.gtd || "-",
                "Histological Subtype": decodeProcedureType(row.sefData.md.pst) || "-",
                "Other Subtype": row.sefData.md.pstOt || "-",
                Grade: decodeGrade(row.sefData.md.gd) || "-",
                Focality: row.sefData.md.fc === "true" ? "Unifocal" : row.sefData.md.fc === "false" ? "Multifocal" : "-",
                DCIS: decodeProcedureType(row.sefData.md.dcis) || "-",
                "DCIS grade": row.sefData.md.dcisgd || "-",
                LVI: decodeProcedureType(row.sefData.md.lvi) || "-",
                PNI: decodeProcedureType(row.sefData.md.pni) || "-",
                pTNM: row.sefData.md.ptnm || "-",
                "AJCC Staging": row.sefData.md.as || "-",
                "Number Of Nodes Tested": row.sefData.md.nnt || "-",
                "Number Of Positive Nodes": row.sefData.md.npn || "-",
                "Tumor Size": row.sefData.md.tsz === "xx" || row.sefData.md.tsz === undefined ? "-" : row.sefData.md.tsz,
                "RCB Score": row.sefData.md.rcbs || "-",
                "RCB Class": row.sefData.md.rcbc || "-",
                ACT: decodeProcedureType(row.sefData.md.act) || "-",
                "ACT Drug Cycles": row.sefData.md.actdc || "-",
                "ACT Date of last Cycle": row.sefData.md.actdls || "-",
                Radiotherapy: decodeProcedureType(row.sefData.md.rd) || "-",
                "Dosage & Fractions": row.sefData.md.rdd1 || "-",
                Technique: row.sefData.md.rdd2 || "-",
                Quadrant: row.sefData.md.rdd3 || "-",
                "Radiotherapy Date of last Cycle": row.sefData.md.rtdls || "-",
                "Hormonal Therapy": decodeProcedureType(row.sefData.md.hrt) || "-",
                "Hormonal Therapy Details": row.sefData.md.hrtD || "-",
                "Targeted Therapy": decodeProcedureType(row.sefData.md.trt) || "-",
                "Targeted Therapy Details": row.sefData.md.trtD || "-",
                "Is paraffin Block Available ": decodeProcedureType(row.sefData.md.ipba) || "-",
                "Paraffin Block Number": row.sefData.md.ipbainfo || "-",
                "Metadata updated by": row.sefData.md.mdu || "-",
                "Age Of Menarche": row.sefData.brf.am || "-",
                Parity: row.sefData.brf.pty || "-",
                "No Of Children": row.sefData.brf.noc || "-",
                "Age At First Childbirth": row.sefData.brf.afc || "-",
                Breastfed: decodeProcedureType(row.sefData.brf.bf) || "-",
                "Duration Breast feeding": row.sefData.brf.dbf || "-",
                "Menopausal Status": row.sefData.brf.ms || "-",
                ER: decodeProcedureType(row.sefData.brf.er) || "-",
                PR: row.sefData.brf.pr || "-",
                HER2: decodeProcedureType(row.sefData.brf.h2) || "-",
                Subtype: decodeProcedureType(row.sefData.brf.sbt) || "-",
                Ki67: row.sefData.brf.k67 || "-",
                "BIRADS Score": row.sefData.brf.ht || "-",
                "PET CT SUV Max": row.sefData.brf.pcsm || "-",
                "PET CT Volume": row.sefData.brf.pcvm || "-",
                "sTILs Percent Scores": row.sefData.brf.sps || "-",
                "BR Specific form updated by": row.sefData.brf.brfu || "-",
                "follow Up Time": formatTimestamp(Math.floor(row.fwData?.timestamp) / 1000) || "-",
                "Last Followup status": decodeFollowUpType(row.fwData?.fwlastTimestamp?.lfs) || "-",
                "Other reason": row.fwData?.fwlastTimestamp?.othrs || "-",
                "Last Follow up Date": row.fwData?.fwlastTimestamp?.lfd || "-",
                "Reason For lost to follow up": row.fwData?.fwlastTimestamp?.rlfw || "-",
                "Recurrence Date": row.fwData?.fwlastTimestamp?.rd || "-",
                "Reported Date for Progressive Disease": row.fwData?.fwlastTimestamp?.rdpd || "-",
                "Progression metastasis remark": row.fwData?.fwlastTimestamp?.pet || "-",
                "Vital Status": row.fwData?.fwlastTimestamp?.vs || "-",
                "Death Date": row.fwData?.fwlastTimestamp?.dd || "-",
                Remarks: row.fwData?.fwlastTimestamp?.rmks || "-",
                "Treatment Completed": row.fwData?.fwlastTimestamp?.tc || "-",
                "followUp updated by": row.fwData?.fwlastTimestamp?.fw_ub || "-",

                "Shared Date - Time": formatTimestamp(row.osData?.lastKey) || "-",
                "Shared Date": row.osData?.oslastTimestamp?.doe || "-",
                "Shared Grid": row.oSgrid,
                "Institute or Department": row.osData?.oslastTimestamp?.dpt || "-",
                Project: row.osData?.oslastTimestamp?.prj || "-",
                "PI of the Project": row.osData?.oslastTimestamp?.pip || "-",
                "Shared status": decodeFollowUpType(row.osData?.oslastTimestamp?.ossts) || "-",
                "Partial shared remark": row.osData?.oslastTimestamp?.psr || "-",
                "Shared form updated by": row.osData?.oslastTimestamp?.os_ub || "-",
              };
            });

            function imageToBase64(url) {
              return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Handle CORS
                img.onload = () => {
                  const canvas = document.createElement("canvas");
                  canvas.width = img.width;
                  canvas.height = img.height;
                  const ctx = canvas.getContext("2d");
                  ctx.drawImage(img, 0, 0);
                  resolve(canvas.toDataURL("image/png").split(",")[1]); // Return base64 string without prefix
                };
                img.onerror = (error) => reject(error);
                img.src = url;
              });
            }
            Promise.all([imageToBase64("./assets/images/main_logo.png")]).then(([img1Base64]) => {
              const workbook = new ExcelJS.Workbook();
              const worksheet = workbook.addWorksheet("BioBank Data");

              const imageId1 = workbook.addImage({
                base64: img1Base64,
                extension: "png",
              });

              worksheet.addImage(imageId1, {
                tl: { col: 0, row: 0 },
                br: { col: 2, row: 8 },
              });
              const headers = Object.keys(excelData[0] || {});
              for (let i = 0; i < 7; i++) {
                worksheet.addRow([]);
              }
              const headerRow = worksheet.addRow(headers);
              headerRow.eachCell((cell) => {
                cell.font = { bold: true };
                cell.border = {
                  top: { style: "thin" },
                  left: { style: "thin" },
                  bottom: { style: "thin" },
                  right: { style: "thin" },
                };
              });
              const colWidths = headers.map((h) => h.length);
              excelData.forEach((rowData) => {
                const rowValues = headers.map((h) => rowData[h]);
                const row = worksheet.addRow(rowValues);

                rowValues.forEach((cellValue, colIdx) => {
                  const cell = row.getCell(colIdx + 1);
                  const cellStr = cellValue ? cellValue.toString() : "";
                  if (cellStr.length > colWidths[colIdx]) colWidths[colIdx] = cellStr.length;
                  cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" },
                  };
                });
              });
              worksheet.columns.forEach((col, idx) => {
                const width = Math.min(Math.max(colWidths[idx] + 2, 10), 50);
                col.width = width;
              });
              const current = new Date();
              const formattedDate = current.toLocaleDateString("en-GB", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
              });
              workbook.xlsx.writeBuffer().then((buffer) => {
                const blob = new Blob([buffer], {
                  type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `BioBank_Data_${formattedDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
              });
            });
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
      }

      window.onload = function () {
        localStorage.setItem("sampleTypeInput", "All");
      };

      const TypeMapping = {
        b: "Biopsy",
        r: "Resection",
        Y: "Yes",
        N: "No",
        true: "Yes",
        false: "No",
        brst: "Breast Cancer",
        F: "Female",
        M: "Male",
        BL: "Bilateral",
        R: "Right",
        L: "Left",
        option1: "No residual invasive carcinoma",
        option2: "Invasive carcinoma of no special type(ductal)",
        option3: "Micro - invasive carcinoma",
        option4: "Invasive lobular carcinoma",
        option5: "Invasive carcinoma with mixed ductal and lobular features",
        option6: "Invasive carcinoma with features of(specify)",
        option7: "Tubular carcinoma",
        option8: "Invasive cribriform carcinoma",
        option9: "Mucinous carcinoma",
        option10: "Invasive micropapillary carcinoma",
        option11: "Apocrine adenocarcinoma",
        option12: "Metaplastic carcinoma",
        option13: "Encapsulated papillary carcinoma with invasion",
        option14: "Solid papillary carcinoma with invasion",
        option15: "Intraductal papillary adenocarcinoma with invasion",
        option16: "Adenoid cystic carcinoma",
        option17: "Neuroendocrine tumor",
        option18: "Neuroendocrine carcinoma",
        option19: "Invasive carcinoma, type cannot be determined:",
        other: "Other histologic type not listed(specify)",
        s: "Shared",
        ps: "Partially Shared",
        op1: "No known presurgical therapy",
        op2: "No definitive response to presurgical therapy in the invasive carcinoma",
        op3: "Probable or definite response to presurgical therapy in the invasive carcinoma",
        op4: "No residual invasive carcinoma is present in the breast after presurgical therapy",
        pos: "Positive",
        nev: "Negative",
        vus: "Variant of Uncertain Significance",
        Local_Recurrence: "Local Recurrence",
        Contralateral_Recurrence: "Contralateral Recurrence",
        Distant_Metastasis: "Distant Metastasis",
        Low_ER: "Low ER",
        Low_Her2: "Low Her2",
        Positive: "Positive",
        Negative: "Negative",
        "HR positive": "HR Positive",
        "Her2 enriched": "Her2 enriched",
        "Triple positive": "Triple positive",
        HR_positive_HER2_negative: "HR positive HER2 negative",
        HR_positive_HER2_positive: "HR positive HER2 positive",
        HR_negative_HER2_negative: "HR negative HER2 negative",
        TNBC: "TNBC",
      };

      function decodeProcedureType(encodedValue) {
        return TypeMapping[encodedValue] || "-"; // Fallback to 'Unknown' if the value is not in the mapping
      }
      function decodeGrade(encodedValue) {
        if (encodedValue === "grade1") return "Grade 1";
        if (encodedValue === "grade2") return "Grade 2";
        if (encodedValue === "grade3") return "Grade 3";
        return encodedValue || "-"; // Fallback to 'Unknown' if the value is not in the mapping
      }
      function findComorb(name, data) {
        if (!Array.isArray(data)) return "-"; // Safely handle undefined or non-array
        if (name === "other1" || name === "other2") {
          const item = data.find((c) => c.selectedOption && c.selectedOption.toLowerCase().includes("other"));
          if (!item) return "-";
          if (name === "other1") {
            return item.textValue?.input1 || "-";
          } else if (name === "other2") {
            return item.textValue?.input2 || "-";
          } else {
            return "-";
          }
        }
        const item = data.find((c) => c.selectedOption && c.selectedOption.toLowerCase().includes(name.toLowerCase()));
        if (!item) return "-";
        return item.textValue || "-"; // Return the selected option or "-" if not found
      }

      const TypeFollowUp = {
        DiseaseF: "Disease Free",
        Recurrence: "Recurrence",
        diseasePro: "Disease Progressive",
        death_Dise: "Death due to disease",
        Lost_Follow: "Lost to Follow up",
        death_n_Dise: "Death not due to disease",
        UnderTreat: "Under Treatment",
        StabDis: "Stable Disease",
        metastasis: "Metastasis",
        Other: "Other",
        s: "Shared",
        ps: "Partially Shared",
      };

      function decodeFollowUpType(encodedValue) {
        return TypeFollowUp[encodedValue] || "-"; // Fallback to 'Unknown' if the value is not in the mapping
      }

      function decodeGridValue(gridValue) {
        return new Promise((resolve, reject) => {
          if (gridValue) {
            let parts = gridValue.split("/");
            let boxName = parts[0];

            const storedBnData = JSON.parse(localStorage.getItem("bnData"));
            const boxEntry = storedBnData.find((entry) => entry.id === boxName);

            if (boxEntry) {
              parts[0] = boxEntry.name; // Replace the ID with the corresponding name
              const updatedGridNo = parts.join("/");
              resolve(updatedGridNo);
            } else {
              resolve(gridValue); // If no match found, resolve with the original value
            }
          } else {
            resolve(null); // If gridValue is null or undefined, resolve with null
          }
        });
      }

      async function formatOsData(lib) {
        let result = [];
        if (lib) {
          for (let key in lib) {
            if (lib[key] && Array.isArray(lib[key])) {
              let formattedValue = `${key}/${lib[key].join(",")}`;
              result.push(formattedValue);
            }
          }
        }

        return result.join("; ");
      }

      function decodeOSGridValue(gridValue) {
        return new Promise((resolve, reject) => {
          if (gridValue) {
            let gridParts = [];
            let processedGridParts = [];

            if (gridValue.includes(";")) {
              gridParts = gridValue.split("; ");
              const storedBnData = JSON.parse(localStorage.getItem("bnData"));

              gridParts.forEach((part) => {
                let parts = part.split("/");
                let boxName = parts[0];

                const boxEntry = storedBnData.find((entry) => entry.id === boxName);

                if (boxEntry) {
                  parts[0] = boxEntry.name;
                  const updatedGridNo = parts.join(": ");
                  processedGridParts.push(updatedGridNo);
                } else {
                  processedGridParts.push(part);
                }
              });

              resolve(processedGridParts.join("; "));
            } else {
              gridParts = gridValue;
              let parts = gridValue.split("/");
              let boxName = parts[0];

              const storedBnData = JSON.parse(localStorage.getItem("bnData"));
              const boxEntry = storedBnData.find((entry) => entry.id === boxName);

              if (boxEntry) {
                parts[0] = boxEntry.name; // Replace the ID with the corresponding name
                const updatedGridNo = parts.join(": ");
                resolve(updatedGridNo);
              } else {
                resolve(gridValue); // If no match found, resolve with the original value
              }
            }
          } else {
            resolve(null);
          }
        });
      }
      function exportToExcel(blob, filename) {
        if (window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveOrOpenBlob(blob, filename);
        } else {
          const url = window.URL.createObjectURL(blob);
          var a = document.createElement("a");
          document.body.appendChild(a);
          a.href = url;
          a.download = filename;
          a.click();
        }
      }
    </script>
    <script>
      $(document).ready(function () {
        $(".sampleCheck").change(function () {
          if ($(this).val() === "All" && $(this).is(":checked")) {
            $(".sampleCheck").prop("checked", true);
          } else if ($(this).val() === "All" && !$(this).is(":checked")) {
            $(".sampleCheck").prop("checked", false);
          } else {
            if (!$(this).is(":checked")) {
              $("input[value='All']").prop("checked", false);
            } else if ($(".sampleCheck:not([value='All'])").length === $(".sampleCheck:not([value='All']):checked").length) {
              $("input[value='All']").prop("checked", true);
            }
          }
        });
      });

      document.getElementById("sampleDropdown").addEventListener("click", function () {
        let dropdownMenu = this.nextElementSibling;
        if (dropdownMenu.classList.contains("show")) {
          dropdownMenu.classList.remove("show");
        } else {
          dropdownMenu.classList.add("show");
        }
      });

      document.addEventListener("click", function (event) {
        let dropdownButton = document.getElementById("sampleDropdown");
        let dropdownMenu = dropdownButton.nextElementSibling;

        if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
          dropdownMenu.classList.remove("show");
        }
      });
      document.getElementById("sampleReset").addEventListener("click", function () {
        document.getElementById("sampleSearchForm").reset();
      });
    </script>
    <script>
      function updateSampleDropdown() {
        const selectedCheckboxes = document.querySelectorAll('input[name="sampleType"]:checked');
        const selectedValues = Array.from(selectedCheckboxes)
          .map((checkbox) => checkbox.value)
          .filter((value) => value !== "All");
        const dropdownInput = document.getElementById("sampleDropdown");

        if (selectedValues.length === 0) {
          dropdownInput.value = "None";
        }
        if (selectedValues.length === 1) {
          dropdownInput.value = selectedValues[0];
        }
        if (selectedValues.length === 8) {
          dropdownInput.value = "All";
        }
        if (selectedValues.length > 1 && selectedValues.length < 8 && !selectedValues.includes("All")) {
          dropdownInput.value = `${selectedValues[0]} +${selectedValues.length - 1}`;
        }
      }

      document.querySelectorAll('input[name="sampleType"]').forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          if (this.value === "All") {
            if (this.checked) {
              document.querySelectorAll('input[name="sampleType"]').forEach((cb) => (cb.checked = true));
            } else {
              document.querySelectorAll('input[name="sampleType"]').forEach((cb) => (cb.checked = false));
            }
          }
          updateSampleDropdown();
        });
      });
      updateSampleDropdown();
    </script>
  </body>
</html>
