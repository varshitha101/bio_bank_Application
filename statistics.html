<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bio Bank</title>
    <link rel="icon" type="image/png" href="assets/images/main_logo.png" />
    <!--Google Fonts and Icons-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.0.2/dist/echarts.min.js"></script>
    <script src="chart.js"></script>

    <link rel="stylesheet" href="assets/css/statistics.css" />
    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous" />
    <!-- Load full jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>

    <!-- Then Bootstrap Datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Bootstrap Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="index.js"></script>
    <style>
      .todo-badge {
        position: absolute;
        top: 0;
        right: 0;
        transform: translate(60%, -40%);
        font-size: 0.65rem;
        line-height: 1;
        padding: 0.25em 0.45em;
        display: none;
      }
    </style>
  </head>

  <body>
    <img class="navbar-image-logo2" src="assets/images/bio_bank_option1.png" style="position: absolute; top: 8px; left: 8px; width: 100px; height: 96px; z-index: 2000; pointer-events: none" />
    <nav class="navbar sticky-top navbar-expand-lg navbar-light" style="background-color: rgba(25, 145, 201, 1); width: 500px; margin: 0 auto; padding: 5px">
      <div class="container-fluid">
        <a class="navbar-brand" style="background-color: #fff"> </a>
        <div class="mx-auto p-2">
          <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
              <a class="nav-link active" style="background-color: #00ffa147" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="home.html">Sample</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="search.html">Search</a>
            </li>
            <li class="nav-item position-relative">
              <a class="nav-link" href="todo.html">To-Do list<span id="todoBadge" class="badge badge-pill badge-danger todo-badge">0</span></a>
            </li>
          </ul>
        </div>
        <div id="loading" class="spinmodal" style="display: none">
          <!-- Initially hidden -->
          <div class="spinmodal-content">
            <div class="row">
              <div class="col-4">
                <div class="spinner"></div>
                <!-- Spinner circle -->
              </div>
              <div class="col-8">
                <h3 style="align-content: center; padding-top: 20px">Loading...</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div
      class="d-flex ms-auto align-items-center justify-content-center"
      style="position: absolute; top: 8px; right: 8px; z-index: 2000; pointer-events: auto; background-color: rgba(25, 145, 201, 1); width: 50px; height: 50px">
      <button
        onclick="logout()"
        id="logout"
        type="button"
        class="btn btn-link p-0 w-100 h-100 d-flex align-items-center justify-content-center"
        aria-label="Logout"
        title="Logout"
        style="line-height: 1">
        <span class="material-icons text-white" style="font-size: 28px">logout</span>
      </button>
    </div>
    <div class="wrapper container">
      <div class="row" style="justify-content: center">
        <div class="form-group col-xs-2 mr-2">
          <label for="optionInput">Date</label>
          <select id="optionInput" class="form-control">
            <!-- <option value="select" selected>Select</option> -->
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group col-xs-2 mr-2">
          <label for="startInput">From</label>
          <input type="text" id="startInput" class="form-control" placeholder="Select start date" disabled />
        </div>
        <!-- To Date/Month Picker -->
        <div class="form-group col-xs-2">
          <label for="endInput">To</label>
          <input type="text" id="endInput" class="form-control" placeholder="Select end date" disabled />
        </div>
        <!-- Submit Button -->
        <div class="form-group col-1">
          <label for="searchBtn">Search</label>
          <button type="submit" class="btn btn-primary" id="searchBtn">Submit</button>
        </div>
      </div>
      <div class="row">
        <div class="container mt-5 col-lg-6">
          <h4 class="section-title" style="color: #0099e0; font-weight: bolder">Total Samples: <span id="samples"></span></h4>
        </div>
      </div>
      <div class="row">
        <div class="container mt-5 col-lg-6">
          <h6 class="section-title">Age Segregation</h6>
          <div id="chart1" style="width: 100%; height: 250px"></div>
        </div>
        <div class="container mt-5 col-lg-6">
          <h6 class="section-title">Type of Cancer</h6>
          <div id="chart2" style="width: 100%; height: 250px"></div>
        </div>
      </div>
      <div class="row">
        <div class="container mt-5 col-lg-6">
          <h6 class="section-title">Procedure</h6>
          <div id="chart3" style="width: 100%; height: 250px"></div>
        </div>
        <div class="container mt-5 col-lg-6">
          <h6 class="section-title">Sample Type</h6>
          <div id="chart4" style="width: 100%; height: 250px"></div>
        </div>
      </div>
    </div>
    <footer id="footer">
      <div class="container footer-bottom clearfix">
        <div class="copyright">
          &copy; Copyright <strong><span></span></strong>. All Rights Reserved
        </div>
        <div class="credits"></div>
        <div class="version" style="float: right; font-size: 12px; color: rgb(255, 255, 255)">Version 1.7.12</div>
      </div>
    </footer>
    <script src="chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
      if (!sessionStorage.getItem("isLoggedIn") || sessionStorage.getItem("isLoggedIn") !== "true") {
        window.location.href = "login.html";
      }
      $(document).ready(function () {
        let startInput = $("#startInput");
        let endInput = $("#endInput");

        $("#optionInput").on("change", function () {
          let selectedOption = $(this).val();

          console.log("Selected Log ", selectedOption);
          startInput.val("");
          endInput.val("");

          localStorage.removeItem("startInput");
          localStorage.removeItem("endInput");

          startInput.datepicker("destroy");
          endInput.datepicker("destroy");

          if (selectedOption === "day") {
            let currentDate = new Date();
            let formattedDate = currentDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });

            startInput.attr("placeholder", formattedDate);
            endInput.attr("placeholder", formattedDate);

            startInput.attr("disabled", true);
            endInput.attr("disabled", true);
            localStorage.setItem("startInput", formattedDate);
            localStorage.setItem("endInput", formattedDate);
          } else if (selectedOption === "month") {
            let currentDate = new Date();
            let startDate = new Date(currentDate);
            startDate.setDate(currentDate.getDate() - 30); // 30 days ago
            let endDate = currentDate;
            let formattedStartDate = startDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });
            let formattedEndDate = endDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });
            startInput.attr("placeholder", formattedStartDate);
            endInput.attr("placeholder", formattedEndDate);
            startInput.attr("disabled", true);
            endInput.attr("disabled", true);
            localStorage.setItem("startInput", formattedStartDate);
            localStorage.setItem("endInput", formattedEndDate);

            console.log("inside week start ", formattedStartDate);
            console.log("inside week end ", formattedEndDate);
          } else if (selectedOption === "week") {
            let currentDate = new Date();

            let startDate = new Date(currentDate);
            startDate.setDate(currentDate.getDate() - 7); // 30 days ago
            let endDate = currentDate;
            let formattedStartDate = startDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });
            let formattedEndDate = endDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });

            startInput.attr("placeholder", formattedStartDate);
            endInput.attr("placeholder", formattedEndDate);

            startInput.attr("disabled", true);
            endInput.attr("disabled", true);
            localStorage.setItem("startInput", formattedStartDate);
            localStorage.setItem("endInput", formattedEndDate);
          } else if (selectedOption === "custom") {
            startInput.attr("disabled", false);
            endInput.attr("disabled", false);
            startInput.attr("placeholder", "Start date");
            endInput.attr("placeholder", "End date");

            startInput
              .datepicker({
                format: "dd/mm/yyyy",
                autoclose: true,
                todayHighlight: true,
              })
              .on("change", function () {
                var st = this.value;
                console.log(" inside custom s : ", st);
                let currentDate = new Date();
                let sunday = new Date(currentDate.setDate(st));

                let formattedSunday = sunday.toLocaleDateString("en-In", {
                  year: "numeric",
                  month: "2-digit",
                  day: "2-digit",
                });

                localStorage.setItem("startInput", st);
              });

            endInput
              .datepicker({
                format: "dd/mm/yyyy",
                autoclose: true,
                todayHighlight: true,
              })
              .on("change", function () {
                var et = this.value;
                let currentDate = new Date();
                console.log(" inside custom e : ", et);
                let endday = new Date(currentDate.setDate(et));

                let eformattedDate = endday.toLocaleDateString("en-In", {
                  year: "numeric",
                  month: "2-digit",
                  day: "2-digit",
                });

                localStorage.setItem("endInput", et);
              });
          } else {
            console.error("Invalid date format. Please enter dates in dd/mm/yyyy format.");
          }
        });
      });
    </script>

    <script>
      function convertToTimestamp(dateStr, endOfDay = false) {
        const [day, month, year] = dateStr.split("/").map(Number);
        const date = new Date(year, month - 1, day);

        if (endOfDay) {
          date.setHours(23, 59, 59, 999);
        } else {
          date.setHours(0, 0, 0, 0);
        }

        return date.getTime(); // Timestamp in milliseconds
      }
      function formatDateString(dateStr) {
        const [day, month, year] = dateStr.split("/").map(Number);
        return new Date(year, month - 1, day).toLocaleDateString("en-IN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
      }

      function logout() {
        sessionStorage.removeItem("isLoggedIn");
        sessionStorage.removeItem("userName");
        window.location.href = "login.html";
      }
    </script>
    <script>
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.database(app);
      let clickEvent = false;
      window.onload = function () {
        document.getElementById("optionInput").value = "select";
        localStorage.setItem("startInput", "");
        localStorage.setItem("endInput", "");
        clickEvent = true;
        document.getElementById("optionInput").value = "month";
        $("#optionInput").trigger("change"); // Trigger the change event to load the data
        let currentDate = new Date();
        let startDate = new Date(currentDate);
        startDate.setDate(currentDate.getDate() - 30); // 30 days ago
        let endDate = currentDate;
        let formattedStartDate = startDate.toLocaleDateString("en-IN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        let formattedEndDate = endDate.toLocaleDateString("en-IN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        $("#startInput").attr("placeholder", formattedStartDate);
        $("#endInput").attr("placeholder", formattedEndDate);
        $("#startInput").attr("disabled", true);
        $("#endInput").attr("disabled", true);
        localStorage.setItem("startInput", formattedStartDate);
        localStorage.setItem("endInput", formattedEndDate);
        document.getElementById("searchBtn").click(); // Simulate a click on the search button to load data
      };

      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("searchBtn").addEventListener("click", function (event) {
          event.preventDefault();
          if (!clickEvent) {
            searchLoadingModal();
          }
          clickEvent = false;
          let startDate = localStorage.getItem("startInput");
          let endDate = localStorage.getItem("endInput");
          if (!startDate || !endDate) {
            hideLoadingModal();
            alert("Please select From and To Date");
            return; // Exit the function if dates are not valid
          }

          db.ref("Patients")
            .once("value")
            .then((snapshot) => {
              const patientsData = snapshot.val();

              if (patientsData) {
                let countUnder30 = 0;
                let count30to40 = 0;
                let count41to50 = 0;
                let count51to60 = 0;
                let countAbove60 = 0;

                let breastCancer = 0;
                let throatCancer = 0;
                let liverCancer = 0;
                let lungCancer = 0;

                let biopsy = 0;
                let resection = 0;
                let bothProcedures = 0;
                let countBS = 0; // Blood Samples
                let countSS = 0; // Specimen Samples
                let countOS = 0; // Other Samples
                let countRLT = 0; // Other Samples
                let countPC = 0; // Other Samples

                let countCombined = 0; // Combined Samples

                let count = 0; // This will count the total number of sequences (s1, s2, etc.) that meet the timestamp condition

                let agesArray = [];
                let cncrTypeArray = [];

                let startDate = localStorage.getItem("startInput");
                let endDate = localStorage.getItem("endInput");

                let mytime = 0;
                if (startDate !== "" && endDate !== "") {
                  let startTimestamp = getTimestamp(startDate); // Start of the day timestamp
                  let endTimestamp = getTimestamp(endDate, true); // End of the day timestamp

                  Object.keys(patientsData).forEach((bioBankId) => {
                    const sectionData = patientsData[bioBankId];
                    const timeStampArray = [];
                    if (sectionData) {
                      Object.keys(sectionData).forEach((sectionKey) => {
                        if (sectionKey.startsWith("s")) {
                          const section = sectionData[sectionKey];
                          if (section && section.ts) {
                            timeStampArray.push(section.ts * 1000); // Convert to milliseconds
                          }
                        }
                      });
                    }

                    const filteredTimeStamps = timeStampArray.filter((ts) => ts >= startTimestamp && ts <= endTimestamp);
                    const maxTimestamp = Math.max(...filteredTimeStamps);
                    const maxSectionData = Object.keys(sectionData).reduce((acc, key) => {
                      if (key.startsWith("s") && sectionData[key].ts * 1000 === maxTimestamp) {
                        acc = sectionData[key];
                      }
                      return acc;
                    }, {});
                    if (maxSectionData && maxSectionData.ts) {
                      console.log("Max Section Data:", maxSectionData);

                      count++;
                      const age = parseInt(maxSectionData?.age) || "";
                      const cancer = maxSectionData?.ct || "";
                      const gender = maxSectionData?.gndr || "";
                      const procedure = maxSectionData?.typ || "";

                      const smty = maxSectionData?.smty !== "" ? maxSectionData?.smty.split(",") || [] : []; // Split the sample types string into an array

                      if (age < 30) countUnder30++;
                      else if (age >= 30 && age <= 40) count30to40++;
                      else if (age >= 41 && age <= 50) count41to50++;
                      else if (age >= 51 && age <= 60) count51to60++;
                      else if (age > 60) countAbove60++;

                      if (cancer === "brst") breastCancer++;
                      else if (cancer === "throat") throatCancer++;
                      else if (cancer === "liver") liverCancer++;
                      else if (cancer === "lung") lungCancer++;

                      if (procedure === "b") biopsy++;
                      else if (procedure === "r") resection++;

                      let hasBlood = smty.includes("B");
                      let hasSpecimen = smty.includes("S");
                      let hasOther = smty.includes("O");
                      let hasRLT = smty.includes("R");
                      let hasPC = smty.includes("P");

                      if (
                        (hasBlood && hasSpecimen) ||
                        (hasBlood && hasOther) ||
                        (hasBlood && hasRLT) ||
                        (hasBlood && hasPC) ||
                        (hasSpecimen && hasOther) ||
                        (hasSpecimen && hasRLT) ||
                        (hasSpecimen && hasPC) ||
                        (hasOther && hasRLT) ||
                        (hasOther && hasPC) ||
                        (hasRLT && hasPC)
                      ) {
                        countCombined++; // Increment combined count
                      } else if (hasBlood && !hasSpecimen && !hasOther && !hasRLT && !hasPC) {
                        countBS++; // Increment blood count
                      } else if (hasSpecimen && !hasBlood && !hasOther && !hasRLT && !hasPC) {
                        countSS++; // Increment specimen count
                      } else if (hasOther && !hasBlood && !hasSpecimen && !hasRLT && !hasPC) {
                        countOS++; // Increment other count
                      } else if (hasRLT && !hasBlood && !hasSpecimen && !hasOther && !hasPC) {
                        countRLT++; // Increment RLT count
                      } else if (hasPC && !hasBlood && !hasSpecimen && !hasOther && !hasRLT) {
                        countPC++; // Increment PC count
                      }
                    }
                  });

                  document.getElementById("samples").innerHTML = count;

                  const ageCategoryCounts = {
                    under30: countUnder30,
                    between30and40: count30to40,
                    between41and50: count41to50,
                    between51and60: count51to60,
                    above60: countAbove60,
                  };

                  console.log("Age category counts:", ageCategoryCounts);
                  console.log("Breast Cancer:", breastCancer);
                  console.log("Throat Cancer:", throatCancer);
                  console.log("Liver Cancer:", liverCancer);
                  console.log("Lung Cancer:", lungCancer);
                  console.log("Biopsy:", biopsy);
                  console.log("Resection:", resection);
                  console.log("Blood Samples (BS):", countBS);
                  console.log("Stool Samples (SS):", countSS);
                  console.log("Other Samples (OS):", countOS);
                  console.log("combined (co):", countCombined);

                  ageChart(countUnder30, count30to40, count41to50, count51to60, countAbove60);
                  cancerChart(breastCancer, throatCancer, liverCancer, lungCancer);
                  procedureChart(biopsy, resection);
                  sampleTypeChart(countBS, countSS, countOS, countRLT, countPC, countCombined);
                  hideLoadingModal();
                } else {
                  alert("Please select From and To Date");
                }
              } else {
                console.log("No seat data available.");
                document.getElementById("samples").innerHTML = 0;
                ageChart(0, 0, 0, 0, 0);
                cancerChart(0, 0, 0, 0);
                procedureChart(0, 0);
                sampleTypeChart(0, 0, 0, 0, 0, 0);
                hideLoadingModal();
              }
            })
            .catch((error) => {
              console.error("Error fetching seat data from Firebase:", error);
            });
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        fetchPendingEntries();
        fetchPendingFollowUps();
        updateTodoBadge("todoBadge");
      });

      function getTimestamp(dateString, isEndOfDay = false) {
        let [day, month, year] = dateString.split("/").map(Number);
        let date = new Date(year, month - 1, day);
        if (isEndOfDay) {
          date.setHours(23, 59, 59, 999); // End of the day
        } else {
          date.setHours(0, 0, 0, 0); // Start of the day
        }
        return date.getTime();
      }
    </script>
  </body>
</html>
