<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bio Bank</title>
  <!--Google Fonts and Icons-->
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone"
    rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="index.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .radio-btn {
      text-decoration: none;
      padding: 10px 20px;
      border: 2px solid #ccc;
      border-radius: 5px;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .radio-btn.active {
      background-color: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .radio-btn:hover {
      background-color: #0056b3;
      color: #fff;
    }
  </style>

  <script src="index.js"></script>
</head>

<body>
  <nav class="navbar sticky-top navbar-expand-lg navbar-light" style="background-color: #1991c994">
    <div class="container-fluid">
      <div class="mx-auto">
       <ul class="nav nav-pills nav-fill">
          <li class="nav-item">
            <a class="nav-link " href="statistics.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="home.html">Sample</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="search.html">Search</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">To-Do list</a>
          </li>

        </ul>
      </div>
      <div class="d-flex ms-auto">
        <button onclick="logout()" id="logout" type="submit" class="btn btn-outline-light">
          Logout
        </button>
      </div>
    </div>
  </nav>
  <div class="wrapper">
    <div class="container" style="margin-top: 20px">
      <div class="row" style="justify-content: space-around; margin-bottom: 10px">
        <div>
          <a href="#PendingEntry" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false"
            aria-controls="PendingEntry" id="PendingEntryBtn">
            Pending Entries
          </a>
        </div>
        <div>
          <a href="#pendingForms" class="radio-btn" data-toggle="collapse" role="button" aria-expanded="false"
            aria-controls="pendingForms" id="pendingFormSearchBtn">
            Pending Follow-Ups
          </a>
        </div>
      </div>
      <div class="collapse" id="PendingEntry">
        <div class="card card-body">
          <div class="container my-4">
            <div id="patientList" class="row">
              <table id="patientTable" class="table table-striped table-bordered">
                <thead style="position: sticky">
                  <tr>
                    <th scope="col">S.No</th>
                    <th scope="col">Bio Bank ID</th>
                    <th scope="col">Age</th>
                    <th scope="col">Gender</th>
                    <!-- <th scope="col">Box</th>
                    <th scope="col">Grid</th> -->
                    <th scope="col">Type of Cancer</th>
                    <!-- <th scope="col">Stage of Cancer</th> -->
                    <th scope="col">Grade of Cancer</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody class="patientTableBody1" style="scroll-behavior: smooth">
                  <tr class="patientRow">
                    <th scope="row" class="sno"></th>
                    <td class="patientName"></td>
                    <td class="age"></td>
                    <td class="gender"></td>
                    <!-- <td class="box"></td>
                    <td class="grid"></td> -->
                    <td class="cancerType"></td>
                    <!-- <td class="stage"></td> -->
                    <td class="grade"></td>
                    <td class="action"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="collapse" id="pendingForms">
        <div class="card card-body">
          <div class="container my-4">
            <div id="patientList2" class="row"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="container my-4" id="demo" style="display: block">
      <div id="patientList" class="row"></div>
    </div>
  </div>

  <footer id="footer">
    <div class="container footer-bottom clearfix">
      <div class="copyright">
        &copy; Copyright <strong><span></span></strong>. All Rights Reserved
      </div>
      <div class="credits"></div>
      <div class="version" style="float: right; font-size: 12px; color: rgb(255, 255, 255)">
        Version 1.3.0
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    if (!sessionStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = "login.html";
    }
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);
    document.getElementById("logout").addEventListener("click", logout);

    function logout() {
      sessionStorage.removeItem('isLoggedIn');
      sessionStorage.removeItem('userName');
      window.location.href = 'login.html';
    }
    $(document).ready(function () {
      document
        .getElementById("PendingEntryBtn")
        .addEventListener("click", function (event) {
          document.getElementById("demo").style.display = "none";
        });

      document
        .getElementById("pendingFormSearchBtn")
        .addEventListener("click", function (event) {
          document.getElementById("demo").style.display = "none";
        });
    });

    document
      .getElementById("PendingEntryBtn")
      .addEventListener("click", function () {
        const pendingFormSearch = document.getElementById("pendingForms");
        const PendingEntrySearch = document.getElementById("PendingEntry");
        PendingEntryBtn.classList.add("active");

        if (pendingFormSearch.classList.contains("show")) {
          pendingFormSearch.classList.remove("show");
          pendingFormSearchBtn.classList.remove("active");
        }
      });

    document
      .getElementById("pendingFormSearchBtn")
      .addEventListener("click", function () {
        const PendingEntrySearch = document.getElementById("PendingEntry");
        const pendingFormSearch = document.getElementById("pendingForms");
        pendingFormSearchBtn.classList.add("active");

        if (PendingEntrySearch.classList.contains("show")) {
          PendingEntrySearch.classList.remove("show");
          PendingEntryBtn.classList.remove("active");
        }
      });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // const sevenDaysInMillis = 7 * 24 * 60 * 60  ;
      const sevenDaysInMillis = 10 * 60;

      const currentTime = Date.now() / 1000;

      db.ref("sef").once("value", (snapshot) => {
        const allData = snapshot.val();
        window.patientData = allData;
        const tableData = [];

        if (allData) {
          Object.keys(allData).forEach((bioBankId) => {
            const sections = allData[bioBankId];
            console.log("sections", sections)

            Object.keys(sections).forEach((sectionKey) => {
              const section = sections[sectionKey];
              const timestamps = Object.keys(section);

              let timestamp = timestamps[0];
              let newtimestamp = timestamps[timestamps.length - 1];
              console.log("dataEntry", section)
              console.log("timestamp", newtimestamp)


              const dataEntry = section[newtimestamp];
              console.log("timestamps", timestamps)

              console.log("1st timestamp", timestamp)
              const patient = dataEntry.ie || {};

              const fields = ['bpg', 'bsg', 'bbcg', 'ftg', 'fng'];

              let boxName = '';
              let seatList = [];

              fields.forEach((field) => {
                const fieldData = patient[field];
                if (fieldData) {
                  const parts = fieldData.split('/');  // Assuming the box name and seat list are separated by "/"
                  boxName = parts[0].trim();
                  seatList = parts[1] ? parts[1].split(',') : []; // Split the seats into an array
                }
                console.log("seatList", fieldData)
              });

              const seatListDisplay = seatList.length ? seatList.join(', ') : '-';

              console.log("time" + (currentTime - timestamp));

              if (
                dataEntry &&
                dataEntry.md.pst === "" &&
                currentTime - timestamp > sevenDaysInMillis
              ) {
                // Add to table data, include seq (sectionKey) in the entry
                tableData.push({
                  bioBankId: bioBankId,
                  seq: sectionKey, // Assign the seq number (sectionKey) here
                  age: dataEntry.ie.ag || "-",
                  gender: dataEntry.ie.sx || "-",
                  // box: boxName || "-",
                  // grid: seatListDisplay || "-",
                  cancerType: dataEntry.ie.ct === "brst" ? "Breast Cancer" : "-",
                  // stage: dataEntry.ie.stc || "-",
                  grade: dataEntry.md.gd || "-",
                  newtimestamp: newtimestamp, // Store the timestampKey to pass it in the view and edit actions
                });
              }
              // });
              console.log("tableData", tableData)


            });
          });
        }

        populateTable(tableData);
      });
    });

    function populateTable(data) {
      console.log("data", data)
      const tableBody = document.querySelector(".patientTableBody1");
      tableBody.innerHTML = "";

      data.forEach((entry, index) => {
        const row = document.createElement("tr");
        row.classList.add("patientRow");
        console.log("seq", entry.seq);

        const snoCell = document.createElement("th");
        snoCell.scope = "row";
        snoCell.className = "sno";
        snoCell.textContent = index + 1;
        row.appendChild(snoCell);

        const bioBankIdCell = document.createElement("td");
        bioBankIdCell.className = "patientName";
        bioBankIdCell.textContent = entry.bioBankId;
        row.appendChild(bioBankIdCell);

        const ageCell = document.createElement("td");
        ageCell.className = "age";
        ageCell.textContent = entry.age;
        row.appendChild(ageCell);

        const genderCell = document.createElement("td");
        genderCell.className = "gender";
        genderCell.textContent = entry.gender;
        row.appendChild(genderCell);

        // const boxCell = document.createElement("td");
        // boxCell.className = "box";
        // boxCell.textContent = entry.box;
        // row.appendChild(boxCell);

        // const gridCell = document.createElement("td");
        // gridCell.className = "grid";
        // gridCell.textContent = entry.grid;
        // row.appendChild(gridCell);

        const cancerTypeCell = document.createElement("td");
        cancerTypeCell.className = "cancerType";
        cancerTypeCell.textContent = entry.cancerType;
        row.appendChild(cancerTypeCell);

        // const stageCell = document.createElement("td");
        // stageCell.className = "stage";
        // stageCell.textContent = entry.stage;
        // row.appendChild(stageCell);

        const gradeCell = document.createElement("td");
        gradeCell.className = "grade";
        gradeCell.textContent = entry.grade;
        row.appendChild(gradeCell);

        const actionCell = document.createElement("td");
        actionCell.className = "action";

        const editBtn = document.createElement("button");
        editBtn.classList.add("btn", "btn-primary", "btn-sm", "mr-2");
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          console.log(`Editing patient: ${entry.bioBankId}`);
          const seq = entry.seq;
          const timestampKey = entry.newtimestamp;
          editPatient(entry.bioBankId, seq, timestampKey);
        });

        // const viewBtn = document.createElement("button");
        // viewBtn.classList.add("btn", "btn-info", "btn-sm", "mr-2");
        // viewBtn.textContent = "View";
        // viewBtn.addEventListener("click", () => {
        //   console.log(`Viewing patient: ${entry.bioBankId}`);
        //   window.location.href = "default.html";
        // });

        const viewPendingFormBtn = document.createElement("button");
        viewPendingFormBtn.classList.add(
          "btn",
          "btn-info",
          "btn-sm",
          "mr-2"
        );
        viewPendingFormBtn.textContent = "View ";
        viewPendingFormBtn.addEventListener("click", () => {
          console.log(`Viewing pending form for patient: ${entry.bioBankId}`);
          const seq = entry.seq;

          const timestampKey = entry.newtimestamp;
          console.log("seq", entry.bioBankId);

          viewPendingForm(entry.bioBankId, seq, timestampKey);
        });

        actionCell.appendChild(editBtn);
        // actionCell.appendChild(viewBtn);
        actionCell.appendChild(viewPendingFormBtn);
        row.appendChild(actionCell);
        tableBody.appendChild(row);
      });
    }
    function viewPendingForm(bioBankId, seq, timestampKey) {
      // Check if patient data exists for the given bioBankId
      if (window.patientData[bioBankId]) {
        handlePendingForm(bioBankId, seq, timestampKey);
      } else {
        console.error(`Patient data not found for bioBankId ${bioBankId}`);
        // Optionally, you could fetch the patient data here if needed
        // fetchPatientData(bioBankId)
        //   .then(() => {
        //     handlePendingForm(bioBankId, seq, timestampKey);
        //   })
        //   .catch((error) => {
        //     console.error("Error fetching patient data:", error);
        //   });
      }
    }

    function handlePendingForm(bioBankId, seq, timestampKey) {
      const patientSeq = window.patientData[bioBankId];
      if (patientSeq && patientSeq[seq] && patientSeq[seq][timestampKey]) {
        const timestampData = patientSeq[seq][timestampKey];
        let viewT = "PendingView";
        console.log("timestampKey", timestampKey);
        pages_display(viewT, bioBankId, seq, timestampKey);
      } else {
        console.error(
          `Sequence ${seq} or timestampKey ${timestampKey} not found for patient ${bioBankId}`
        );
      }
    }

    function editPatient(bioBankId, seq, timestampKey) {
      // Check if patient data exists, fetch it if not
      if (!window.patientData[bioBankId]) {
        // If the patient data is not in window.patientData, fetch it
        fetchPatientData(bioBankId)
          .then(() => {
            handleEditPatientData(bioBankId, seq, timestampKey);
          })
          .catch((error) => {
            console.error("Error fetching patient data:", error);
          });
      } else {
        handleEditPatientData(bioBankId, seq, timestampKey);
      }
    }

    function handleEditPatientData(bioBankId, seq, timestampKey) {
      const patientSeq = window.patientData[bioBankId];
      if (patientSeq && patientSeq[seq] && patientSeq[seq][timestampKey]) {
        const timestampData = patientSeq[seq][timestampKey];
        let editT = "PendingEdit";
        console.log("timestampKey", timestampKey);
        pages_display(editT, bioBankId, seq, timestampKey);
      } else {
        console.error(
          `Sequence ${seq} or timestampKey ${timestampKey} not found for patient ${bioBankId}`
        );
      }
    }
  </script>

  <script>
document.addEventListener("DOMContentLoaded", function () {
  const db = firebase.database();

  const todayTimestamp = new Date().getTime();
  console.log("todayTimestamp", todayTimestamp);

  const pfwRef = db.ref("pfw");

  pfwRef.once("value").then((snapshot) => {
    const pfwData = snapshot.val();
    const brKeys = Object.keys(pfwData)
    console.log("brKeys", brKeys);

    const allPatientData = []; // Array to hold all the patient data

    brKeys.forEach((biobankID) => {
      const timestamp = pfwData[biobankID];
      console.log("Follow-Ups timestamp", timestamp);

      const dateObj = new Date(timestamp);
      const formattedDate = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}-${dateObj.getDate().toString().padStart(2, '0')}`;
      console.log("formattedDate", formattedDate);

      if (timestamp < todayTimestamp) {
        const sefRef = db.ref(`sef/${biobankID}`);

        sefRef.once("value").then((sefSnapshot) => {
          const data = sefSnapshot.val();
          console.log("Seq data", data);
          const sectionKeys = Object.keys(data);
          console.log("sectionKeys", sectionKeys);
          const lastSection = sectionKeys[sectionKeys.length - 1];
          console.log("sectionKeys", lastSection);
          const lastSectionData = data[lastSection];
          console.log("sectionData", lastSectionData);


          

          if (data) {
            const patientArrays = Object.keys(data);

            // Iterate through each patient array
            patientArrays.forEach(patientArrayKey => {
              const patientArray = data[patientArrayKey];
              console.log("patientArray", patientArray);

              if (patientArray && typeof patientArray === 'object') {
                const timestamps = Object.keys(patientArray); // These are the actual timestamps
                console.log("timestamps", timestamps);

                // Get the latest timestamp
                const latestTimestamp = Math.max(...timestamps.map((t) => parseInt(t)));
                console.log("latestTimestamp",latestTimestamp)
                const latestData = lastSectionData[latestTimestamp];
                console.log("latestData", latestData);

                if (latestData) {
                  const { ie, md } = latestData;

                  const patientData = {
                    biobankID,
                    age: ie.ag || "-",
                    gender: ie.sx || "-",
                    type_of_cancer: ie.ct === "brst" ? "Breast Cancer" : "-",
                    stage_of_cancer: ie.stc || "-",
                    grade_of_cancer: md.gd || "-",
                    patientArrayKey,
                    latestTimestamp
                  };

                  // Push this patient data to the array
                  allPatientData.push(patientData);
                }
              }
            });
          }
        });
      }
    });

    // After all data has been collected, populate the table
    pfwRef.once("value").then(() => {
      const patientList2 = document.getElementById("patientList2");
      patientList2.innerHTML = "";

      const table = document.createElement("table");
      table.classList.add("table", "table-striped", "table-bordered");

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th scope="col">S.No</th>
          <th scope="col">Bio Bank ID</th>
          <th scope="col">Age</th>
          <th scope="col">Gender</th>
          <th scope="col">Type of Cancer</th>
          <th scope="col">Grade of Cancer</th>
          <th scope="col">Action</th>
        </tr>
      `;

      const tbody = document.createElement("tbody");

      if (allPatientData.length > 0) {
        allPatientData.forEach((patient, index) => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <th scope="row">${index + 1}</th> 
            <td>${patient.biobankID || "-"}</td>
            <td>${patient.age}</td>
            <td>${patient.gender}</td>
            <td>${patient.type_of_cancer}</td>
            <td>${patient.grade_of_cancer}</td>
          `;

          // Create buttons for action
          const modCell = document.createElement("td");
          const entryBtn = document.createElement("button");
          entryBtn.classList.add("btn", "btn-primary", "btn-sm", "mr-2");
          entryBtn.textContent = "Entry";
          entryBtn.addEventListener("click", () => {
            console.log(`Entrying patient: ${patient.biobankID}`);
            const entry = "EditFollowUps";
            pages_display(entry, patient.biobankID, patient.patientArrayKey, patient.latestTimestamp);
            window.location.href = `default.html?mode=edit`;
          });

          const viewBtn = document.createElement("button");
          viewBtn.classList.add("btn", "btn-info", "btn-sm");
          viewBtn.textContent = "View";
          viewBtn.addEventListener("click", () => {
            const entry = "ViewFollowUp";
            pages_display(entry, patient.biobankID, patient.patientArrayKey, patient.latestTimestamp);
            window.location.href = `default.html?mode=view`;
          });

          modCell.appendChild(entryBtn);
          modCell.appendChild(viewBtn);
          row.appendChild(modCell);
          tbody.appendChild(row);
        });
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      patientList2.appendChild(table);
    });
  });
});

  </script>
</body>

</html>
